<!DOCTYPE html>

<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CFD Pro">
<meta name="theme-color" content="#07090f">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon192.png">
<title>CFD Analyzer Pro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800;900&display=swap');
:root{--bg:#07090f;--bg2:#0d1117;--bg3:#151b27;--bd:#1e2a3a;--t:#e1e7ef;--t2:#8b9ab5;--t3:#4a5568;--green:#00e68a;--red:#ff4757;--blue:#5b7fff;--amber:#ffbe0b;--cyan:#00d4ff;--purple:#b18cff;--radius:14px;--font:'JetBrains Mono',monospace;--heading:'Outfit',sans-serif}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{background:var(--bg)}
body{font-family:var(--font);background:var(--bg);color:var(--t);min-height:100dvh;padding:env(safe-area-inset-top,12px) 14px calc(env(safe-area-inset-bottom,12px)+20px);overflow-x:hidden;font-size:12px;line-height:1.5}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes spin{to{transform:rotate(360deg)}}

/* â•â•â• SPLASH â•â•â• */
.splash{max-width:400px;margin:16vh auto 0;text-align:center;animation:fadeUp .6s ease}
.splash .logo{font-family:var(â€“heading);font-size:28px;font-weight:900;background:linear-gradient(135deg,#e1e7ef 30%,var(â€“blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
.splash .sub{color:var(â€“t3);font-size:11px;margin-bottom:24px}
.splash .go-btn{width:100%;padding:15px;border:none;border-radius:var(â€“radius);background:linear-gradient(135deg,var(â€“blue),#8b6fff);color:#fff;font-family:var(â€“heading);font-size:15px;font-weight:700;cursor:pointer}
.splash .go-btn:active{transform:scale(.97)}
#splashStatus{margin-top:14px;font-size:11px;color:var(â€“amber);display:none}
.splash .note{color:var(â€“t3);font-size:9px;margin-top:16px;line-height:1.8}
.splash .note b{color:var(â€“green)}

/* â•â•â• DASHBOARD â•â•â• */
.dashboard{max-width:960px;margin:0 auto;display:none}
.dashboard.active{display:block;animation:fadeUp .4s ease}

/* MODE TOGGLE */
.mode-toggle{display:flex;background:var(â€“bg2);border:1px solid var(â€“bd);border-radius:12px;padding:3px;margin-bottom:14px;width:fit-content}
.mode-btn{padding:8px 20px;border-radius:10px;border:none;background:transparent;color:var(â€“t3);font-family:var(â€“heading);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.mode-btn.on{color:#fff}
.mode-btn.acoes.on{background:linear-gradient(135deg,var(â€“green),#059669)}
.mode-btn.cfds.on{background:linear-gradient(135deg,var(â€“blue),#8b6fff)}

.header{display:flex;align-items:center;justify-content:space-between;padding:6px 0 12px;flex-wrap:wrap;gap:8px}
.header-title{font-family:var(â€“heading);font-size:20px;font-weight:800}
.header-title span{font-size:12px;font-weight:400}
.status-bar{display:flex;align-items:center;gap:5px;font-size:9px;color:var(â€“t3)}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(â€“amber);animation:pulse 1.2s infinite}
.status-dot.ok{background:var(â€“green);box-shadow:0 0 6px var(â€“green);animation:none}
.status-dot.err{background:var(â€“red);animation:none}
.header-actions{display:flex;gap:5px;align-items:center;flex-wrap:wrap}
.h-btn{padding:7px 12px;border-radius:8px;border:1px solid var(â€“bd);background:var(â€“bg2);color:var(â€“t2);font-family:var(â€“font);font-size:10px;cursor:pointer;white-space:nowrap}
.h-btn:active{transform:scale(.94)}
.h-btn.active{border-color:var(â€“green);color:var(â€“green);background:rgba(0,230,138,.06)}
.h-btn.notif{border-color:var(â€“amber);color:var(â€“amber)}

/* CARDS */
.card{background:var(â€“bg2);border:1px solid var(â€“bd);border-radius:var(â€“radius);padding:14px;margin-bottom:10px}
.card-title{font-family:var(â€“heading);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(â€“t3);margin-bottom:10px}
.card-grid{display:grid;gap:7px}
.card-grid.c2{grid-template-columns:1fr 1fr}
.card-grid.c3{grid-template-columns:1fr 1fr 1fr}
.card-grid.c4{grid-template-columns:1fr 1fr 1fr 1fr}
@media(max-width:600px){.card-grid.c3,.card-grid.c4{grid-template-columns:1fr 1fr}}
.mini-card{background:var(â€“bg);border:1px solid var(â€“bd);border-radius:10px;padding:10px;text-align:center}
.mini-card .mc-label{font-size:7px;color:var(â€“t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px}
.mini-card .mc-value{font-family:var(â€“heading);font-size:16px;font-weight:700}

/* RISK PANEL */
.risk-panel{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;align-items:end}
@media(max-width:500px){.risk-panel{grid-template-columns:1fr 1fr}}
.risk-panel label{font-size:7px;color:var(â€“t3);text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:3px}
.risk-panel input,.risk-panel select{width:100%;background:var(â€“bg);border:1px solid var(â€“bd);border-radius:8px;padding:8px 10px;color:var(â€“t);font-family:var(â€“font);font-size:11px;outline:none}
.risk-panel input:focus{border-color:var(â€“blue)}
.risk-result{padding:10px;background:rgba(91,127,255,.05);border:1px solid rgba(91,127,255,.12);border-radius:10px;margin-top:8px;font-size:10px;display:flex;gap:12px;flex-wrap:wrap}
.risk-result b{color:var(â€“amber)}

/* ASSETS */
.cat-label{font-size:8px;color:var(â€“t3);text-transform:uppercase;letter-spacing:.12em;margin:10px 0 5px}
.asset-grid{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:3px}
.asset-btn{padding:6px 11px;border-radius:8px;border:1px solid var(â€“bd);background:var(â€“bg2);color:var(â€“t2);font-family:var(â€“font);font-size:10px;cursor:pointer}
.asset-btn:active{transform:scale(.93)}
.asset-btn.selected{border-color:var(â€“blue);background:rgba(91,127,255,.08);color:var(â€“t)}
.add-btn{padding:8px 16px;border-radius:9px;border:1px dashed var(â€“bd);background:transparent;color:var(â€“blue);font-family:var(â€“heading);font-size:10px;font-weight:600;cursor:pointer;margin:8px 0}

/* PRICE */
.price-card{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.price-main .symbol-name{font-size:10px;color:var(â€“t3)}
.price-main .price{font-family:var(â€“heading);font-size:30px;font-weight:800}
.price-main .change{font-size:12px;font-weight:600}
.metrics{display:flex;gap:14px;flex-wrap:wrap}
.metric{text-align:center}
.metric-label{font-size:7px;color:var(â€“t3);text-transform:uppercase;letter-spacing:.08em}
.metric-value{font-size:14px;font-weight:600}

/* RECOMMENDATION */
.rec-badge{padding:7px 16px;border-radius:10px;text-align:center;border:1px solid var(â€“bd);background:var(â€“bg2)}
.rec-label{font-size:7px;color:var(â€“t3);text-transform:uppercase;letter-spacing:.12em}
.rec-value{font-family:var(â€“heading);font-size:15px;font-weight:700}

/* ACTION */
.action-text{font-size:11px;color:var(â€“t2);line-height:1.8}
.action-text strong{color:var(â€“t)}
.tf-row{display:flex;gap:6px;margin:8px 0;align-items:center;flex-wrap:wrap}
.tf-badge{padding:4px 10px;border-radius:6px;font-size:9px;font-weight:600;border:1px solid var(â€“bd)}
.tf-label-text{font-size:8px;color:var(â€“t3)}
.risk-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.risk-pill{padding:7px 14px;border-radius:10px;border:1px solid var(â€“bd);background:var(â€“bg);text-align:center;flex:1;min-width:70px}
.risk-pill .rp-label{font-size:7px;color:var(â€“t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px}
.risk-pill .rp-value{font-size:14px;font-weight:700}

/* TABS & TOGGLES */
.toggle-row{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
.toggle-btn{padding:5px 12px;border-radius:6px;border:1px solid var(â€“bd);background:transparent;color:var(â€“t3);font-family:var(â€“font);font-size:9px;cursor:pointer}
.toggle-btn.on{border-color:var(â€“blue);background:rgba(91,127,255,.08);color:var(â€“purple)}
.tabs{display:flex;gap:2px;background:var(â€“bg2);border-radius:10px;padding:3px;width:fit-content;margin-bottom:12px;flex-wrap:wrap}
.tab-btn{padding:6px 14px;border-radius:8px;border:none;background:transparent;color:var(â€“t3);font-family:var(â€“font);font-size:10px;cursor:pointer;font-weight:500}
.tab-btn.on{background:rgba(91,127,255,.1);color:var(â€“purple)}

/* CHART */
.chart-box{background:var(â€“bg2);border:1px solid var(â€“bd);border-radius:var(â€“radius);padding:12px;margin-bottom:10px}
.chart-label{font-size:7px;color:var(â€“t3);padding-left:4px;margin-bottom:5px;text-transform:uppercase;letter-spacing:.12em}
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:600px){.chart-grid{grid-template-columns:1fr}}
svg{width:100%;height:auto;display:block}

/* SIGNALS */
.signal-card{background:var(â€“bg2);border:1px solid var(â€“bd);border-radius:10px;padding:10px 12px;margin-bottom:7px}
.signal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.signal-type{padding:2px 8px;border-radius:5px;font-size:9px;font-weight:700}
.signal-dots{display:flex;gap:2px}
.signal-dot{width:5px;height:5px;border-radius:50%}
.signal-reasons{font-size:8px;color:var(â€“t3);margin-top:4px}

/* LEVELS */
.levels-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:600px){.levels-grid{grid-template-columns:1fr}}
.level-box{background:var(â€“bg2);border:1px solid var(â€“bd);border-radius:var(â€“radius);padding:14px}
.level-title{font-size:7px;color:var(â€“t3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:10px}
.level-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(30,42,58,.4);font-size:10px}

/* POSITIONS */
.pos-box{background:linear-gradient(135deg,rgba(91,127,255,.04),rgba(177,140,255,.04));border:1px solid rgba(91,127,255,.15);border-radius:var(â€“radius);padding:16px}
.pos-box h3{font-family:var(â€“heading);font-size:13px;font-weight:700;margin-bottom:12px}
.pos-card{background:var(â€“bg);border:1px solid var(â€“bd);border-radius:12px;padding:12px;margin-bottom:8px}
.pos-pnl{font-family:var(â€“heading);font-size:17px;font-weight:700}
.pos-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:10px}
.pos-form-grid label{font-size:7px;color:var(â€“t3);text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:3px}
.pos-form-grid input,.pos-form-grid select{width:100%;background:var(â€“bg);border:1px solid var(â€“bd);border-radius:8px;padding:8px 10px;color:var(â€“t);font-family:var(â€“font);font-size:10px;outline:none}
.pos-btn{padding:9px 16px;border-radius:9px;border:none;font-family:var(â€“heading);font-size:11px;font-weight:600;cursor:pointer}

/* BACKTEST */
.bt-bar{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.bt-bar select,.bt-bar input{background:var(â€“bg);border:1px solid var(â€“bd);border-radius:8px;padding:7px 10px;color:var(â€“t);font-family:var(â€“font);font-size:10px;outline:none}
.bt-btn{padding:8px 18px;border:none;border-radius:9px;background:linear-gradient(135deg,var(â€“purple),var(â€“blue));color:#fff;font-family:var(â€“heading);font-size:11px;font-weight:600;cursor:pointer}
.bt-btn:disabled{opacity:.5}
.bt-result{margin-top:10px}
.bt-valid{padding:10px;border-radius:10px;text-align:center;font-family:var(â€“heading);font-size:13px;font-weight:700;margin-bottom:10px}
.bt-trades{max-height:250px;overflow-y:auto}
.bt-trade{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(30,42,58,.3);font-size:9px}

/* TOAST */
.toast{position:fixed;top:env(safe-area-inset-top,10px);left:50%;transform:translateX(-50%) translateY(-120px);background:var(â€“bg3);border:1px solid var(â€“bd);border-radius:14px;padding:12px 18px;z-index:200;transition:transform .4s cubic-bezier(.175,.885,.32,1.275);max-width:90vw;box-shadow:0 8px 32px rgba(0,0,0,.6)}
.toast.show{transform:translateX(-50%) translateY(12px)}
.toast-title{font-family:var(â€“heading);font-size:13px;font-weight:600;margin-bottom:2px}
.toast-body{font-size:9px;color:var(â€“t2)}

/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:100;display:none;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:var(â€“bg3);border:1px solid var(â€“bd);border-radius:18px;padding:22px;width:min(460px,92vw);max-height:78vh;overflow-y:auto}
.modal h2{font-family:var(â€“heading);font-size:18px;font-weight:700;margin-bottom:14px}
.modal .close-btn{float:right;background:none;border:none;color:var(â€“t3);font-size:20px;cursor:pointer}
.modal .preset-grid{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.modal input,.modal select{width:100%;background:var(â€“bg);border:1px solid var(â€“bd);border-radius:8px;padding:9px 12px;color:var(â€“t);font-family:var(â€“font);font-size:11px;outline:none;margin-bottom:7px}
.disclaimer{margin-top:18px;padding:10px 12px;background:rgba(255,190,11,.03);border:1px solid rgba(255,190,11,.1);border-radius:10px;font-size:8px;color:#8a7a3e;line-height:1.7}
.warn-box{padding:10px;border-radius:10px;background:rgba(255,71,87,.05);border:1px solid rgba(255,71,87,.15);font-size:10px;color:var(â€“red);margin:8px 0;line-height:1.6}
</style>

</head>
<body>
<div class="toast" id="toast"><div class="toast-title" id="toastTitle"></div><div class="toast-body" id="toastBody"></div></div>

<!-- SPLASH -->

<div class="splash" id="splashScreen">
  <div class="logo">ğŸ“Š CFD Analyzer Pro</div>
  <div class="sub">AÃ§Ãµes Â· CFDs Â· Backtesting Â· GestÃ£o de Risco</div>
  <button class="go-btn" onclick="startApp()">Entrar â€” Sem API Key</button>
  <div id="splashStatus"></div>
  <div class="note"><b>âœ“ Sem registo</b> Â· <b>âœ“ 100% grÃ¡tis</b> Â· Dados Yahoo Finance<br>AÃ§Ãµes, Crypto, Forex, Commodities Â· Backtesting atÃ© 5 anos</div>
</div>

<!-- MODAL -->

<div class="modal-bg" id="modal"><div class="modal"><button class="close-btn" onclick="closeModal()">Ã—</button><h2>Adicionar Ativo</h2><div id="presetList"></div>
<div style="margin-top:12px;border-top:1px solid var(--bd);padding-top:12px"><div style="font-size:8px;color:var(--t3);margin-bottom:6px;text-transform:uppercase">Personalizado (Yahoo symbol)</div>
<div style="display:flex;gap:6px;margin-bottom:6px"><input id="customSym" placeholder="Ex: AAPL, BTC-USD"><input id="customName" placeholder="Nome"></div>
<select id="customCat"><option value="AÃ§Ãµes">AÃ§Ãµes</option><option value="Commodities">Commodities</option><option value="Forex">Forex</option><option value="Crypto">Crypto</option></select>
<button onclick="addCustom()" style="width:100%;padding:10px;border:none;border-radius:9px;background:linear-gradient(135deg,var(--blue),#8b6fff);color:#fff;font-family:var(--heading);font-size:11px;font-weight:600;cursor:pointer">Adicionar</button></div></div></div>

<!-- DASHBOARD -->

<div class="dashboard" id="dashboard">

<!-- MODE TOGGLE -->

<div class="mode-toggle" id="modeToggle">
  <button class="mode-btn acoes on" onclick="setMode('acoes')">ğŸ“ˆ AÃ§Ãµes (Spot)</button>
  <button class="mode-btn cfds" onclick="setMode('cfds')">âš¡ CFDs (Alavancado)</button>
</div>

<div class="header">
  <div><div class="header-title" id="headerTitle">CFD Analyzer <span>Pro</span></div><div class="status-bar" id="statusBar"><span class="status-dot"></span> A conectar...</div></div>
  <div class="header-actions">
    <button class="h-btn" onclick="refresh()">â†»</button>
    <button class="h-btn" id="autoBtn" onclick="toggleAuto()">â–¶ Auto</button>
    <button class="h-btn" id="notifBtn" onclick="toggleNotif()">ğŸ””</button>
    <button class="h-btn" onclick="exportCSV()">ğŸ“¥ CSV</button>
  </div>
</div>

<!-- RISK MANAGEMENT -->

<div class="card" id="riskCard">
  <div class="card-title">ğŸ›¡ï¸ GestÃ£o de Risco</div>
  <div class="risk-panel">
    <div><label>Capital (â‚¬)</label><input id="inpCapital" type="number" value="10000" step="100" onchange="calcRisk()"></div>
    <div><label>Risco/Trade (%)</label><input id="inpRiskPct" type="number" value="1" min="0.5" max="5" step="0.5" onchange="calcRisk()"></div>
    <div><label>Alavancagem</label><input id="inpLev" type="number" value="1" min="1" max="30" step="1" onchange="calcRisk()" disabled></div>
  </div>
  <div class="risk-result" id="riskResult">Risco: <b>â‚¬100</b> por trade</div>
  <div style="display:flex;gap:7px;margin-top:8px;flex-wrap:wrap">
    <div style="flex:1;min-width:120px"><label style="font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:3px">Max PosiÃ§Ãµes</label><input id="inpMaxPos" type="number" value="3" min="1" max="10" style="width:100%;background:var(--bg);border:1px solid var(--bd);border-radius:8px;padding:8px 10px;color:var(--t);font-family:var(--font);font-size:11px" onchange="MAX_POS=parseInt(this.value)||3"></div>
    <div style="flex:1;min-width:120px"><label style="font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:3px">Perda DiÃ¡ria Max (%)</label><input id="inpDailyLoss" type="number" value="5" min="1" max="20" style="width:100%;background:var(--bg);border:1px solid var(--bd);border-radius:8px;padding:8px 10px;color:var(--t);font-family:var(--font);font-size:11px" onchange="dailyLossLimit=parseFloat(this.value)||5"></div>
  </div>
</div>

<!-- MARKET STATUS + NEWS -->

<div class="card" id="marketCard">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
    <div><div class="card-title" style="margin-bottom:0">ğŸ• Mercado</div><div id="marketStatus" style="font-size:10px;margin-top:4px"></div></div>
    <div id="newsPanel" style="text-align:right"></div>
  </div>
  <div id="dailyLimitBar" style="display:none"></div>
  <div id="corrWarning" style="display:none"></div>
</div>

<!-- ASSETS -->

<div id="assetGrid"></div>
<button class="add-btn" onclick="openModal()">+ Adicionar Ativo</button>

<!-- PRICE -->

<div class="card">
  <div class="price-card">
    <div class="price-main"><div class="symbol-name" id="symbolName">â€”</div><div class="price" id="priceDisplay">â€”</div><div class="change" id="changeDisplay">â€”</div></div>
    <div class="metrics">
      <div class="metric"><div class="metric-label">RSI</div><div class="metric-value" id="mRSI">â€”</div></div>
      <div class="metric"><div class="metric-label">ADX</div><div class="metric-value" id="mADX">â€”</div></div>
      <div class="metric"><div class="metric-label">ATR</div><div class="metric-value" id="mATR">â€”</div></div>
      <div class="metric"><div class="metric-label">R:R</div><div class="metric-value" id="mRR">â€”</div></div>
    </div>
  </div>
</div>

<!-- SIGNAL CARD -->

<div class="card" id="signalCard">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
    <div>
      <div class="rec-label" id="modeLabel">MODO AÃ‡Ã•ES</div>
      <div class="rec-value" id="recValue" style="font-size:20px">â€”</div>
    </div>
    <div style="text-align:right">
      <div class="rec-label">Score / TendÃªncia</div>
      <div id="scoreDisp" style="font-size:13px;font-weight:600">â€”</div>
    </div>
  </div>
  <div class="tf-row" id="tfRow"></div>
  <div class="action-text" id="actionText">A carregar...</div>
  <div id="warnBox"></div>
  <div class="risk-row" id="riskRow"></div>
  <div id="posCalc" style="margin-top:10px"></div>
</div>

<!-- POSITIONS -->

<div id="posSection"></div>

<!-- OVERLAYS -->

<div class="toggle-row">
  <button class="toggle-btn on" id="toggleSMA" onclick="togOv('sma')">SMA 20/50</button>
  <button class="toggle-btn on" id="toggleBoll" onclick="togOv('boll')">Bollinger</button>
  <button class="toggle-btn" id="toggleFib" onclick="togOv('fib')">Fibonacci</button>
</div>

<!-- TABS -->

<div class="tabs">
  <button class="tab-btn on" onclick="swTab('chart',this)">GrÃ¡fico</button>
  <button class="tab-btn" onclick="swTab('signals',this)">Sinais</button>
  <button class="tab-btn" onclick="swTab('levels',this)">NÃ­veis</button>
  <button class="tab-btn" onclick="swTab('backtest',this)">Backtest</button>
  <button class="tab-btn" onclick="swTab('stats',this)">EstatÃ­sticas</button>
</div>

<div id="tabChart">
  <div class="chart-box"><div class="chart-label">PreÃ§o Â· Velas DiÃ¡rias</div><div id="chartMain"></div></div>
  <div class="chart-grid"><div class="chart-box"><div class="chart-label">RSI (14)</div><div id="chartRSI"></div></div><div class="chart-box"><div class="chart-label">MACD (12,26,9)</div><div id="chartMACD"></div></div></div>
</div>
<div id="tabSignals" style="display:none"></div>
<div id="tabLevels" style="display:none"></div>
<div id="tabBacktest" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ”¬ Backtesting</div>
    <div class="bt-bar">
      <select id="btYears"><option value="2">2 anos</option><option value="3">3 anos</option><option value="5" selected>5 anos</option></select>
      <span style="font-size:9px;color:var(--t3)" id="btModeLabel">Modo: AÃ§Ãµes</span>
      <button class="bt-btn" id="btBtn" onclick="runBacktest()">â–¶ Executar</button>
    </div>
    <div id="btResults"></div>
  </div>
</div>
<div id="tabStats" style="display:none"></div>
<div class="disclaimer">âš ï¸ <strong>Aviso:</strong> AnÃ¡lise tÃ©cnica automatizada. NÃ£o garante resultados. CFDs envolvem risco significativo. Consulte um profissional.</div>
</div>

<script>
/* Global error handler - shows errors on screen */
window.onerror=function(msg,url,line){
  var st=document.getElementById('splashStatus');
  if(st){st.style.display='block';st.style.color='var(--red)';st.textContent='Erro JS: '+msg+' (linha '+line+')';}
  console.error('CFD Error:',msg,url,line);
};

/* Force service worker update */
if('serviceWorker' in navigator){
  navigator.serviceWorker.getRegistrations().then(function(regs){
    regs.forEach(function(r){r.update()});
  });
  navigator.serviceWorker.register('sw.js').catch(function(){});
}
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var MODE='acoes'; // 'acoes' | 'cfds'
var sel='AAPL',showS=true,showB=true,showF=false,autoR=false,autoI=null,notif=false,prevSig={};
var curP=0,curDP=2;
var capital=10000,riskPct=1,leverage=1;
var positions=[],tradeHist=[],lastAnalysis=null;
var MAX_POS=3,dailyLossLimit=5,dailyPnL=0,dailyDate='';
var newsAlertActive=false;

// XTB typical spreads (in price units) per symbol
var XTB_SPREADS={
  'AAPL':0.08,'MSFT':0.10,'GOOGL':0.30,'TSLA':0.15,'NVDA':0.12,'AMZN':0.20,'META':0.18,'AMD':0.06,'NFLX':0.40,'JPM':0.08,'V':0.10,
  'GC=F':0.40,'SI=F':0.03,'BZ=F':0.04,
  'EURUSD=X':0.00012,'GBPUSD=X':0.00015,'USDJPY=X':0.015,
  'BTC-USD':35,'ETH-USD':2.5,'SOL-USD':0.15
};
var XTB_LEV={'AÃ§Ãµes':5,'Commodities':10,'Forex':30,'Crypto':2}; // XTB default leverages

// Correlation groups â€” correlated assets
var CORR_GROUPS=[
  {name:'US Tech',syms:['AAPL','MSFT','GOOGL','NVDA','META','AMD','AMZN','NFLX']},
  {name:'Financials',syms:['JPM','V']},
  {name:'Crypto',syms:['BTC-USD','ETH-USD','SOL-USD']},
  {name:'USD Pairs',syms:['EURUSD=X','GBPUSD=X','USDJPY=X']},
  {name:'Commodities',syms:['GC=F','SI=F','BZ=F']}
];

// Market hours (UTC)
function getMarketStatus(sym){
  var now=new Date(),utcH=now.getUTCHours(),utcM=now.getUTCMinutes(),day=now.getUTCDay();
  // Crypto 24/7
  if(sym.indexOf('-USD')>=0||sym.indexOf('BTC')>=0||sym.indexOf('ETH')>=0||sym.indexOf('SOL')>=0)
    return{open:true,label:'24/7',cls:'ok'};
  // Forex: Sun 22:00 - Fri 22:00 UTC
  if(sym.indexOf('=X')>=0){
    if(day===0&&utcH<22)return{open:false,label:'Abre Dom 22h UTC',cls:'err'};
    if(day===5&&utcH>=22)return{open:false,label:'Fechado (weekend)',cls:'err'};
    if(day===6)return{open:false,label:'Fechado (weekend)',cls:'err'};
    return{open:true,label:'Forex aberto',cls:'ok'};
  }
  // Commodities: similar to futures
  if(sym.indexOf('=F')>=0){
    if(day===0||day===6)return{open:false,label:'Fechado (weekend)',cls:'err'};
    if(utcH>=14&&utcH<21)return{open:true,label:'Aberto',cls:'ok'};
    return{open:false,label:'Fora horÃ¡rio (14-21 UTC)',cls:'warn'};
  }
  // US Stocks: Mon-Fri 14:30-21:00 UTC
  if(day===0||day===6)return{open:false,label:'Fechado (weekend)',cls:'err'};
  var mins=utcH*60+utcM;
  if(mins>=870&&mins<1260)return{open:true,label:'NYSE aberto',cls:'ok'}; // 14:30-21:00
  if(mins>=840&&mins<870)return{open:false,label:'PrÃ©-market (abre 14:30 UTC)',cls:'warn'};
  return{open:false,label:'Fechado (abre 14:30 UTC)',cls:'err'};
}

// Upcoming macro events (hardcoded recurring + known 2025-2026 dates)
var MACRO_EVENTS=[
  {name:'FOMC',dates:['2026-01-28','2026-03-18','2026-05-06','2026-06-17','2026-07-29','2026-09-16','2026-11-04','2026-12-16'],impact:3},
  {name:'NFP (Emprego EUA)',recur:'first_friday',impact:3},
  {name:'CPI EUA',dates:['2026-01-14','2026-02-12','2026-03-12','2026-04-10','2026-05-13','2026-06-10','2026-07-15','2026-08-12','2026-09-10','2026-10-14','2026-11-12','2026-12-10'],impact:3},
  {name:'BCE DecisÃ£o Taxas',dates:['2026-01-22','2026-03-05','2026-04-16','2026-06-04','2026-07-16','2026-09-10','2026-10-22','2026-12-10'],impact:2},
  {name:'PIB EUA',dates:['2026-01-30','2026-03-26','2026-04-30','2026-06-25','2026-07-30','2026-09-24','2026-10-29','2026-12-23'],impact:2}
];
function getUpcomingEvents(){
  var today=new Date(),todayStr=today.toISOString().split('T')[0];
  var tomorrow=new Date(today);tomorrow.setDate(tomorrow.getDate()+1);var tomStr=tomorrow.toISOString().split('T')[0];
  var dow=today.getUTCDay(),dom=today.getUTCDate();
  var events=[];
  MACRO_EVENTS.forEach(function(ev){
    if(ev.recur==='first_friday'){
      // NFP: first friday of month
      if(dow===5&&dom<=7){events.push({name:ev.name,date:todayStr,impact:ev.impact,when:'HOJE'})}
      // Check if tomorrow is first friday
      var tomDow=tomorrow.getUTCDay(),tomDom=tomorrow.getUTCDate();
      if(tomDow===5&&tomDom<=7){events.push({name:ev.name,date:tomStr,impact:ev.impact,when:'AMANHÃƒ'})}
    }
    if(ev.dates){
      ev.dates.forEach(function(d){
        if(d===todayStr)events.push({name:ev.name,date:d,impact:ev.impact,when:'HOJE'});
        if(d===tomStr)events.push({name:ev.name,date:d,impact:ev.impact,when:'AMANHÃƒ'});
      });
    }
  });
  return events;
}

// Correlation check
function checkCorrelation(newSym){
  var openSyms=positions.filter(function(p){return!p.closed}).map(function(p){return p.symbol});
  if(!openSyms.length)return null;
  var warnings=[];
  CORR_GROUPS.forEach(function(g){
    if(g.syms.indexOf(newSym)<0)return;
    var correlated=openSyms.filter(function(s){return g.syms.indexOf(s)>=0&&s!==newSym});
    if(correlated.length>0)warnings.push('âš ï¸ CorrelaÃ§Ã£o '+g.name+': jÃ¡ tens '+correlated.join(', ')+' aberto â€” exposiÃ§Ã£o duplicada');
  });
  return warnings.length?warnings:null;
}

// Daily loss tracking
function updateDailyPnL(){
  var today=new Date().toISOString().split('T')[0];
  if(today!==dailyDate){dailyDate=today;dailyPnL=0}
  var todayTrades=tradeHist.filter(function(t){return t.exitDate===today});
  dailyPnL=todayTrades.reduce(function(s,t){return s+t.pnl},0);
}
function isDailyLimitHit(){
  updateDailyPnL();
  var limitEur=capital*(dailyLossLimit/100);
  return dailyPnL<=-limitEur;
}

var assets={"AÃ§Ãµes":[{s:"AAPL",n:"Apple",e:"ğŸ"},{s:"MSFT",n:"Microsoft",e:"ğŸªŸ"},{s:"GOOGL",n:"Alphabet",e:"ğŸ”"},{s:"TSLA",n:"Tesla",e:"âš¡"},{s:"NVDA",n:"Nvidia",e:"ğŸŸ¢"},{s:"AMZN",n:"Amazon",e:"ğŸ“¦"}]};
var presets=[{s:"META",n:"Meta",e:"ğŸŒ",c:"AÃ§Ãµes"},{s:"AMD",n:"AMD",e:"ğŸ”´",c:"AÃ§Ãµes"},{s:"NFLX",n:"Netflix",e:"ğŸ¬",c:"AÃ§Ãµes"},{s:"JPM",n:"JP Morgan",e:"ğŸ¦",c:"AÃ§Ãµes"},{s:"V",n:"Visa",e:"ğŸ’³",c:"AÃ§Ãµes"},{s:"GC=F",n:"Ouro",e:"ğŸ¥‡",c:"Commodities"},{s:"SI=F",n:"Prata",e:"ğŸ¥ˆ",c:"Commodities"},{s:"BZ=F",n:"PetrÃ³leo",e:"ğŸ›¢ï¸",c:"Commodities"},{s:"EURUSD=X",n:"EUR/USD",e:"ğŸ’¶",c:"Forex"},{s:"GBPUSD=X",n:"GBP/USD",e:"ğŸ’·",c:"Forex"},{s:"BTC-USD",n:"Bitcoin",e:"â‚¿",c:"Crypto"},{s:"ETH-USD",n:"Ethereum",e:"âŸ ",c:"Crypto"},{s:"SOL-USD",n:"Solana",e:"â—",c:"Crypto"}];

/* persistence */
try{var _a=localStorage.getItem('v4_a');if(_a)assets=JSON.parse(_a)}catch(e){}
try{var _s=localStorage.getItem('v4_s');if(_s)sel=_s}catch(e){}
try{var _m=localStorage.getItem('v4_m');if(_m)MODE=_m}catch(e){}
try{var _c=localStorage.getItem('v4_cap');if(_c)capital=parseFloat(_c)}catch(e){}
try{var _r=localStorage.getItem('v4_rp');if(_r)riskPct=parseFloat(_r)}catch(e){}
try{var _p=localStorage.getItem('v4_pos');if(_p)positions=JSON.parse(_p)}catch(e){}
try{var _h=localStorage.getItem('v4_hist');if(_h)tradeHist=JSON.parse(_h)}catch(e){}
function saveA(){try{localStorage.setItem('v4_a',JSON.stringify(assets));localStorage.setItem('v4_s',sel);localStorage.setItem('v4_m',MODE)}catch(e){}}
function saveP(){try{localStorage.setItem('v4_pos',JSON.stringify(positions));localStorage.setItem('v4_hist',JSON.stringify(tradeHist))}catch(e){}}
function saveRisk(){try{localStorage.setItem('v4_cap',capital);localStorage.setItem('v4_rp',riskPct)}catch(e){}}
if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(function(){});

function showToast(t,b){document.getElementById('toastTitle').textContent=t;document.getElementById('toastBody').textContent=b;var e=document.getElementById('toast');e.classList.add('show');setTimeout(function(){e.classList.remove('show')},4000)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YAHOO FINANCE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var PX=[
  function(u){return 'https://corsproxy.io/?'+encodeURIComponent(u)},
  function(u){return 'https://api.allorigins.win/raw?url='+encodeURIComponent(u)},
  function(u){return 'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(u)},
  function(u){return 'https://cors-anywhere.herokuapp.com/'+u},
  function(u){return 'https://thingproxy.freeboard.io/fetch/'+u}
];
var wp=-1;
var splashLog=null; // reference to status element during startup

function logSplash(msg,color){
  if(splashLog){splashLog.style.color=color||'var(--amber)';splashLog.textContent=msg}
  console.log('[CFD]',msg);
}

async function yf(sym,intv,range){
  var base='https://query1.finance.yahoo.com/v8/finance/chart/'+encodeURIComponent(sym)+'?interval='+intv+'&range='+range+'&includePrePost=false';

  // If we already know a working proxy, try it first
  if(wp>=0){
    try{
      var r=await ft(PX[wp](base),8000);
      if(r.ok){var t=await r.text();var d=JSON.parse(t);var p=pY(d);if(p&&p.length>0)return p}
    }catch(e){}
  }

  // Try direct (usually blocked by CORS from browser)
  if(wp===-1){
    try{var r0=await ft(base,5000);if(r0.ok){var d0=await r0.json();var p0=pY(d0);if(p0&&p0.length>0){wp=-1;return p0}}}catch(e){}
  }

  // Try all proxies
  for(var i=0;i<PX.length;i++){
    if(i===wp)continue; // already tried
    try{
      logSplash('Proxy '+(i+1)+'/'+PX.length+'...');
      var r2=await ft(PX[i](base),8000);
      if(r2.ok){
        var t2=await r2.text();
        // Some proxies wrap in JSON
        var d2;
        try{d2=JSON.parse(t2)}catch(e){continue}
        var p2=pY(d2);
        if(p2&&p2.length>0){wp=i;logSplash('Proxy '+(i+1)+' OK!','var(--green)');return p2}
      }
    }catch(e){continue}
  }
  return null;
}
function ft(u,ms){return Promise.race([fetch(u),new Promise(function(_,r){setTimeout(function(){r(new Error('timeout'))},ms)})])}
function pY(j){try{var r=j.chart.result[0],ts=r.timestamp,q=r.indicators.quote[0];if(!ts||!q.close)return null;var c=[];for(var i=0;i<ts.length;i++){if(q.close[i]==null)continue;c.push({date:new Date(ts[i]*1000).toISOString().split('T')[0],o:q.open[i]||q.close[i],h:q.high[i]||q.close[i],l:q.low[i]||q.close[i],c:q.close[i],v:q.volume?(q.volume[i]||0):0})}return c}catch(e){return null}}

async function startApp(){
  var st=document.getElementById('splashStatus');
  st.style.display='block';
  splashLog=st;
  logSplash('A testar ligaÃ§Ã£o ao Yahoo Finance...');

  try{
    var d=await yf('AAPL','1d','5d');
    if(d&&d.length>0){
      logSplash('Conectado! A carregar...','var(--green)');
      setTimeout(function(){
        document.getElementById('splashScreen').style.display='none';
        document.getElementById('dashboard').classList.add('active');
        splashLog=null;
        initUI();refresh();
      },300);
      return;
    }
    logSplash('Yahoo respondeu mas sem dados. A tentar BTC...','var(--amber)');
    // Fallback: try crypto (always has data)
    var d2=await yf('BTC-USD','1d','5d');
    if(d2&&d2.length>0){
      logSplash('Conectado via crypto! A carregar...','var(--green)');
      setTimeout(function(){
        document.getElementById('splashScreen').style.display='none';
        document.getElementById('dashboard').classList.add('active');
        splashLog=null;
        initUI();refresh();
      },300);
      return;
    }
  }catch(e){
    console.error('[CFD] startApp error:',e);
  }
  logSplash('Todos os proxies falharam. Verifica a internet ou tenta mais tarde.','var(--red)');
  // Show retry button
  st.innerHTML+='<br><button onclick="startApp()" style="margin-top:10px;padding:8px 20px;border:none;border-radius:8px;background:var(--blue);color:#fff;font-family:var(--heading);font-size:12px;cursor:pointer">â†» Tentar de novo</button>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INDICATORS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function iSMA(c,p){return c.map(function(_,i){if(i<p-1)return null;var s=0;for(var j=i-p+1;j<=i;j++)s+=c[j].c;return s/p})}
function iEMA(c,p){var k=2/(p+1),r=[],pv=null;c.forEach(function(x,i){if(i<p-1){r.push(null);return}if(pv===null){var s=0;for(var j=0;j<p;j++)s+=c[j].c;pv=s/p}else pv=x.c*k+pv*(1-k);r.push(pv)});return r}
function iRSI(c,p){p=p||14;var r=[],ag=0,al=0;for(var i=0;i<c.length;i++){if(!i){r.push(null);continue}var ch=c[i].c-c[i-1].c,g=ch>0?ch:0,lo=ch<0?-ch:0;if(i<=p){ag+=g;al+=lo;if(i===p){ag/=p;al/=p;r.push(al===0?100:+(100-100/(1+ag/al)).toFixed(2))}else r.push(null)}else{ag=(ag*(p-1)+g)/p;al=(al*(p-1)+lo)/p;r.push(al===0?100:+(100-100/(1+ag/al)).toFixed(2))}}return r}
function iMACD(c){var e12=iEMA(c,12),e26=iEMA(c,26);var ml=e12.map(function(v,i){return(v!=null&&e26[i]!=null)?v-e26[i]:null});var k=2/10,sp=null;var sl=ml.map(function(v){if(v==null)return null;sp=sp==null?v:v*k+sp*(1-k);return sp});var h=ml.map(function(v,i){return(v!=null&&sl[i]!=null)?v-sl[i]:null});return{ml:ml,sl:sl,h:h}}
function iBOLL(c,p,m){p=p||20;m=m||2;return c.map(function(_,i){if(i<p-1)return{u:null,l:null};var sl=c.slice(i-p+1,i+1).map(function(x){return x.c});var mn=sl.reduce(function(a,v){return a+v},0)/p;var st=Math.sqrt(sl.reduce(function(a,v){return a+(v-mn)*(v-mn)},0)/p);return{u:mn+m*st,l:mn-m*st}})}
function iFIB(c){var mx=-Infinity,mn=Infinity;c.forEach(function(x){if(x.h>mx)mx=x.h;if(x.l<mn)mn=x.l});var d=mx-mn;return{"0%":mx,"23.6%":mx-d*.236,"38.2%":mx-d*.382,"50%":mx-d*.5,"61.8%":mx-d*.618,"78.6%":mx-d*.786,"100%":mn}}
function iSR(c){var s=c.slice(-40).map(function(x){return x.c}).sort(function(a,b){return a-b}),l=s.length;return{sf:s[Math.floor(l*.05)],su:s[Math.floor(l*.2)],re:s[Math.floor(l*.8)],rf:s[Math.floor(l*.95)]}}
function iATR(c,p){p=p||14;var r=[];for(var i=0;i<c.length;i++){if(!i){r.push(null);continue}var tr=Math.max(c[i].h-c[i].l,Math.abs(c[i].h-c[i-1].c),Math.abs(c[i].l-c[i-1].c));if(i<p){r.push(null);continue}if(i===p){var s=0;for(var j=1;j<=p;j++)s+=Math.max(c[j].h-c[j].l,Math.abs(c[j].h-c[j-1].c),Math.abs(c[j].l-c[j-1].c));r.push(s/p)}else r.push((r[i-1]*(p-1)+tr)/p)}return r}
function iADX(c,p){p=p||14;var r=[];for(var i=0;i<c.length;i++){if(i<p*2){r.push(null);continue}var sl=c.slice(i-p*2,i+1),pD=0,nD=0,tr=0;for(var j=1;j<sl.length;j++){var u=sl[j].h-sl[j-1].h,d=sl[j-1].l-sl[j].l;pD+=(u>d&&u>0)?u:0;nD+=(d>u&&d>0)?d:0;tr+=Math.max(sl[j].h-sl[j].l,Math.abs(sl[j].h-sl[j-1].c),Math.abs(sl[j].l-sl[j-1].c))}if(!tr){r.push(0);continue}var pI=100*pD/tr,nI=100*nD/tr;r.push(+((Math.abs(pI-nI)/(pI+nI||1))*100).toFixed(1))}return r}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIGNAL ENGINE â€” MODE-SPECIFIC
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function checkEntry(i,c,s20,s50,rsi,adx,atr,macd,boll,weeklyBias){
  var price=c[i].c,reasons=[],warnings=[];
  var hasSMA=s20[i]!=null&&s50[i]!=null;
  var hasRSI=rsi[i]!=null;
  var hasADX=adx[i]!=null;
  var hasATR=atr[i]!=null;
  if(!hasSMA||!hasRSI||!hasADX||!hasATR) return null;

  var s20v=s20[i],s50v=s50[i],rsiv=rsi[i],adxv=adx[i],atrv=atr[i];
  var uptrend=s20v>s50v,downtrend=s20v<s50v;
  // Detect lateralization (ADX < 20)
  if(adxv<20){warnings.push('ADX<20 (lateralizaÃ§Ã£o)');return{type:null,reasons:reasons,warnings:warnings}}

  if(MODE==='acoes'){
    // AÃ‡Ã•ES: Long only
    if(uptrend&&price>s50v&&rsiv>=40&&rsiv<=60&&adxv>20){
      var sl=price-1.5*atrv,tp=price+3*atrv;
      reasons.push('SMA20>SMA50','PreÃ§o>SMA50','RSI '+rsiv.toFixed(0)+' (40-60)','ADX '+adxv.toFixed(0)+' (>20)');
      return{type:'BUY',price:price,sl:sl,tp:tp,atr:atrv,reasons:reasons,warnings:warnings,rr:+(3*atrv/(1.5*atrv)).toFixed(1)}
    }
    if(!uptrend)warnings.push('SMA20<SMA50 â€” sem tendÃªncia â†‘');
    if(price<=s50v)warnings.push('PreÃ§o abaixo SMA50');
    if(rsiv<40||rsiv>60)warnings.push('RSI '+rsiv.toFixed(0)+' fora da zona 40-60');
  }else{
    // CFDs: Long + Short, alinhamento TF obrigatÃ³rio
    if(uptrend){
      // Long setup: pullback to SMA20
      var nearSMA20=Math.abs(price-s20v)/price<0.02;
      if(nearSMA20&&rsiv>=40&&rsiv<=50&&adxv>20){
        if(weeklyBias&&weeklyBias!=='Bullish'){warnings.push('TF semanal nÃ£o alinhado ('+weeklyBias+')');return{type:null,reasons:reasons,warnings:warnings}}
        var sl=price-1.5*atrv,tp=price+3*atrv;
        reasons.push('SMA20>SMA50 (â†‘)','Pullback SMA20','RSI '+rsiv.toFixed(0)+' (40-50)','ADX '+adxv.toFixed(0),'TF alinhados');
        return{type:'BUY',price:price,sl:sl,tp:tp,atr:atrv,reasons:reasons,warnings:warnings,rr:2}
      }
      if(!nearSMA20)warnings.push('Sem pullback Ã  SMA20');
      if(rsiv<40||rsiv>50)warnings.push('RSI '+rsiv.toFixed(0)+' (ideal: 40-50)');
    }
    if(downtrend){
      var nearSMA20s=Math.abs(price-s20v)/price<0.02;
      if(nearSMA20s&&rsiv>=50&&rsiv<=60&&adxv>20){
        if(weeklyBias&&weeklyBias!=='Bearish'){warnings.push('TF semanal nÃ£o alinhado ('+weeklyBias+')');return{type:null,reasons:reasons,warnings:warnings}}
        var sl=price+1.5*atrv,tp=price-3*atrv;
        reasons.push('SMA20<SMA50 (â†“)','Pullback SMA20','RSI '+rsiv.toFixed(0)+' (50-60)','ADX '+adxv.toFixed(0),'TF alinhados');
        return{type:'SELL',price:price,sl:sl,tp:tp,atr:atrv,reasons:reasons,warnings:warnings,rr:2}
      }
    }
    if(!uptrend&&!downtrend)warnings.push('Sem tendÃªncia clara');
  }
  return{type:null,reasons:reasons,warnings:warnings};
}

/* Generate signals for a candle array */
function genSignals(c,s20,s50,rsi,adx,atr,macd,boll,weeklyBias){
  var sigs=[];
  for(var i=50;i<c.length;i++){
    var res=checkEntry(i,c,s20,s50,rsi,adx,atr,macd,boll,weeklyBias);
    if(res&&res.type){sigs.push({idx:i,date:c[i].date,price:res.price,type:res.type,sl:res.sl,tp:res.tp,atr:res.atr,reasons:res.reasons,warnings:res.warnings,rr:res.rr||2,conf:res.reasons.length*25})}
  }
  return sigs;
}

function analyzeTF(c,lb){
  if(!c||c.length<30)return{label:lb,bias:'Neutro',score:0};
  var s20=iSMA(c,20),s50=iSMA(c,50),rsi=iRSI(c),l=c.length-1,lp=c[l].c,sc=0;
  if(s20[l]!=null&&s50[l]!=null){if(s20[l]>s50[l]&&lp>s20[l])sc+=2;else if(s20[l]<s50[l]&&lp<s20[l])sc-=2}
  return{label:lb,bias:sc>1?'Bullish':sc<-1?'Bearish':'Neutro',score:sc};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BACKTESTING ENGINE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runBacktest(){
  var btn=document.getElementById('btBtn');btn.disabled=true;btn.textContent='A executar...';
  var years=parseInt(document.getElementById('btYears').value);
  var range=years<=2?'2y':years<=3?'3y':'5y';
  var info=getI(sel);
  var daily=await yf(info.s,'1d',range);
  var weekly=await yf(info.s,'1wk',range);
  if(!daily||daily.length<60){document.getElementById('btResults').innerHTML='<div class="warn-box">Dados insuficientes para backtest.</div>';btn.disabled=false;btn.textContent='â–¶ Executar';return}
  var wBias=weekly?analyzeTF(weekly,'W').bias:null;
  var s20=iSMA(daily,20),s50=iSMA(daily,50),rsi=iRSI(daily),adx=iADX(daily),atr=iATR(daily),macd=iMACD(daily),boll=iBOLL(daily);
  var sigs=genSignals(daily,s20,s50,rsi,adx,atr,macd,boll,wBias);

  // Simulate trades
  var trades=[],inTrade=false,entry=null;
  for(var si=0;si<sigs.length;si++){
    var sig=sigs[si];
    if(inTrade)continue; // one trade at a time
    entry={type:sig.type,entryPrice:sig.price,entryDate:sig.date,sl:sig.sl,tp:sig.tp,entryIdx:sig.idx};
    // Walk forward to find exit
    for(var j=sig.idx+1;j<daily.length;j++){
      var hi=daily[j].h,lo=daily[j].l;
      if(entry.type==='BUY'){
        if(lo<=entry.sl){trades.push({type:'BUY',entry:entry.entryPrice,exit:entry.sl,entryDate:entry.entryDate,exitDate:daily[j].date,pnl:entry.sl-entry.entryPrice,hit:'SL'});inTrade=false;break}
        if(hi>=entry.tp){trades.push({type:'BUY',entry:entry.entryPrice,exit:entry.tp,entryDate:entry.entryDate,exitDate:daily[j].date,pnl:entry.tp-entry.entryPrice,hit:'TP'});inTrade=false;break}
      }else{
        if(hi>=entry.sl){trades.push({type:'SELL',entry:entry.entryPrice,exit:entry.sl,entryDate:entry.entryDate,exitDate:daily[j].date,pnl:entry.entryPrice-entry.sl,hit:'SL'});inTrade=false;break}
        if(lo<=entry.tp){trades.push({type:'SELL',entry:entry.entryPrice,exit:entry.tp,entryDate:entry.entryDate,exitDate:daily[j].date,pnl:entry.entryPrice-entry.tp,hit:'TP'});inTrade=false;break}
      }
    }
    inTrade=false;
  }

  // Calculate stats
  var wins=trades.filter(function(t){return t.pnl>0}),losses=trades.filter(function(t){return t.pnl<=0});
  var winRate=trades.length?wins.length/trades.length*100:0;
  var grossWin=wins.reduce(function(s,t){return s+t.pnl},0);
  var grossLoss=Math.abs(losses.reduce(function(s,t){return s+t.pnl},0));
  var pf=grossLoss>0?grossWin/grossLoss:grossWin>0?99:0;
  var totalPnl=trades.reduce(function(s,t){return s+t.pnl},0);
  var expectancy=trades.length?totalPnl/trades.length:0;
  // Max drawdown
  var equity=0,peak=0,maxDD=0;
  trades.forEach(function(t){equity+=t.pnl;if(equity>peak)peak=equity;var dd=peak-equity;if(dd>maxDD)maxDD=dd});
  var maxDDpct=capital>0?(maxDD/(capital)*100):0;
  var valid=pf>=1.3&&maxDDpct<=25;

  // Render
  var h='<div class="bt-valid" style="background:'+(valid?'rgba(0,230,138,.08);color:var(--green);border:1px solid rgba(0,230,138,.2)':'rgba(255,71,87,.08);color:var(--red);border:1px solid rgba(255,71,87,.2)')+'">'+
    (valid?'âœ… SISTEMA VALIDADO':'âŒ SISTEMA INVÃLIDO')+'</div>';
  h+='<div class="card-grid c4">';
  h+='<div class="mini-card"><div class="mc-label">Trades</div><div class="mc-value">'+trades.length+'</div></div>';
  h+='<div class="mini-card"><div class="mc-label">Win Rate</div><div class="mc-value" style="color:'+(winRate>=50?'var(--green)':'var(--red)')+'">'+winRate.toFixed(1)+'%</div></div>';
  h+='<div class="mini-card"><div class="mc-label">Profit Factor</div><div class="mc-value" style="color:'+(pf>=1.3?'var(--green)':'var(--red)')+'">'+pf.toFixed(2)+'</div></div>';
  h+='<div class="mini-card"><div class="mc-label">Max DD</div><div class="mc-value" style="color:'+(maxDDpct<=25?'var(--green)':'var(--red)')+'">'+maxDDpct.toFixed(1)+'%</div></div>';
  h+='<div class="mini-card"><div class="mc-label">Expectativa</div><div class="mc-value" style="color:'+(expectancy>0?'var(--green)':'var(--red)')+'">'+expectancy.toFixed(2)+'</div></div>';
  h+='<div class="mini-card"><div class="mc-label">P&L Total</div><div class="mc-value" style="color:'+(totalPnl>0?'var(--green)':'var(--red)');'">'+(totalPnl>0?'+':'')+totalPnl.toFixed(2)+'</div></div>';
  h+='<div class="mini-card"><div class="mc-label">Wins</div><div class="mc-value" style="color:var(--green)">'+wins.length+'</div></div>';
  h+='<div class="mini-card"><div class="mc-label">Losses</div><div class="mc-value" style="color:var(--red)">'+losses.length+'</div></div>';
  h+='</div>';
  if(!valid){h+='<div class="warn-box">';if(pf<1.3)h+='Profit Factor '+pf.toFixed(2)+' < 1.3 â€” sistema nÃ£o lucrativo. ';if(maxDDpct>25)h+='Drawdown '+maxDDpct.toFixed(1)+'% > 25% â€” risco excessivo.';h+='</div>'}
  h+='<div class="card-title" style="margin-top:14px">Trades</div><div class="bt-trades">';
  trades.forEach(function(t,i){var ok=t.pnl>0;h+='<div class="bt-trade"><span style="color:'+(t.type==='BUY'?'var(--green)':'var(--red)')+'">'+t.type+'</span><span>'+t.entryDate+'</span><span>'+t.entry.toFixed(curDP)+' â†’ '+t.exit.toFixed(curDP)+'</span><span style="font-size:8px;color:var(--t3)">'+t.hit+'</span><span style="color:'+(ok?'var(--green)':'var(--red)');'">'+(ok?'+':'')+t.pnl.toFixed(2)+'</span></div>'});
  h+='</div>';
  document.getElementById('btResults').innerHTML='<div class="bt-result">'+h+'</div>';
  btn.disabled=false;btn.textContent='â–¶ Executar';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POSITIONS & RISK CALC
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function calcRisk(){
  capital=parseFloat(document.getElementById('inpCapital').value)||10000;
  riskPct=parseFloat(document.getElementById('inpRiskPct').value)||1;
  leverage=parseFloat(document.getElementById('inpLev').value)||1;
  var riskEur=capital*(riskPct/100);
  var spread=XTB_SPREADS[sel]||0;
  var h='Risco: <b>â‚¬'+riskEur.toFixed(2)+'</b> por trade';
  if(MODE==='cfds'&&leverage>1){
    h+=' Â· ExposiÃ§Ã£o: <b>â‚¬'+(capital*leverage).toFixed(0)+'</b>';
    h+=' Â· Margem: <b>â‚¬'+(capital).toFixed(0)+'</b>';
  }
  if(spread>0)h+=' Â· Spread: <b>'+spread+'</b>';
  document.getElementById('riskResult').innerHTML=h;
  saveRisk();if(lastAnalysis)renderPosCalc(lastAnalysis);
}

function renderPosCalc(a){
  if(!a||!a.type||!a.sl){document.getElementById('posCalc').innerHTML='';return}
  var riskEur=capital*(riskPct/100);
  var spread=XTB_SPREADS[sel]||0;
  var distSL=Math.abs(a.price-a.sl);
  if(distSL<=0){document.getElementById('posCalc').innerHTML='';return}
  var effDist=Math.max(distSL-spread/2,distSL*0.5);
  var units=Math.floor(riskEur/effDist);
  var totalCost=units*a.price;
  var spreadCost=spread*units;
  var h='<div style="padding:10px;background:rgba(0,230,138,.04);border:1px solid rgba(0,230,138,.12);border-radius:10px;font-size:10px">';
  h+='ğŸ“ <strong>PosiÃ§Ã£o:</strong> <span style="color:var(--green);font-weight:700">'+units+'</span>';
  h+=MODE==='acoes'?' aÃ§Ãµes':' unidades';
  h+=' Â· Custo: â‚¬'+totalCost.toFixed(2);
  if(MODE==='cfds'&&leverage>1)h+=' Â· Margem: â‚¬'+(totalCost/leverage).toFixed(2);
  h+=' Â· Risco: â‚¬'+riskEur.toFixed(2)+' ('+riskPct+'%)';
  if(spreadCost>0.01)h+=' Â· <span style="color:var(--amber)">Spread: â‚¬'+spreadCost.toFixed(2)+'</span>';
  h+='</div>';
  document.getElementById('posCalc').innerHTML=h;
}

function openPos(t,u,p,sl,tp,notes,trailing){
  if(!sl){showToast('ğŸš«','SL obrigatÃ³rio â€” gestÃ£o de risco');return}
  // Check max positions
  var openCount=positions.filter(function(x){return!x.closed}).length;
  if(openCount>=MAX_POS){showToast('ğŸš«','MÃ¡ximo '+MAX_POS+' posiÃ§Ãµes atingido');return}
  // Check daily loss limit
  if(isDailyLimitHit()){showToast('ğŸš«','Limite de perda diÃ¡ria atingido ('+dailyLossLimit+'%)');return}
  // Market hours check
  var mkt=getMarketStatus(sel);
  if(!mkt.open){showToast('âš ï¸','Mercado fechado: '+mkt.label);} // warn but allow
  // Check news
  var evts=getUpcomingEvents();
  var highImpact=evts.filter(function(e){return e.impact>=3&&e.when==='HOJE'});
  if(highImpact.length){showToast('âš ï¸','NotÃ­cia hoje: '+highImpact[0].name+'! Risco elevado.');}
  // Correlation warning
  var corrW=checkCorrelation(sel);
  if(corrW){showToast('âš ï¸',corrW[0]);}
  // Adjust SL/TP for spread
  var spread=XTB_SPREADS[sel]||0;
  var adjSL=parseFloat(sl);
  var adjTP=tp?parseFloat(tp):null;
  if(spread>0){
    if(t==='BUY'){adjSL-=spread/2;if(adjTP)adjTP-=spread/2}
    else{adjSL+=spread/2;if(adjTP)adjTP+=spread/2}
  }
  positions.push({id:Date.now(),symbol:sel,type:t,units:parseFloat(u),entryPrice:parseFloat(p),entryDate:new Date().toISOString().split('T')[0],sl:adjSL,tp:adjTP,mode:MODE,notes:notes||'',trailing:!!trailing,trailDist:trailing?Math.abs(parseFloat(p)-adjSL):0,trailHigh:t==='BUY'?parseFloat(p):null,trailLow:t==='SELL'?parseFloat(p):null,spread:spread});
  saveP();renderPos();showToast('ğŸ“Š',t+' '+u+'x @ '+p+(spread?' (spread:'+spread+')':''));
}
function closePos(id,exitNote){
  var p=positions.find(function(x){return x.id===id});if(!p)return;
  var pnl=p.type==='BUY'?(curP-p.entryPrice)*p.units:(p.entryPrice-curP)*p.units;
  // Subtract spread cost
  if(p.spread)pnl-=p.spread*p.units;
  tradeHist.push({symbol:p.symbol,type:p.type,units:p.units,entry:p.entryPrice,exit:curP,entryDate:p.entryDate,exitDate:new Date().toISOString().split('T')[0],pnl:+pnl.toFixed(2),mode:p.mode||MODE,notes:(p.notes||'')+(exitNote?' | EXIT: '+exitNote:''),spread:p.spread||0});
  positions=positions.filter(function(x){return x.id!==id});saveP();renderPos();renderStats();updateDailyPnL();
  showToast(pnl>=0?'ğŸ’°':'ğŸ“‰',(pnl>=0?'+':'')+pnl.toFixed(2));
}
// Trailing stop update
function updateTrailingStops(price){
  var changed=false;
  positions.forEach(function(pos){
    if(!pos.trailing||pos.closed||pos.symbol!==sel)return;
    if(pos.type==='BUY'){
      if(price>pos.trailHigh){pos.trailHigh=price;pos.sl=price-pos.trailDist;changed=true}
    }else{
      if(pos.trailLow===null||price<pos.trailLow){pos.trailLow=price;pos.sl=price+pos.trailDist;changed=true}
    }
  });
  if(changed)saveP();
}
// Check SL/TP alerts
function checkAlerts(price){
  positions.forEach(function(pos){if(pos.closed||pos.symbol!==sel)return;
    if(pos.sl!=null){if((pos.type==='BUY'&&price<=pos.sl)||(pos.type==='SELL'&&price>=pos.sl)){showToast('ğŸš¨ STOP-LOSS!',pos.symbol+' @ '+price.toFixed(curDP));if(notif)try{new Notification('ğŸš¨ SL â€” '+pos.symbol)}catch(e){}}}
    if(pos.tp!=null){if((pos.type==='BUY'&&price>=pos.tp)||(pos.type==='SELL'&&price<=pos.tp)){showToast('ğŸ¯ TAKE-PROFIT!',pos.symbol+' @ '+price.toFixed(curDP));if(notif)try{new Notification('ğŸ¯ TP â€” '+pos.symbol)}catch(e){}}}
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN REFRESH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function refresh(){
  var info=getI(sel);setSt('load',info.n+'...');
  document.getElementById('symbolName').textContent=info.e+' '+info.n;document.getElementById('priceDisplay').textContent='...';
  var candles=await yf(info.s,'1d','1y');
  if(!candles||candles.length<50){setSt('err','Sem dados â€” '+info.s);return}
  var weekly=await yf(info.s,'1wk','2y');
  var s20=iSMA(candles,20),s50=iSMA(candles,50),rsi=iRSI(candles),macd=iMACD(candles),boll=iBOLL(candles),fib=iFIB(candles),sr=iSR(candles),atr=iATR(candles),adx=iADX(candles);
  var dTF=analyzeTF(candles,'DiÃ¡rio'),wTF=weekly?analyzeTF(weekly,'Semanal'):null;
  var wBias=wTF?wTF.bias:null;
  var sigs=genSignals(candles,s20,s50,rsi,adx,atr,macd,boll,wBias);

  var last=candles[candles.length-1],prev=candles[candles.length-2];
  var lp=last.c,ch=lp-prev.c,chP=(ch/prev.c)*100;
  curDP=lp>100?2:lp>1?3:lp>.01?5:6;curP=lp;
  document.getElementById('priceDisplay').textContent=lp.toFixed(curDP);
  var ce=document.getElementById('changeDisplay');ce.textContent=(ch>=0?'â–² ':'â–¼ ')+Math.abs(ch).toFixed(curDP)+' ('+(chP>=0?'+':'')+chP.toFixed(2)+'%)';ce.style.color=ch>=0?'var(--green)':'var(--red)';

  // Metrics
  var li=candles.length-1;
  var lr=rsi[li],la=adx[li],lat=atr[li];
  document.getElementById('mRSI').textContent=lr?lr.toFixed(1):'â€”';document.getElementById('mRSI').style.color=lr>70?'var(--red)':lr<30?'var(--green)':'var(--t)';
  document.getElementById('mADX').textContent=la?la.toFixed(0):'â€”';document.getElementById('mADX').style.color=la>25?'var(--green)':la<20?'var(--red)':'var(--t2)';
  document.getElementById('mATR').textContent=lat?lat.toFixed(curDP):'â€”';

  // Current entry check
  var curEntry=checkEntry(li,candles,s20,s50,rsi,adx,atr,macd,boll,wBias);
  lastAnalysis=curEntry&&curEntry.type?curEntry:null;
  if(lastAnalysis)document.getElementById('mRR').textContent='1:'+lastAnalysis.rr;else document.getElementById('mRR').textContent='â€”';

  // Recommendation
  var recTxt,recCol,emoji;
  if(curEntry&&curEntry.type){
    var buy=curEntry.type==='BUY';emoji=buy?'ğŸŸ¢':'ğŸ”´';recTxt=buy?'COMPRA':'VENDA';recCol=buy?'var(--green)':'var(--red)';
  }else{emoji='â³';recTxt='AGUARDAR';recCol='var(--t3)'}
  document.getElementById('recValue').textContent=recTxt;document.getElementById('recValue').style.color=recCol;
  document.getElementById('modeLabel').textContent=MODE==='acoes'?'MODO AÃ‡Ã•ES':'MODO CFDs';

  // Trend
  var trend=dTF.bias==='Bullish'?'â†‘ Bull':dTF.bias==='Bearish'?'â†“ Bear':'â€” Lateral';
  document.getElementById('scoreDisp').innerHTML=trend+(wTF?' Â· W: '+wTF.bias:'');

  // Timeframes
  var tfH='<span class="tf-label-text">TF:</span>';
  [dTF,wTF].forEach(function(tf){if(!tf)return;var c=tf.bias==='Bullish'?'var(--green)':tf.bias==='Bearish'?'var(--red)':'var(--t3)';var bg=tf.bias==='Bullish'?'rgba(0,230,138,.06)':tf.bias==='Bearish'?'rgba(255,71,87,.06)':'rgba(71,85,105,.06)';tfH+='<span class="tf-badge" style="color:'+c+';background:'+bg+'">'+tf.label+': '+tf.bias+'</span>'});
  document.getElementById('tfRow').innerHTML=tfH;

  // Action text
  var atxt='';
  if(curEntry&&curEntry.type){
    atxt='<strong>'+(curEntry.type==='BUY'?'Entrada LONG':'Entrada SHORT')+'</strong> a <strong>'+curEntry.price.toFixed(curDP)+'</strong>';
    atxt+='<br>'+curEntry.reasons.join(' Â· ');
    atxt+='<br><br>SL: '+curEntry.sl.toFixed(curDP)+' Â· TP: '+curEntry.tp.toFixed(curDP)+' Â· R:R 1:'+curEntry.rr;
  }else{
    atxt='Sem sinal â€” ';
    if(curEntry&&curEntry.warnings&&curEntry.warnings.length)atxt+=curEntry.warnings.join('. ');
    else atxt+='condiÃ§Ãµes nÃ£o satisfeitas.';
  }
  document.getElementById('actionText').innerHTML=atxt;

  // Warnings
  var wb='';
  if(curEntry&&curEntry.warnings&&curEntry.warnings.length&&curEntry.type)wb='<div class="warn-box">âš ï¸ '+curEntry.warnings.join(' Â· ')+'</div>';
  if(la!=null&&la<20)wb+='<div class="warn-box">âš ï¸ ADX '+la.toFixed(0)+' â€” mercado lateral. Evitar operar.</div>';
  document.getElementById('warnBox').innerHTML=wb;

  // Risk row
  var rH='';
  if(curEntry&&curEntry.type){
    if(curEntry.sl)rH+='<div class="risk-pill"><div class="rp-label">SL</div><div class="rp-value" style="color:var(--red)">'+curEntry.sl.toFixed(curDP)+'</div></div>';
    if(curEntry.tp)rH+='<div class="risk-pill"><div class="rp-label">TP</div><div class="rp-value" style="color:var(--green)">'+curEntry.tp.toFixed(curDP)+'</div></div>';
    rH+='<div class="risk-pill"><div class="rp-label">ATR</div><div class="rp-value" style="color:var(--cyan)">'+curEntry.atr.toFixed(curDP)+'</div></div>';
    rH+='<div class="risk-pill"><div class="rp-label">R:R</div><div class="rp-value" style="color:var(--amber)">1:'+curEntry.rr+'</div></div>';
  }
  document.getElementById('riskRow').innerHTML=rH;

  // Position calculator
  if(lastAnalysis)renderPosCalc(lastAnalysis);else document.getElementById('posCalc').innerHTML='';

  renderPos();renderStats();
  drawMain(candles,s20,s50,boll,sigs,fib);drawRSI(rsi);drawMACD(macd);
  renderSigs(sigs);renderLvl(sr,fib,lp);
  document.getElementById('btModeLabel').textContent='Modo: '+(MODE==='acoes'?'AÃ§Ãµes':'CFDs');

  // Market status
  var mkt=getMarketStatus(info.s);
  document.getElementById('marketStatus').innerHTML='<span class="status-dot '+mkt.cls+'" style="display:inline-block;vertical-align:middle;margin-right:4px"></span>'+mkt.label;

  // News alerts
  var evts=getUpcomingEvents();
  if(evts.length){
    var nh='';evts.forEach(function(e){var ic=e.impact>=3?'ğŸ”´':'ğŸŸ¡';nh+='<div style="font-size:9px;color:'+(e.impact>=3?'var(--red)':'var(--amber)')+'">'+ic+' '+e.when+': '+e.name+'</div>'});
    document.getElementById('newsPanel').innerHTML=nh;
    if(evts.some(function(e){return e.impact>=3&&e.when==='HOJE'})){
      document.getElementById('warnBox').innerHTML=(document.getElementById('warnBox').innerHTML||'')+'<div class="warn-box">ğŸ“° <strong>Evento macro HOJE:</strong> '+evts.filter(function(e){return e.when==='HOJE'})[0].name+' â€” Evitar abrir posiÃ§Ãµes.</div>';
    }
  }else{document.getElementById('newsPanel').innerHTML='<div style="font-size:9px;color:var(--green)">âœ… Sem eventos macro</div>'}

  // Trailing stops
  updateTrailingStops(lp);
  // SL/TP alerts
  checkAlerts(lp);

  // Daily P&L bar
  updateDailyPnL();
  if(dailyPnL!==0){
    var dlEl=document.getElementById('dailyLimitBar');dlEl.style.display='block';
    var pct=capital>0?(dailyPnL/capital*100):0;
    var isHit=isDailyLimitHit();
    dlEl.innerHTML='<div style="margin-top:8px;padding:8px 12px;border-radius:8px;font-size:10px;background:'+(isHit?'rgba(255,71,87,.08);border:1px solid rgba(255,71,87,.15)':'rgba(91,127,255,.05);border:1px solid rgba(91,127,255,.1)')+'"><span style="color:'+(dailyPnL>=0?'var(--green)':'var(--red)')+'">P&L Hoje: '+(dailyPnL>=0?'+':'')+dailyPnL.toFixed(2)+'â‚¬ ('+pct.toFixed(2)+'%)</span>'+(isHit?' â€” <strong style="color:var(--red)">LIMITE ATINGIDO</strong>':'')+'</div>';
  }else{document.getElementById('dailyLimitBar').style.display='none'}

  // Correlation warning
  var corrW=checkCorrelation(sel);
  var corrEl=document.getElementById('corrWarning');
  if(corrW){corrEl.style.display='block';corrEl.innerHTML='<div style="margin-top:6px;padding:8px 12px;border-radius:8px;font-size:9px;background:rgba(255,190,11,.06);border:1px solid rgba(255,190,11,.12);color:var(--amber)">'+corrW.join('<br>')+'</div>'}
  else{corrEl.style.display='none'}

  if(notif&&curEntry&&curEntry.type&&curEntry.date!==prevSig[sel]){try{new Notification((curEntry.type==='BUY'?'ğŸŸ¢ COMPRA':'ğŸ”´ VENDA')+' '+info.n)}catch(e){}prevSig[sel]=last.date}
  setSt('ok',info.n+' Â· '+candles.length+'D Â· '+new Date().toLocaleTimeString('pt',{hour:'2-digit',minute:'2-digit'}));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SVG CHARTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sv(t,a){var e=document.createElementNS('http://www.w3.org/2000/svg',t);for(var k in a)e.setAttribute(k,a[k]);return e}
function svT(x,y,t,f,s){var e=sv('text',{x:x,y:y,fill:f,'font-size':s||8,'font-family':'monospace'});e.textContent=t;return e}
function drawMain(c,s20,s50,boll,sigs,fib){
  var W=800,H=280,P={t:14,r:50,b:24,l:6},n=Math.min(60,c.length),vis=c.slice(-n),off=c.length-n;
  var av=[];vis.forEach(function(v){av.push(v.h,v.l)});if(showB)boll.slice(-n).forEach(function(b){if(b.u!=null){av.push(b.u,b.l)}});
  var yN=Math.min.apply(null,av)*.998,yX=Math.max.apply(null,av)*1.002;
  var x=function(i){return P.l+(i/(vis.length-1))*(W-P.l-P.r)},y=function(v){return P.t+(1-(v-yN)/(yX-yN))*(H-P.t-P.b)};
  var cw=Math.max(2,(W-P.l-P.r)/vis.length*.55),sg=sv('svg',{viewBox:'0 0 '+W+' '+H});
  sg.appendChild(sv('rect',{width:W,height:H,fill:'#080c14',rx:8}));
  for(var i=0;i<5;i++){var yy=P.t+(i/4)*(H-P.t-P.b),val=yX-(i/4)*(yX-yN);sg.appendChild(sv('line',{x1:P.l,x2:W-P.r,y1:yy,y2:yy,stroke:'#141c2c'}));sg.appendChild(svT(W-P.r+4,yy+3,val.toFixed(2),'#3a4a6a',7))}
  if(showB){var bs=boll.slice(-n),up='',lo='',rv=[];bs.forEach(function(b,i){if(b.u!=null){up+=x(i)+','+y(b.u)+' ';lo+=x(i)+','+y(b.l)+' ';rv.push(x(i)+','+y(b.l))}});sg.appendChild(sv('polygon',{points:up+rv.reverse().join(' '),fill:'rgba(91,127,255,.04)'}));sg.appendChild(sv('polyline',{points:up,fill:'none',stroke:'rgba(91,127,255,.25)','stroke-width':.8,'stroke-dasharray':'3,3'}));sg.appendChild(sv('polyline',{points:lo,fill:'none',stroke:'rgba(91,127,255,.25)','stroke-width':.8,'stroke-dasharray':'3,3'}))}
  if(showF){for(var lb in fib){var val=fib[lb];if(val<yN||val>yX)continue;sg.appendChild(sv('line',{x1:P.l,x2:W-P.r,y1:y(val),y2:y(val),stroke:'rgba(255,190,11,.15)','stroke-dasharray':'4,4'}));sg.appendChild(svT(P.l+2,y(val)-2,lb,'rgba(255,190,11,.4)',6))}}
  vis.forEach(function(v,i){var g=v.c>=v.o,cl=g?'#00e68a':'#ff4757';sg.appendChild(sv('line',{x1:x(i),x2:x(i),y1:y(v.h),y2:y(v.l),stroke:cl}));sg.appendChild(sv('rect',{x:x(i)-cw/2,y:y(Math.max(v.o,v.c)),width:cw,height:Math.max(.8,y(Math.min(v.o,v.c))-y(Math.max(v.o,v.c))),fill:cl,rx:.5}))});
  if(showS){[{d:s20.slice(-n),c:'#ffbe0b'},{d:s50.slice(-n),c:'#00d4ff'}].forEach(function(o){var p='';o.d.forEach(function(v,i){if(v!=null)p+=x(i)+','+y(v)+' '});sg.appendChild(sv('polyline',{points:p,fill:'none',stroke:o.c,'stroke-width':1.2}))})}
  sigs.filter(function(s){return s.idx>=off}).forEach(function(s){var i=s.idx-off;if(i<0||i>=vis.length)return;var xx=x(i),yy=s.type==='BUY'?y(vis[i].l)+10:y(vis[i].h)-10;var pts=s.type==='BUY'?xx+','+(yy-8)+' '+(xx-4)+','+yy+' '+(xx+4)+','+yy:xx+','+(yy+8)+' '+(xx-4)+','+yy+' '+(xx+4)+','+yy;sg.appendChild(sv('polygon',{points:pts,fill:s.type==='BUY'?'#00e68a':'#ff4757',opacity:'.8'}))});
  positions.filter(function(p){return p.symbol===sel}).forEach(function(pos){if(pos.entryPrice>=yN&&pos.entryPrice<=yX){sg.appendChild(sv('line',{x1:P.l,x2:W-P.r,y1:y(pos.entryPrice),y2:y(pos.entryPrice),stroke:'#5b7fff','stroke-width':1,'stroke-dasharray':'6,3'}));sg.appendChild(svT(P.l+2,y(pos.entryPrice)-3,'ENTRY','#5b7fff',6))}if(pos.sl&&pos.sl>=yN&&pos.sl<=yX)sg.appendChild(sv('line',{x1:P.l,x2:W-P.r,y1:y(pos.sl),y2:y(pos.sl),stroke:'#ff4757','stroke-width':.8,'stroke-dasharray':'4,4'}));if(pos.tp&&pos.tp>=yN&&pos.tp<=yX)sg.appendChild(sv('line',{x1:P.l,x2:W-P.r,y1:y(pos.tp),y2:y(pos.tp),stroke:'#00e68a','stroke-width':.8,'stroke-dasharray':'4,4'}))});
  vis.forEach(function(v,i){if(i%12===0)sg.appendChild(svT(x(i),H-5,v.date.slice(5),'#3a4a6a',7))});
  document.getElementById('chartMain').innerHTML='';document.getElementById('chartMain').appendChild(sg);
}
function drawRSI(rsi){var W=800,H=70,vis=rsi.slice(-60),x=function(i){return 6+(i/(vis.length-1))*(W-54)},y=function(v){return 6+(1-v/100)*58};var sg=sv('svg',{viewBox:'0 0 '+W+' '+H});sg.appendChild(sv('rect',{width:W,height:H,fill:'#080c14',rx:8}));sg.appendChild(sv('rect',{x:6,y:y(70),width:W-54,height:y(30)-y(70),fill:'rgba(91,127,255,.03)'}));sg.appendChild(sv('line',{x1:6,x2:W-48,y1:y(70),y2:y(70),stroke:'rgba(255,71,87,.15)','stroke-dasharray':'3,3'}));sg.appendChild(sv('line',{x1:6,x2:W-48,y1:y(30),y2:y(30),stroke:'rgba(0,230,138,.15)','stroke-dasharray':'3,3'}));
  // Zones for this mode
  var zTop=MODE==='acoes'?60:50,zBot=40;
  sg.appendChild(sv('rect',{x:6,y:y(zTop),width:W-54,height:y(zBot)-y(zTop),fill:'rgba(0,230,138,.04)'}));
  sg.appendChild(svT(W-46,y(70)+3,'70','#ff4757',6));sg.appendChild(svT(W-46,y(30)+3,'30','#00e68a',6));sg.appendChild(svT(W-46,y(zTop)+3,zTop,'#00d4ff',5));sg.appendChild(svT(W-46,y(zBot)+3,zBot,'#00d4ff',5));
  var pts='';vis.forEach(function(v,i){if(v!=null)pts+=x(i)+','+y(v)+' '});sg.appendChild(sv('polyline',{points:pts,fill:'none',stroke:'#b18cff','stroke-width':1.3}));document.getElementById('chartRSI').innerHTML='';document.getElementById('chartRSI').appendChild(sg)}
function drawMACD(macd){var W=800,H=70,vis={m:macd.ml.slice(-60),s:macd.sl.slice(-60),h:macd.h.slice(-60)};var all=vis.m.concat(vis.s,vis.h).filter(function(v){return v!=null});if(!all.length)return;var am=Math.max(Math.abs(Math.min.apply(null,all)),Math.abs(Math.max.apply(null,all)))||1;var x=function(i){return 6+(i/(vis.m.length-1))*(W-54)},y=function(v){return 35-(v/am)*28},bw=Math.max(1.5,(W-54)/vis.h.length*.5);var sg=sv('svg',{viewBox:'0 0 '+W+' '+H});sg.appendChild(sv('rect',{width:W,height:H,fill:'#080c14',rx:8}));sg.appendChild(sv('line',{x1:6,x2:W-48,y1:35,y2:35,stroke:'#141c2c'}));vis.h.forEach(function(v,i){if(v!=null)sg.appendChild(sv('rect',{x:x(i)-bw/2,y:v>=0?y(v):35,width:bw,height:Math.abs(y(v)-35),fill:v>=0?'rgba(0,230,138,.3)':'rgba(255,71,87,.3)',rx:.5}))});var mp='',sp='';vis.m.forEach(function(v,i){if(v!=null)mp+=x(i)+','+y(v)+' '});vis.s.forEach(function(v,i){if(v!=null)sp+=x(i)+','+y(v)+' '});sg.appendChild(sv('polyline',{points:mp,fill:'none',stroke:'#818cf8','stroke-width':1.3}));sg.appendChild(sv('polyline',{points:sp,fill:'none',stroke:'#f97316','stroke-width':1.3}));document.getElementById('chartMACD').innerHTML='';document.getElementById('chartMACD').appendChild(sg)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER: SIGNALS, LEVELS, POSITIONS, STATS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSigs(sigs){var dp=curDP;var h='<div style="font-size:8px;color:var(--t3);margin-bottom:8px;text-transform:uppercase">'+sigs.length+' sinais ('+MODE+')</div>';sigs.slice(-12).reverse().forEach(function(s){var buy=s.type==='BUY',c=buy?'var(--green)':'var(--red)',bg=buy?'rgba(0,230,138,.06)':'rgba(255,71,87,.06)';h+='<div class="signal-card" style="border-left:2px solid '+c+'"><div class="signal-header"><div style="display:flex;align-items:center;gap:7px"><span class="signal-type" style="background:'+bg+';color:'+c+'">'+(buy?'â–² LONG':'â–¼ SHORT')+'</span><span style="font-size:10px;color:var(--t2)">'+s.price.toFixed(dp)+'</span><span style="font-size:8px;color:var(--amber)">R:R 1:'+s.rr+'</span></div><span style="font-size:8px;color:var(--t3)">'+s.date+'</span></div>';if(s.sl!=null)h+='<div style="font-size:8px;margin-top:4px;color:var(--t3)">SL:<span style="color:var(--red)">'+s.sl.toFixed(dp)+'</span> TP:<span style="color:var(--green)">'+s.tp.toFixed(dp)+'</span></div>';h+='<div class="signal-reasons">'+s.reasons.join(' Â· ')+'</div></div>'});document.getElementById('tabSignals').innerHTML=h}
function renderLvl(sr,fib,price){var dp=curDP;var h='<div class="levels-grid"><div class="level-box"><div class="level-title">Suporte & ResistÃªncia</div>';[{k:'sf',l:'Suporte Forte',g:1},{k:'su',l:'Suporte',g:1},{k:'re',l:'ResistÃªncia',g:0},{k:'rf',l:'ResistÃªncia Forte',g:0}].forEach(function(it){h+='<div class="level-row"><span style="color:var(--t2)">'+it.l+'</span><span style="font-weight:600;color:'+(it.g?'var(--green)':'var(--red)')+'">'+sr[it.k].toFixed(dp)+'</span></div>'});h+='<div style="margin-top:8px;padding:7px 10px;background:rgba(91,127,255,.05);border-radius:7px;font-size:8px;color:var(--purple)">PreÃ§o: <b>'+price.toFixed(dp)+'</b></div></div><div class="level-box"><div class="level-title">Fibonacci</div>';for(var l in fib)h+='<div class="level-row"><span style="color:var(--amber)">'+l+'</span><span style="font-weight:600">'+fib[l].toFixed(dp)+'</span></div>';h+='</div></div>';document.getElementById('tabLevels').innerHTML=h}

function renderPos(){
  var my=positions.filter(function(p){return p.symbol===sel});
  if(!my.length){document.getElementById('posSection').innerHTML='<div style="margin:8px 0"><button class="pos-btn" style="background:linear-gradient(135deg,var(--green),#059669);color:#fff;width:100%" onclick="showPF()">ğŸ“Š Registar PosiÃ§Ã£o</button></div>';return}
  var h='<div class="pos-box"><h3>ğŸ“Š PosiÃ§Ãµes</h3>';
  my.forEach(function(pos){var pnl=pos.type==='BUY'?(curP-pos.entryPrice)*pos.units:(pos.entryPrice-curP)*pos.units;if(pos.spread)pnl-=pos.spread*pos.units;var ok=pnl>=0;
    h+='<div class="pos-card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div><span style="font-size:9px;padding:2px 7px;border-radius:4px;background:'+(pos.type==='BUY'?'rgba(0,230,138,.08);color:var(--green)':'rgba(255,71,87,.08);color:var(--red)')+'">'+pos.type+'</span> <span style="font-size:10px;color:var(--t2)">'+pos.units+'x @ '+pos.entryPrice.toFixed(curDP)+'</span>';
    if(pos.trailing)h+=' <span style="font-size:8px;padding:1px 5px;border-radius:3px;background:rgba(0,212,255,.08);color:var(--cyan)">TRAIL</span>';
    h+='</div><div class="pos-pnl" style="color:'+(ok?'var(--green)':'var(--red)');'">'+(pnl>=0?'+':'')+pnl.toFixed(2)+'â‚¬</div></div>';
    h+='<div style="font-size:8px;color:var(--t3)">SL: <span style="color:var(--red)">'+pos.sl.toFixed(curDP)+'</span>'+(pos.trailing?' (trailing)':'')+' Â· TP: '+(pos.tp?'<span style="color:var(--green)">'+pos.tp.toFixed(curDP)+'</span>':'â€”')+'</div>';
    if(pos.spread)h+='<div style="font-size:7px;color:var(--t3);margin-top:2px">Spread: '+pos.spread+'</div>';
    if(pos.notes)h+='<div style="font-size:8px;color:var(--purple);margin-top:4px;padding:4px 8px;background:rgba(177,140,255,.04);border-radius:5px">ğŸ“ '+pos.notes+'</div>';
    h+='<div style="display:flex;gap:5px;margin-top:8px"><button class="pos-btn" style="background:rgba(255,71,87,.08);color:var(--red);border:1px solid rgba(255,71,87,.15);flex:1" onclick="promptClose('+pos.id+')">Fechar</button></div></div>'});
  h+='<button class="pos-btn" style="background:linear-gradient(135deg,var(--blue),#8b6fff);color:#fff;width:100%;margin-top:6px" onclick="showPF()">+ Nova</button></div>';
  document.getElementById('posSection').innerHTML=h;
}
function promptClose(id){
  var pos=positions.find(function(x){return x.id===id});if(!pos)return;
  var pnl=pos.type==='BUY'?(curP-pos.entryPrice)*pos.units:(pos.entryPrice-curP)*pos.units;
  if(pos.spread)pnl-=pos.spread*pos.units;
  document.getElementById('posSection').innerHTML+='<div class="pos-box" style="margin-top:8px"><h3>Fechar posiÃ§Ã£o</h3><div style="font-size:10px;margin-bottom:8px">P&L: <strong style="color:'+(pnl>=0?'var(--green)':'var(--red)');'">'+(pnl>=0?'+':'')+pnl.toFixed(2)+'â‚¬</strong></div><label style="font-size:7px;color:var(--t3);text-transform:uppercase;display:block;margin-bottom:3px">ğŸ“ Nota de saÃ­da (diÃ¡rio)</label><textarea id="exitNote" rows="2" placeholder="Porque fechaste? Estava no plano?" style="width:100%;background:var(--bg);border:1px solid var(--bd);border-radius:8px;padding:8px 10px;color:var(--t);font-family:var(--font);font-size:10px;resize:vertical;outline:none"></textarea><div style="display:flex;gap:6px;margin-top:8px"><button class="pos-btn" style="background:var(--red);color:#fff;flex:1" onclick="closePos('+id+',document.getElementById(\'exitNote\').value)">Confirmar</button><button class="pos-btn" style="background:var(--bg);color:var(--t3);border:1px solid var(--bd);flex:1" onclick="renderPos()">Cancelar</button></div></div>';

}

function showPF(){
var info=getI(sel);var sl=â€™â€™,tp=â€™â€™;
if(lastAnalysis&&lastAnalysis.sl){sl=lastAnalysis.sl.toFixed(curDP);tp=lastAnalysis.tp.toFixed(curDP)}
var typeOpts=MODE===â€˜acoesâ€™?â€™<option value="BUY">COMPRA (Long)</option>â€™:â€™<option value="BUY">LONG</option><option value="SELL">SHORT</option>â€™;
var spread=XTB_SPREADS[sel]||0;
var spreadInfo=spread?â€™<div style="font-size:8px;color:var(--amber);margin-top:6px">ğŸ“Š Spread XTB estimado: â€˜+spread+â€™ (ajustado automaticamente ao SL/TP)</div>â€™:â€™â€™;
// Check blockers
var blockers=â€™â€™;
if(isDailyLimitHit())blockers+=â€™<div class="warn-box">ğŸš« Limite de perda diÃ¡ria atingido. Novas posiÃ§Ãµes bloqueadas.</div>â€™;
var openCount=positions.filter(function(x){return!x.closed}).length;
if(openCount>=MAX_POS)blockers+=â€™<div class="warn-box">ğŸš« MÃ¡ximo â€˜+MAX_POS+â€™ posiÃ§Ãµes atingido.</div>â€™;
var corrW=checkCorrelation(sel);
if(corrW)blockers+=â€™<div class="warn-box">â€™+corrW.join(â€™<br>â€™)+â€™</div>â€™;

document.getElementById(â€˜posSectionâ€™).innerHTML=â€™<div class="pos-box"><h3>â€™+info.e+â€™ â€˜+info.n+â€™</h3>â€™+blockers+â€™<div class="pos-form-grid"><div><label>Tipo</label><select id="pfT">â€™+typeOpts+â€™</select></div><div><label>Unidades</label><input id="pfU" type="number" placeholder="Qtd" step="any"></div><div><label>PreÃ§o</label><input id="pfP" type="number" step="any" value="'+curP.toFixed(curDP)+'"></div><div><label>Data</label><input id="pfD" type="date" value="'+new Date().toISOString().split('T')[0]+'"></div><div><label>SL (obrigatÃ³rio)</label><input id="pfSL" type="number" step="any" value="'+sl+'"></div><div><label>TP</label><input id="pfTP" type="number" step="any" value="'+tp+'"></div></div>â€™
+â€™<div style="display:flex;align-items:center;gap:8px;margin-top:10px"><label style="font-size:9px;color:var(--t2);display:flex;align-items:center;gap:5px;cursor:pointer"><input type="checkbox" id="pfTrail" style="accent-color:var(--cyan)"> Trailing Stop (SL acompanha preÃ§o)</label></div>â€™
+spreadInfo
+â€™<div style="margin-top:10px"><label style="font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:3px">ğŸ“ Notas / DiÃ¡rio</label><textarea id="pfNotes" rows="2" placeholder="Motivo da entrada, contexto, emoÃ§Ã£o..." style="width:100%;background:var(--bg);border:1px solid var(--bd);border-radius:8px;padding:8px 10px;color:var(--t);font-family:var(--font);font-size:10px;resize:vertical;outline:none"></textarea></div>â€™
+â€™<div style="display:flex;gap:6px;margin-top:12px"><button class="pos-btn" style="background:linear-gradient(135deg,var(--green),#059669);color:#fff;flex:1" onclick="subPos()">Abrir PosiÃ§Ã£o</button><button class="pos-btn" style="background:var(--bg);color:var(--t3);border:1px solid var(--bd);flex:1" onclick="renderPos()">Cancelar</button></div></div>â€™;
}
function subPos(){
var u=document.getElementById(â€˜pfUâ€™).value,p=document.getElementById(â€˜pfPâ€™).value,sl=document.getElementById(â€˜pfSLâ€™).value;
if(!u||!p){showToast(â€˜âš ï¸â€™,â€˜Preenche unidades e preÃ§oâ€™);return}
if(!sl){showToast(â€˜ğŸš«â€™,â€˜SL obrigatÃ³rio â€” gestÃ£o de riscoâ€™);return}
var notes=document.getElementById(â€˜pfNotesâ€™).value.trim();
var trailing=document.getElementById(â€˜pfTrailâ€™).checked;
openPos(document.getElementById(â€˜pfTâ€™).value,u,p,sl,document.getElementById(â€˜pfTPâ€™).value||null,notes,trailing);
}

function renderStats(){
var all=tradeHist,tot=all.length,wins=all.filter(function(t){return t.pnl>0}).length;
var tPnl=all.reduce(function(s,t){return s+t.pnl},0);
var gW=all.filter(function(t){return t.pnl>0}).reduce(function(s,t){return s+t.pnl},0);
var gL=Math.abs(all.filter(function(t){return t.pnl<=0}).reduce(function(s,t){return s+t.pnl},0));
var pf=gL>0?gW/gL:gW>0?99:0;
var exp=tot?tPnl/tot:0;
var totalSpread=all.reduce(function(s,t){return s+(t.spread||0)*(t.units||0)},0);
var h=â€™<div class="card"><div class="card-title">ğŸ“Š Painel EstatÃ­stico</div>â€™;
if(!tot)h+=â€™<div style="font-size:10px;color:var(--t3);padding:12px 0">Sem trades registados.</div>â€™;
else{
h+=â€™<div class="card-grid c4">â€™;
h+=â€™<div class="mini-card"><div class="mc-label">P&L Total</div><div class="mc-value" style="color:'+(tPnl>=0?'var(--green)':'var(--red)');'">â€™+(tPnl>=0?â€™+â€™:â€™â€™)+tPnl.toFixed(2)+â€˜â‚¬</div></div>â€™;
h+=â€™<div class="mini-card"><div class="mc-label">Win Rate</div><div class="mc-value" style="color:'+(wins/tot>=.5?'var(--green)':'var(--red)')+'">â€™+Math.round(wins/tot*100)+â€™%</div></div>â€™;
h+=â€™<div class="mini-card"><div class="mc-label">Profit Factor</div><div class="mc-value" style="color:'+(pf>=1.3?'var(--green)':'var(--red)')+'">â€™+pf.toFixed(2)+â€™</div></div>â€™;
h+=â€™<div class="mini-card"><div class="mc-label">Expectativa</div><div class="mc-value" style="color:'+(exp>=0?'var(--green)':'var(--red)')+'">â€™+exp.toFixed(2)+â€˜â‚¬</div></div>â€™;
h+=â€™<div class="mini-card"><div class="mc-label">Custo Spread</div><div class="mc-value" style="color:var(--amber)">â€™+totalSpread.toFixed(2)+â€˜â‚¬</div></div>â€™;
h+=â€™<div class="mini-card"><div class="mc-label">Trades</div><div class="mc-value">â€™+tot+â€™</div></div>â€™;
h+=â€™<div class="mini-card"><div class="mc-label">Wins</div><div class="mc-value" style="color:var(--green)">â€™+wins+â€™</div></div>â€™;
h+=â€™<div class="mini-card"><div class="mc-label">Losses</div><div class="mc-value" style="color:var(--red)">â€™+(tot-wins)+â€™</div></div>â€™;
h+=â€™</div><div class="card-title" style="margin-top:14px">DiÃ¡rio de Trades</div>â€™;
all.slice(-20).reverse().forEach(function(t){
h+=â€™<div style="padding:8px 0;border-bottom:1px solid rgba(30,42,58,.3)">â€™;
h+=â€™<div style="display:flex;justify-content:space-between;font-size:9px"><div><span style="color:'+(t.type==='BUY'?'var(--green)':'var(--red)')+'">â€™+t.type+â€™</span> â€˜+t.symbol+â€™ Â· â€˜+t.units+â€˜x Â· â€˜+t.entryDate+â€™</div><div style="color:'+(t.pnl>=0?'var(--green)':'var(--red)');'">â€™+(t.pnl>=0?â€™+â€™:â€™â€™)+t.pnl.toFixed(2)+â€˜â‚¬</div></div>â€™;
h+=â€™<div style="font-size:8px;color:var(--t3)">â€™+t.entry.toFixed(2)+â€™ â†’ â€˜+t.exit.toFixed(2)+(t.spread?â€™ Â· spread:â€™+t.spread:â€™â€™)+â€™</div>â€™;
if(t.notes)h+=â€™<div style="font-size:8px;color:var(--purple);margin-top:3px;padding:3px 6px;background:rgba(177,140,255,.04);border-radius:4px">ğŸ“ â€˜+t.notes+â€™</div>â€™;
h+=â€™</div>â€™;
});
}
h+=â€™</div>â€™;document.getElementById(â€˜tabStatsâ€™).innerHTML=h;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CSV EXPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportCSV(){
if(!tradeHist.length){showToast(â€˜âš ï¸â€™,â€˜Sem trades para exportarâ€™);return}
var csv=â€˜Simbolo,Tipo,Unidades,Entrada,Saida,Data_Entrada,Data_Saida,PnL,Modo,Spread,Notas\nâ€™;
tradeHist.forEach(function(t){csv+=t.symbol+â€™,â€™+t.type+â€™,â€™+t.units+â€™,â€™+t.entry+â€™,â€™+t.exit+â€™,â€™+t.entryDate+â€™,â€™+t.exitDate+â€™,â€™+t.pnl+â€™,â€™+(t.mode||â€˜N/Aâ€™)+â€™,â€™+(t.spread||0)+â€™,â€â€™+(t.notes||â€™â€™).replace(/â€/g,â€â€™â€)+â€™â€â€™+â€™\nâ€™});
var blob=new Blob([csv],{type:â€˜text/csvâ€™});var a=document.createElement(â€˜aâ€™);a.href=URL.createObjectURL(blob);a.download=â€˜trades_â€™+new Date().toISOString().split(â€˜Tâ€™)[0]+â€™.csvâ€™;a.click();
showToast(â€˜ğŸ“¥â€™,â€˜CSV exportado com â€˜+tradeHist.length+â€™ tradesâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
UI CONTROLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initUI(){
document.getElementById(â€˜inpCapitalâ€™).value=capital;
document.getElementById(â€˜inpRiskPctâ€™).value=riskPct;
setMode(MODE,true);renderGrid();calcRisk();
}
function setMode(m,init){
MODE=m;saveA();
document.querySelectorAll(â€™.mode-btnâ€™).forEach(function(b){b.classList.remove(â€˜onâ€™)});
document.querySelector(â€™.mode-btn.â€™+m).classList.add(â€˜onâ€™);
var lev=document.getElementById(â€˜inpLevâ€™);
if(m===â€˜cfdsâ€™){
lev.disabled=false;
// Auto-set XTB leverage based on asset category
var cat=getCategory(sel);
var defLev=XTB_LEV[cat]||5;
lev.value=defLev;leverage=defLev;
document.getElementById(â€˜inpRiskPctâ€™).value=1;document.getElementById(â€˜inpRiskPctâ€™).max=2;
document.getElementById(â€˜headerTitleâ€™).innerHTML=â€˜CFD Analyzer <span style="color:var(--blue)">CFDs Â· XTB</span>â€™;
}else{lev.disabled=true;lev.value=1;leverage=1;
document.getElementById(â€˜inpRiskPctâ€™).max=3;
document.getElementById(â€˜headerTitleâ€™).innerHTML=â€˜CFD Analyzer <span style="color:var(--green)">AÃ§Ãµes</span>â€™;
}
calcRisk();if(!init)refresh();
}
function getCategory(sym){
for(var c in assets){if(assets[c].find(function(a){return a.s===sym}))return c}
if(sym.indexOf(â€™-USDâ€™)>=0)returnâ€™Cryptoâ€™;if(sym.indexOf(â€™=Xâ€™)>=0)returnâ€™Forexâ€™;if(sym.indexOf(â€™=Fâ€™)>=0)returnâ€™Commoditiesâ€™;returnâ€™AÃ§Ãµesâ€™;
}
function renderGrid(){var h=â€™â€™;for(var c in assets){h+=â€™<div class="cat-label">â€™+c+â€™</div><div class="asset-grid">â€™;assets[c].forEach(function(a){h+=â€™<button class=â€œasset-btn â€˜+(a.s===sel?â€˜selectedâ€™:â€™â€™)+â€™â€ onclick=â€œselA('â€™+a.s.replace(/â€™/g,â€\â€™â€)+â€™')â€>â€™+a.e+â€™ â€˜+a.n+â€™</button>â€™});h+=â€™</div>â€™}document.getElementById(â€˜assetGridâ€™).innerHTML=h}
function selA(s){sel=s;saveA();renderGrid();
// Auto-update leverage when switching assets in CFD mode
if(MODE===â€˜cfdsâ€™){var cat=getCategory(s);var defLev=XTB_LEV[cat]||5;document.getElementById(â€˜inpLevâ€™).value=defLev;leverage=defLev;calcRisk()}
refresh();
}
function getI(s){for(var c in assets){var f=assets[c].find(function(a){return a.s===s});if(f)return f}return{s:s,n:s,e:â€˜ğŸ“Šâ€™}}
function setSt(t,m){var d=t===â€˜okâ€™?â€˜status-dot okâ€™:t===â€˜errâ€™?â€˜status-dot errâ€™:â€˜status-dotâ€™;document.getElementById(â€˜statusBarâ€™).innerHTML=â€™<span class="'+d+'"></span> â€˜+m}
function togOv(t){if(t===â€˜smaâ€™)showS=!showS;if(t===â€˜bollâ€™)showB=!showB;if(t===â€˜fibâ€™)showF=!showF;document.getElementById(â€˜toggleSMAâ€™).classList.toggle(â€˜onâ€™,showS);document.getElementById(â€˜toggleBollâ€™).classList.toggle(â€˜onâ€™,showB);document.getElementById(â€˜toggleFibâ€™).classList.toggle(â€˜onâ€™,showF);refresh()}
function swTab(t,btn){document.querySelectorAll(â€™.tab-btnâ€™).forEach(function(b){b.classList.remove(â€˜onâ€™)});btn.classList.add(â€˜onâ€™);[â€˜tabChartâ€™,â€˜tabSignalsâ€™,â€˜tabLevelsâ€™,â€˜tabBacktestâ€™,â€˜tabStatsâ€™].forEach(function(id){document.getElementById(id).style.display=â€˜noneâ€™});document.getElementById({chart:â€˜tabChartâ€™,signals:â€˜tabSignalsâ€™,levels:â€˜tabLevelsâ€™,backtest:â€˜tabBacktestâ€™,stats:â€˜tabStatsâ€™}[t]).style.display=â€˜blockâ€™}
function toggleAuto(){autoR=!autoR;var b=document.getElementById(â€˜autoBtnâ€™);if(autoR){b.classList.add(â€˜activeâ€™);b.textContent=â€˜â¸ 30sâ€™;autoI=setInterval(refresh,30000)}else{b.classList.remove(â€˜activeâ€™);b.textContent=â€˜â–¶ Autoâ€™;clearInterval(autoI)}}
async function toggleNotif(){if(!notif){if(â€˜Notificationâ€™in window){var p=await Notification.requestPermission();if(p===â€˜grantedâ€™){notif=true;document.getElementById(â€˜notifBtnâ€™).classList.add(â€˜notifâ€™);showToast(â€˜ğŸ””â€™,â€˜Ativoâ€™)}else showToast(â€˜âš ï¸â€™,â€˜Permite nas definiÃ§Ãµesâ€™)}else showToast(â€˜âš ï¸â€™,â€˜N/Aâ€™)}else{notif=false;document.getElementById(â€˜notifBtnâ€™).classList.remove(â€˜notifâ€™)}}
function openModal(){var ex=[];for(var c in assets)assets[c].forEach(function(a){ex.push(a.s)});var av=presets.filter(function(p){return ex.indexOf(p.s)<0}),cats=[];av.forEach(function(p){if(cats.indexOf(p.c)<0)cats.push(p.c)});var h=â€™â€™;cats.forEach(function(cat){h+=â€™<div style="font-size:8px;color:var(--t3);margin-bottom:4px;text-transform:uppercase">â€™+cat+â€™</div><div class="preset-grid">â€™;av.filter(function(p){return p.c===cat}).forEach(function(p){h+=â€™<button class=â€œasset-btnâ€ onclick=â€œaddPre('â€™+p.s.replace(/â€™/g,â€\â€™â€)+â€™','â€™+p.n+â€™','â€™+p.e+â€™','â€™+p.c+â€™')â€>â€™+p.e+â€™ â€˜+p.n+â€™</button>â€™});h+=â€™</div>â€™});document.getElementById(â€˜presetListâ€™).innerHTML=h;document.getElementById(â€˜modalâ€™).classList.add(â€˜openâ€™)}
function closeModal(){document.getElementById(â€˜modalâ€™).classList.remove(â€˜openâ€™)}
function addPre(s,n,e,c){if(!assets[c])assets[c]=[];assets[c].push({s:s,n:n,e:e});saveA();renderGrid();closeModal()}
function addCustom(){var s=document.getElementById(â€˜customSymâ€™).value.trim().toUpperCase(),n=document.getElementById(â€˜customNameâ€™).value.trim(),c=document.getElementById(â€˜customCatâ€™).value;if(!s||!n)return;if(!assets[c])assets[c]=[];assets[c].push({s:s,n:n,e:â€˜ğŸ“Šâ€™});saveA();renderGrid();closeModal()}
</script>

</body>
</html>