<!DOCTYPE html>

<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CFD Pro">
<meta name="theme-color" content="#060b14">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>CFD Analyzer Pro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Sora:wght@300;400;500;600;700;800&display=swap');
:root{--bg:#060b14;--bg2:#0c1220;--bg3:#111827;--bd:#1c2640;--t:#e2e8f0;--t2:#94a3b8;--t3:#475569;--g:#10b981;--r:#ef4444;--bl:#6366f1;--am:#f59e0b;--cy:#06b6d4;--pu:#a78bfa}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Mono',monospace;background:var(--bg);color:var(--t);min-height:100dvh;padding:env(safe-area-inset-top,12px) 12px 90px;overflow-x:hidden}
h1,h2,h3,.sora{font-family:'Sora',sans-serif}
.setup{max-width:380px;margin:10vh auto;text-align:center;animation:up .5s}
.setup h1{font-size:24px;font-weight:800;margin-bottom:4px;background:linear-gradient(135deg,#e2e8f0,#6366f1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.setup p{color:var(--t3);font-size:11px;margin-bottom:22px}
.si{width:100%;background:var(--bg2);border:1px solid var(--bd);border-radius:11px;padding:13px 15px;color:var(--t);font-family:inherit;font-size:13px;outline:none;margin-bottom:10px}.si:focus{border-color:var(--bl)}
.sb{width:100%;padding:13px;border:none;border-radius:11px;background:linear-gradient(135deg,var(--bl),#8b5cf6);color:#fff;font-family:'Sora',sans-serif;font-size:13px;font-weight:600;cursor:pointer}.sb:active{transform:scale(.97)}
.hint{color:var(--t3);font-size:10px;margin-top:12px;line-height:1.7}.hint a{color:var(--bl)}
#errBox{margin-top:14px;padding:10px 14px;border-radius:10px;font-size:11px;display:none;text-align:left;line-height:1.6}
.d{max-width:900px;margin:0 auto;display:none;animation:up .4s}.d.on{display:block}
.hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 0;flex-wrap:wrap;gap:8px}
.hdr h1{font-size:19px;font-weight:800}.ha{display:flex;gap:4px;align-items:center;flex-wrap:wrap}
.hb{padding:6px 10px;border-radius:7px;border:1px solid var(--bd);background:var(--bg2);color:var(--t2);font-family:inherit;font-size:10px;cursor:pointer;white-space:nowrap}.hb:active{transform:scale(.94)}.hb.on{border-color:var(--g);color:var(--g);background:rgba(16,185,129,.08)}.hb.no{border-color:var(--am);color:var(--am);background:rgba(245,158,11,.08)}
.rb{padding:6px 13px;border-radius:8px;text-align:center;border:1px solid transparent}.rb .rl{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.1em}.rb .rv{font-size:14px;font-weight:700}
.cl{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;margin:9px 0 4px}
.ar{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:2px}
.ab{padding:5px 9px;border-radius:6px;border:1px solid var(--bd);background:var(--bg2);color:var(--t2);font-family:inherit;font-size:10px;cursor:pointer}.ab:active{transform:scale(.93)}.ab.on{border-color:var(--bl);background:rgba(99,102,241,.08);color:var(--t)}
.adb{padding:7px 14px;border-radius:8px;border:1px dashed var(--bd);background:transparent;color:var(--bl);font-family:'Sora',sans-serif;font-size:10px;font-weight:600;cursor:pointer;margin-top:5px}
.pc{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:13px;margin:10px 0;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.pm .sn{font-size:10px;color:var(--t3)}.pm .pr{font-family:'Sora',sans-serif;font-size:26px;font-weight:700}.pm .ch{font-size:11px;font-weight:500}
.ms{display:flex;gap:14px}.me{text-align:center}.me .ml{font-size:7px;color:var(--t3)}.me .mv{font-size:14px;font-weight:600}
.action-box{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:14px;margin:10px 0}
.action-box h3{font-size:13px;font-weight:700;margin-bottom:8px}.action-text{font-size:11px;color:var(--t2);line-height:1.7}.action-text strong{color:var(--t)}
.risk-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.risk-pill{padding:6px 12px;border-radius:8px;font-size:10px;border:1px solid var(--bd);background:var(--bg);text-align:center;flex:1;min-width:70px}
.risk-pill .rpl{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px}.risk-pill .rpv{font-size:13px;font-weight:600}
.tf-row{display:flex;gap:6px;margin:8px 0;align-items:center;flex-wrap:wrap}
.tf-badge{padding:4px 10px;border-radius:6px;font-size:9px;font-weight:600;border:1px solid var(--bd)}.tf-label{font-size:8px;color:var(--t3)}
/* Position tracker */
.pos-box{background:linear-gradient(135deg,rgba(99,102,241,.06),rgba(139,92,246,.06));border:1px solid rgba(99,102,241,.2);border-radius:12px;padding:14px;margin:10px 0}
.pos-box h3{font-size:12px;font-weight:700;margin-bottom:10px}
.pos-card{background:var(--bg);border:1px solid var(--bd);border-radius:10px;padding:11px;margin-bottom:8px}
.pos-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.pos-pnl{font-family:'Sora',sans-serif;font-size:16px;font-weight:700}
.pos-details{font-size:9px;color:var(--t3);line-height:1.6}
.pos-targets{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.pos-target{padding:4px 8px;border-radius:5px;font-size:8px;border:1px solid var(--bd);background:var(--bg2)}
.pos-alert{padding:8px 12px;border-radius:8px;margin-top:8px;font-size:10px;font-weight:600;animation:pu 1.5s infinite}
.pos-btn{padding:8px 14px;border-radius:8px;border:none;font-family:'Sora',sans-serif;font-size:10px;font-weight:600;cursor:pointer;margin-top:6px}
.pos-form{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px}
.pos-form input{background:var(--bg);border:1px solid var(--bd);border-radius:6px;padding:7px 9px;color:var(--t);font-family:inherit;font-size:10px;outline:none}
.pos-form input:focus{border-color:var(--bl)}
.pos-form label{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px;display:block}
/* History */
.hist-item{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid rgba(28,38,64,.2);font-size:9px}
.tgs{display:flex;gap:4px;margin-bottom:9px;flex-wrap:wrap}
.tb{padding:4px 10px;border-radius:5px;border:1px solid var(--bd);background:transparent;color:var(--t3);font-family:inherit;font-size:9px;cursor:pointer}.tb.on{border-color:var(--bl);background:rgba(99,102,241,.1);color:var(--pu)}
.tabs{display:flex;gap:2px;background:var(--bg2);border-radius:8px;padding:2px;width:fit-content;margin-bottom:10px;flex-wrap:wrap}
.tt{padding:5px 14px;border-radius:6px;border:none;background:transparent;color:var(--t3);font-family:inherit;font-size:10px;cursor:pointer;font-weight:500}.tt.on{background:rgba(99,102,241,.1);color:var(--pu)}
.cb{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:10px;margin-bottom:9px}
.cb .cbl{font-size:7px;color:var(--t3);padding-left:5px;margin-bottom:4px;text-transform:uppercase;letter-spacing:.1em}
.sc{display:grid;grid-template-columns:1fr 1fr;gap:9px}@media(max-width:600px){.sc{grid-template-columns:1fr}}
svg{width:100%;height:auto;display:block}
.sg{background:var(--bg2);border:1px solid var(--bd);border-radius:8px;padding:9px 11px;margin-bottom:6px}
.sh{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.st{padding:2px 7px;border-radius:4px;font-size:9px;font-weight:700}
.sd{display:flex;gap:2px;align-items:center}.sdd{width:5px;height:5px;border-radius:50%}
.sr{font-size:8px;color:var(--t3);margin-top:3px}
.lg{display:grid;grid-template-columns:1fr 1fr;gap:9px}@media(max-width:600px){.lg{grid-template-columns:1fr}}
.lb{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:13px}
.lb .lt{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px}
.lr{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(28,38,64,.3);font-size:10px}
.sts{display:flex;align-items:center;gap:4px;font-size:9px;color:var(--t3);margin-bottom:6px}
.dot{width:5px;height:5px;border-radius:50%}.dok{background:var(--g);box-shadow:0 0 4px var(--g)}.doe{background:var(--r)}.dol{background:var(--am);animation:pu 1s infinite}
.ft{margin-top:16px;padding:9px 11px;background:rgba(245,158,11,.03);border:1px solid rgba(245,158,11,.1);border-radius:8px;font-size:8px;color:#92783b;line-height:1.6}
.toast{position:fixed;top:env(safe-area-inset-top,10px);left:50%;transform:translateX(-50%) translateY(-100px);background:var(--bg3);border:1px solid var(--bd);border-radius:11px;padding:11px 16px;z-index:200;transition:transform .4s ease;max-width:88vw;box-shadow:0 6px 25px rgba(0,0,0,.5)}.toast.show{transform:translateX(-50%) translateY(10px)}.toast .tti{font-family:'Sora',sans-serif;font-size:12px;font-weight:600;margin-bottom:2px}.toast .ttb{font-size:9px;color:var(--t2)}
.mo-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);z-index:100;display:none;align-items:center;justify-content:center}.mo-bg.on{display:flex}
.mo{background:var(--bg3);border:1px solid var(--bd);border-radius:16px;padding:20px;width:min(440px,92vw);max-height:76vh;overflow-y:auto}
.mo h2{font-size:17px;font-weight:700;margin-bottom:12px}.mo .xb{float:right;background:none;border:none;color:var(--t3);font-size:18px;cursor:pointer}
.mo .pg{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px}
.mo input,.mo select{width:100%;background:var(--bg);border:1px solid var(--bd);border-radius:7px;padding:8px 11px;color:var(--t);font-family:inherit;font-size:11px;outline:none;margin-bottom:6px}
@keyframes up{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pu{0%,100%{opacity:1}50%{opacity:.3}}
</style>
</head>
<body>
<div class="toast" id="toast"><div class="tti" id="toastT"></div><div class="ttb" id="toastB"></div></div>
<div class="setup" id="setup">
<h1 class="sora">ğŸ“Š CFD Analyzer Pro</h1>
<p>AnÃ¡lise profissional Â· GestÃ£o de posiÃ§Ãµes Â· Multi-timeframe</p>
<input class="si" type="text" id="keyIn" placeholder="Cola a tua Finnhub API Key" autocomplete="off">
<button class="sb" id="enterBtn" onclick="testKey()">Entrar</button>
<div id="errBox"></div>
<div class="hint">Cria grÃ¡tis em <a href="https://finnhub.io/register" target="_blank">finnhub.io/register</a><br>60 req/min Â· 100% grÃ¡tis Â· ğŸ”’ Key no teu dispositivo</div>
</div>
<div class="mo-bg" id="modal"><div class="mo"><button class="xb" onclick="clMo()">Ã—</button><h2 class="sora">Adicionar Ativo</h2><div id="pList"></div>
<div style="margin-top:10px;border-top:1px solid var(--bd);padding-top:10px"><div style="font-size:8px;color:var(--t3);margin-bottom:5px;text-transform:uppercase;letter-spacing:.1em">Personalizado</div>
<div style="display:flex;gap:5px;margin-bottom:5px"><input id="cS" placeholder="SÃ­mbolo (AAPL)"><input id="cN" placeholder="Nome"></div>
<select id="cC"><option value="AÃ§Ãµes">AÃ§Ãµes</option><option value="Commodities">Commodities</option><option value="Forex">Forex</option><option value="Crypto">Crypto</option></select>
<button onclick="addC()" style="width:100%;padding:9px;border:none;border-radius:8px;background:linear-gradient(135deg,var(--bl),#8b5cf6);color:#fff;font-family:'Sora',sans-serif;font-size:11px;font-weight:600;cursor:pointer">Adicionar</button>
</div></div></div>
<div class="d" id="dash">
<div class="hdr"><div><h1>CFD Analyzer <span style="font-size:11px;color:var(--pu);font-weight:400">Pro</span></h1>
<div class="sts" id="sts"><span class="dot dol"></span> A conectar...</div></div>
<div class="ha">
<button class="hb" onclick="refresh()">â†»</button>
<button class="hb" onclick="debugAPI()" style="color:var(--am)">ğŸ›</button>
<button class="hb" id="abtn" onclick="togAuto()">â–¶ Auto</button>
<button class="hb" id="nbtn" onclick="togNotif()">ğŸ””</button>
<div class="rb" id="rB"><div class="rl">RecomendaÃ§Ã£o</div><div class="rv sora" id="rV">â€”</div></div>
</div></div>
<div id="aGrid"></div>
<button class="adb" onclick="opMo()">+ Adicionar Ativo</button>
<div class="pc"><div class="pm"><div class="sn" id="pN">â€”</div><div class="pr" id="pP">â€”</div><div class="ch" id="pC">â€”</div></div>
<div class="ms"><div class="me"><div class="ml">RSI</div><div class="mv" id="mR">â€”</div></div>
<div class="me"><div class="ml">MACD</div><div class="mv" id="mM">â€”</div></div>
<div class="me"><div class="ml">Conf.</div><div class="mv" id="mCf">â€”</div></div></div></div>
<div id="posSection"></div>
<div class="action-box" id="actionBox"><h3 id="actTitle">ğŸ“‹ A analisar...</h3><div class="tf-row" id="tfRow"></div><div class="action-text" id="actText">A carregar...</div><div class="risk-row" id="riskRow"></div></div>
<div class="tgs"><button class="tb on" id="tS" onclick="tgl('s')">SMA 20/50</button><button class="tb on" id="tB" onclick="tgl('b')">Bollinger</button><button class="tb" id="tF" onclick="tgl('f')">Fibonacci</button></div>
<div class="tabs"><button class="tt on" onclick="stab('c',this)">GrÃ¡fico</button><button class="tt" onclick="stab('s',this)">Sinais</button><button class="tt" onclick="stab('l',this)">NÃ­veis</button><button class="tt" onclick="stab('h',this)">HistÃ³rico</button></div>
<div id="vc"><div class="cb"><div class="cbl">PreÃ§o Â· Velas</div><div id="mC"></div></div>
<div class="sc"><div class="cb"><div class="cbl">RSI (14)</div><div id="rC"></div></div><div class="cb"><div class="cbl">MACD (12,26,9)</div><div id="maC"></div></div></div></div>
<div id="vs" style="display:none"></div>
<div id="vl" style="display:none"></div>
<div id="vh" style="display:none"></div>
<div class="ft">âš ï¸ <strong>Aviso:</strong> AnÃ¡lise tÃ©cnica automatizada para apoio a decisÃµes. NÃ£o garante resultados. CFDs envolvem risco significativo.</div>
</div>
<script>
var K='',sel='AAPL',shS=true,shB=true,shF=false,aR=false,aI=null,nO=false,prevSig={};
var MIN_SIG=3,curPrice=0,curDP=2;

// Positions: {id, symbol, type:â€˜BUYâ€™|â€˜SELLâ€™, units, entryPrice, entryDate, sl, tp, tp2, closed, exitPrice, exitDate}
var positions=[];
var tradeHistory=[];

var A={â€œAÃ§Ãµesâ€:[
{s:â€œAAPLâ€,n:â€œAppleâ€,e:â€œğŸâ€,t:â€œsâ€},{s:â€œMSFTâ€,n:â€œMicrosoftâ€,e:â€œğŸªŸâ€,t:â€œsâ€},
{s:â€œGOOGLâ€,n:â€œAlphabetâ€,e:â€œğŸ”â€,t:â€œsâ€},{s:â€œTSLAâ€,n:â€œTeslaâ€,e:â€œâš¡â€,t:â€œsâ€},
{s:â€œAMZNâ€,n:â€œAmazonâ€,e:â€œğŸ“¦â€,t:â€œsâ€},{s:â€œNVDAâ€,n:â€œNvidiaâ€,e:â€œğŸŸ¢â€,t:â€œsâ€}]};
var PRE=[
{s:â€œMETAâ€,n:â€œMetaâ€,e:â€œğŸŒâ€,c:â€œAÃ§Ãµesâ€,t:â€œsâ€},{s:â€œAMDâ€,n:â€œAMDâ€,e:â€œğŸ”´â€,c:â€œAÃ§Ãµesâ€,t:â€œsâ€},
{s:â€œNFLXâ€,n:â€œNetflixâ€,e:â€œğŸ¬â€,c:â€œAÃ§Ãµesâ€,t:â€œsâ€},{s:â€œJPMâ€,n:â€œJP Morganâ€,e:â€œğŸ¦â€,c:â€œAÃ§Ãµesâ€,t:â€œsâ€},
{s:â€œBAâ€,n:â€œBoeingâ€,e:â€œâœˆï¸â€,c:â€œAÃ§Ãµesâ€,t:â€œsâ€},{s:â€œDISâ€,n:â€œDisneyâ€,e:â€œğŸ°â€,c:â€œAÃ§Ãµesâ€,t:â€œsâ€},
{s:â€œVâ€,n:â€œVisaâ€,e:â€œğŸ’³â€,c:â€œAÃ§Ãµesâ€,t:â€œsâ€},{s:â€œNKEâ€,n:â€œNikeâ€,e:â€œğŸ‘Ÿâ€,c:â€œAÃ§Ãµesâ€,t:â€œsâ€},
{s:â€œOANDA:XAU_USDâ€,n:â€œOuroâ€,e:â€œğŸ¥‡â€,c:â€œCommoditiesâ€,t:â€œfâ€},
{s:â€œOANDA:XAG_USDâ€,n:â€œPrataâ€,e:â€œğŸ¥ˆâ€,c:â€œCommoditiesâ€,t:â€œfâ€},
{s:â€œOANDA:BCO_USDâ€,n:â€œPetrÃ³leoâ€,e:â€œğŸ›¢ï¸â€,c:â€œCommoditiesâ€,t:â€œfâ€},
{s:â€œOANDA:EUR_USDâ€,n:â€œEUR/USDâ€,e:â€œğŸ’¶â€,c:â€œForexâ€,t:â€œfâ€},
{s:â€œOANDA:GBP_USDâ€,n:â€œGBP/USDâ€,e:â€œğŸ’·â€,c:â€œForexâ€,t:â€œfâ€},
{s:â€œBINANCE:BTCUSDTâ€,n:â€œBitcoinâ€,e:â€œâ‚¿â€,c:â€œCryptoâ€,t:â€œcâ€},
{s:â€œBINANCE:ETHUSDTâ€,n:â€œEthereumâ€,e:â€œâŸ â€,c:â€œCryptoâ€,t:â€œcâ€},
{s:â€œBINANCE:SOLUSDTâ€,n:â€œSolanaâ€,e:â€œâ—â€,c:â€œCryptoâ€,t:â€œcâ€}];

try{var k=localStorage.getItem(â€˜fhkâ€™);if(k)document.getElementById(â€˜keyInâ€™).value=k}catch(e){}
try{var a=localStorage.getItem(â€˜fha4â€™);if(a)A=JSON.parse(a)}catch(e){}
try{var s=localStorage.getItem(â€˜fhsâ€™);if(s)sel=s}catch(e){}
try{var p=localStorage.getItem(â€˜fhposâ€™);if(p)positions=JSON.parse(p)}catch(e){}
try{var h=localStorage.getItem(â€˜fhhistâ€™);if(h)tradeHistory=JSON.parse(h)}catch(e){}
function save(){try{localStorage.setItem(â€˜fha4â€™,JSON.stringify(A));localStorage.setItem(â€˜fhsâ€™,sel)}catch(e){}}
function savePos(){try{localStorage.setItem(â€˜fhposâ€™,JSON.stringify(positions));localStorage.setItem(â€˜fhhistâ€™,JSON.stringify(tradeHistory))}catch(e){}}
if(â€˜serviceWorkerâ€™in navigator)navigator.serviceWorker.register(â€˜sw.jsâ€™).catch(function(){});

async function testKey(){
var k=document.getElementById(â€˜keyInâ€™).value.trim(),err=document.getElementById(â€˜errBoxâ€™),btn=document.getElementById(â€˜enterBtnâ€™);
if(!k){err.style.display=â€˜blockâ€™;err.style.background=â€˜rgba(239,68,68,.08)â€™;err.style.color=â€™#f87171â€™;err.textContent=â€˜Introduz a API key.â€™;return}
btn.textContent=â€˜A testarâ€¦â€™;btn.disabled=true;
try{var r=await fetch(â€˜https://finnhub.io/api/v1/quote?symbol=AAPL&token=â€™+k);
if(r.status===401||r.status===403){err.style.display=â€˜blockâ€™;err.style.background=â€˜rgba(239,68,68,.08)â€™;err.style.color=â€™#f87171â€™;err.textContent=â€˜Key invÃ¡lida.â€™;btn.textContent=â€˜Entrarâ€™;btn.disabled=false;return}
var d=await r.json();
if(d&&d.c>0){K=k;try{localStorage.setItem(â€˜fhkâ€™,k)}catch(e){}document.getElementById(â€˜setupâ€™).style.display=â€˜noneâ€™;document.getElementById(â€˜dashâ€™).classList.add(â€˜onâ€™);renderA();refresh()}
else{err.style.display=â€˜blockâ€™;err.style.background=â€˜rgba(245,158,11,.08)â€™;err.style.color=â€™#fbbf24â€™;err.textContent=â€˜Resposta inesperada: â€˜+JSON.stringify(d).slice(0,100);btn.textContent=â€˜Entrarâ€™;btn.disabled=false}
}catch(e){err.style.display=â€˜blockâ€™;err.style.background=â€˜rgba(239,68,68,.08)â€™;err.style.color=â€™#f87171â€™;err.textContent=â€™Erro: â€™+e.message;btn.textContent=â€˜Entrarâ€™;btn.disabled=false}}

async function api(ep,p){p=p||{};var u=new URL(â€˜https://finnhub.io/api/v1â€™+ep);u.searchParams.set(â€˜tokenâ€™,K);for(var k in p)u.searchParams.set(k,p[k]);try{var r=await fetch(u);if(!r.ok)return null;return r.json()}catch(e){return null}}
async function getCandles(sym,type,res,days){
var to=Math.floor(Date.now()/1000),from=to-(days||200)*86400;
var ep=type===â€˜fâ€™?â€™/forex/candleâ€™:type===â€˜câ€™?â€™/crypto/candleâ€™:â€™/stock/candleâ€™;
var d=await api(ep,{symbol:sym,resolution:res||â€˜Dâ€™,from:from,to:to});
if(!d){console.log(â€˜API null forâ€™,sym);return null}
if(d.s===â€˜no_dataâ€™){console.log(â€˜no_data forâ€™,sym,ep,res);return null}
if(!d.c||!d.c.length){console.log(â€˜Empty candles forâ€™,sym,JSON.stringify(d).slice(0,200));return null}
return d.c.map(function(c,i){return{date:new Date(d.t[i]*1000).toISOString().split(â€˜Tâ€™)[0],open:d.o[i],high:d.h[i],low:d.l[i],close:c,volume:d.v?d.v[i]||0:0}})}
async function getQuote(sym){return api(â€™/quoteâ€™,{symbol:sym})}

// â•â•â• INDICATORS â•â•â•
var *SMA=function(d,n){return d.map(function(*,i){if(i<n-1)return null;var s=0;for(var j=i-n+1;j<=i;j++)s+=d[j].close;return s/n})};
var _EMA=function(d,n){var k=2/(n+1),r=[],p=null;d.forEach(function(x,i){if(i<n-1){r.push(null);return}if(p===null){var s=0;for(var j=0;j<n;j++)s+=d[j].close;p=s/n}else p=x.close*k+p*(1-k);r.push(p)});return r};
function _RSI(d,n){n=n||14;var r=[],ag=0,al=0;for(var i=0;i<d.length;i++){if(!i){r.push(null);continue}var c=d[i].close-d[i-1].close,g=c>0?c:0,l=c<0?-c:0;if(i<=n){ag+=g;al+=l;if(i===n){ag/=n;al/=n;r.push(al===0?100:+(100-100/(1+ag/al)).toFixed(2))}else r.push(null)}else{ag=(ag*(n-1)+g)/n;al=(al*(n-1)+l)/n;r.push(al===0?100:+(100-100/(1+ag/al)).toFixed(2))}}return r}
function _MACD(d){var e12=_EMA(d,12),e26=_EMA(d,26);var ml=e12.map(function(v,i){return(v!=null&&e26[i]!=null)?v-e26[i]:null});var k=2/10,sg=null;var sl=ml.map(function(v){if(v==null)return null;sg=sg==null?v:v*k+sg*(1-k);return sg});var h=ml.map(function(v,i){return(v!=null&&sl[i]!=null)?v-sl[i]:null});return{ml:ml,sl:sl,h:h}}
function *BOLL(d,n,m){n=n||20;m=m||2;return d.map(function(*,i){if(i<n-1)return{u:null,l:null};var s=d.slice(i-n+1,i+1).map(function(x){return x.close});var mn=s.reduce(function(a,v){return a+v},0)/n;var st=Math.sqrt(s.reduce(function(a,v){return a+(v-mn)*(v-mn)},0)/n);return{u:mn+m*st,l:mn-m*st}})}
function _FIB(d){var mx=-Infinity,mn=Infinity;d.forEach(function(x){if(x.high>mx)mx=x.high;if(x.low<mn)mn=x.low});var df=mx-mn;return{â€œ0%â€:mx,â€œ23.6%â€:mx-df*.236,â€œ38.2%â€:mx-df*.382,â€œ50%â€:mx-df*.5,â€œ61.8%â€:mx-df*.618,â€œ78.6%â€:mx-df*.786,â€œ100%â€:mn}}
function _SR(d){var s=d.slice(-40).map(function(x){return x.close}).sort(function(a,b){return a-b}),l=s.length;return{suporteForte:s[Math.floor(l*.05)],suporte:s[Math.floor(l*.2)],resistencia:s[Math.floor(l*.8)],resistenciaForte:s[Math.floor(l*.95)]}}
function _ATR(d,n){n=n||14;var r=[];for(var i=0;i<d.length;i++){if(i===0){r.push(null);continue}var tr=Math.max(d[i].high-d[i].low,Math.abs(d[i].high-d[i-1].close),Math.abs(d[i].low-d[i-1].close));if(i<n){r.push(null);continue}if(i===n){var s=0;for(var j=1;j<=n;j++){s+=Math.max(d[j].high-d[j].low,Math.abs(d[j].high-d[j-1].close),Math.abs(d[j].low-d[j-1].close))}r.push(s/n)}else{r.push((r[i-1]*(n-1)+tr)/n)}}return r}
function _ADX(d,n){n=n||14;var r=[];for(var i=0;i<d.length;i++){if(i<n*2){r.push(null);continue}var sl=d.slice(i-n*2,i+1),pDM=0,nDM=0,tr=0;for(var j=1;j<sl.length;j++){var up=sl[j].high-sl[j-1].high,dn=sl[j-1].low-sl[j].low;pDM+=(up>dn&&up>0)?up:0;nDM+=(dn>up&&dn>0)?dn:0;tr+=Math.max(sl[j].high-sl[j].low,Math.abs(sl[j].high-sl[j-1].close),Math.abs(sl[j].low-sl[j-1].close))}if(tr===0){r.push(0);continue}var pDI=100*pDM/tr,nDI=100*nDM/tr;r.push(+((Math.abs(pDI-nDI)/(pDI+nDI||1))*100).toFixed(1))}return r}

// â•â•â• SIGNAL ENGINE â•â•â•
function _SIGS(d,rsi,macd,boll,s20,s50,atr,adx){var sg=[];
for(var i=2;i<d.length;i++){var sc=0,re=[],conf=0,total=0;
if(rsi[i]!=null&&rsi[i-1]!=null){total++;
if(rsi[i]<30){sc+=2;re.push(â€œRSI sobrevendido (â€+rsi[i].toFixed(0)+â€)â€);conf++}
else if(rsi[i]>70){sc-=2;re.push(â€œRSI sobrecomprado (â€+rsi[i].toFixed(0)+â€)â€);conf++}
else if(rsi[i]<40&&rsi[i]>rsi[i-1]){sc+=1;re.push(â€œRSI â†‘â€);conf+=.5}
else if(rsi[i]>60&&rsi[i]<rsi[i-1]){sc-=1;re.push(â€œRSI â†“â€);conf+=.5}}
if(macd.ml[i]!=null&&macd.sl[i]!=null&&macd.ml[i-1]!=null&&macd.sl[i-1]!=null){total++;
if(macd.ml[i]>macd.sl[i]&&macd.ml[i-1]<=macd.sl[i-1]){sc+=2;re.push(â€œMACD â†‘â€);conf++;if(macd.h[i]!=null&&macd.h[i-1]!=null&&Math.abs(macd.h[i])>Math.abs(macd.h[i-1])){sc+=1;re.push(â€œHistograma +â€)}}
if(macd.ml[i]<macd.sl[i]&&macd.ml[i-1]>=macd.sl[i-1]){sc-=2;re.push(â€œMACD â†“â€);conf++;if(macd.h[i]!=null&&macd.h[i-1]!=null&&Math.abs(macd.h[i])>Math.abs(macd.h[i-1])){sc-=1;re.push(â€œHistograma +â€)}}}
if(boll[i].l!=null){total++;if(d[i].close<=boll[i].l){sc+=2;re.push(â€œBollinger â†“â€);conf++}if(d[i].close>=boll[i].u){sc-=2;re.push(â€œBollinger â†‘â€);conf++}}
if(s20[i]!=null&&s50[i]!=null&&s20[i-1]!=null&&s50[i-1]!=null){total++;
if(s20[i]>s50[i]&&s20[i-1]<=s50[i-1]){sc+=2;re.push(â€œGolden Crossâ€);conf++}
if(s20[i]<s50[i]&&s20[i-1]>=s50[i-1]){sc-=2;re.push(â€œDeath Crossâ€);conf++}
if(d[i].close>s20[i]&&s20[i]>s50[i]){sc+=1;re.push(â€œTendÃªncia â†‘â€)}
if(d[i].close<s20[i]&&s20[i]<s50[i]){sc-=1;re.push(â€œTendÃªncia â†“â€)}}
if(i>=10&&d[i].volume>0){var av=0;for(var j=i-10;j<i;j++)av+=d[j].volume;av/=10;
if(av>0&&d[i].volume>av*1.8){var dir=d[i].close>d[i].open?1:-1;sc+=dir;re.push(dir>0?â€œVol â†‘â€:â€œVol â†“â€);conf+=.5}}
var adxV=adx[i];if(adxV!=null){if(adxV>25&&Math.abs(sc)>=2){sc+=sc>0?1:-1;re.push(â€œADX forte:â€+adxV)}
if(adxV<15&&Math.abs(sc)>=2){sc=Math.round(sc*.6);re.push(â€œADX fraco:â€+adxV)}}
var confPct=total>0?Math.round((conf/total)*100):0;
if(Math.abs(sc)>=MIN_SIG){var atrV=atr[i],sl=null,tp=null,tp2=null;
if(atrV){if(sc>0){sl=d[i].close-atrV*1.5;tp=d[i].close+atrV*2;tp2=d[i].close+atrV*3}else{sl=d[i].close+atrV*1.5;tp=d[i].close-atrV*2;tp2=d[i].close-atrV*3}}
sg.push({idx:i,date:d[i].date,price:d[i].close,type:sc>0?â€œBUYâ€:â€œSELLâ€,str:Math.min(Math.abs(sc),8),reasons:re,conf:confPct,sl:sl,tp:tp,tp2:tp2,atr:atrV})}}return sg}

function analyzeTF(candles,label){if(!candles||candles.length<30)return{label:label,bias:â€˜Neutroâ€™,details:â€˜Dados insuficientesâ€™,score:0};
var s20=_SMA(candles,20),s50=_SMA(candles,50),rsi=_RSI(candles);var last=candles.length-1,lp=candles[last].close,score=0,notes=[];
if(s20[last]!=null&&s50[last]!=null){if(s20[last]>s50[last]&&lp>s20[last]){score+=2;notes.push(â€˜â†‘â€™)}else if(s20[last]<s50[last]&&lp<s20[last]){score-=2;notes.push(â€˜â†“â€™)}else notes.push(â€˜Lateralâ€™)}
var lRSI=null;for(var i=rsi.length-1;i>=0;iâ€“){if(rsi[i]!=null){lRSI=rsi[i];break}}
if(lRSI!=null){if(lRSI<30){score+=1;notes.push(â€™RSI â€™+lRSI.toFixed(0))}else if(lRSI>70){score-=1;notes.push(â€™RSI â€™+lRSI.toFixed(0))}else notes.push(â€™RSI â€˜+lRSI.toFixed(0))}
return{label:label,bias:score>1?â€˜Bullishâ€™:score<-1?â€˜Bearishâ€™:â€˜Neutroâ€™,details:notes.join(â€™ Â· â€™),score:score}}

// â•â•â• POSITION MANAGER â•â•â•
function openPosition(type,units,price,sl,tp,tp2){
var pos={id:Date.now(),symbol:sel,type:type,units:parseFloat(units),entryPrice:parseFloat(price),
entryDate:new Date().toISOString().split(â€˜Tâ€™)[0],sl:sl?parseFloat(sl):null,tp:tp?parseFloat(tp):null,tp2:tp2?parseFloat(tp2):null,closed:false};
positions.push(pos);savePos();renderPos();toast(â€˜ğŸ“Š PosiÃ§Ã£o abertaâ€™,type+â€™ â€™+units+â€™x â€˜+sel+â€™ @ â€™+price)}

function closePosition(id,exitPrice){
var pos=positions.find(function(p){return p.id===id});if(!pos)return;
pos.closed=true;pos.exitPrice=exitPrice||curPrice;pos.exitDate=new Date().toISOString().split(â€˜Tâ€™)[0];
var pnl=pos.type===â€˜BUYâ€™?(pos.exitPrice-pos.entryPrice)*pos.units:(pos.entryPrice-pos.exitPrice)*pos.units;
tradeHistory.push({symbol:pos.symbol,type:pos.type,units:pos.units,entry:pos.entryPrice,exit:pos.exitPrice,
entryDate:pos.entryDate,exitDate:pos.exitDate,pnl:+pnl.toFixed(2)});
positions=positions.filter(function(p){return p.id!==id});savePos();renderPos();renderHist();
toast(pnl>=0?â€˜ğŸ’° Lucro!â€™:â€˜ğŸ“‰ Perdaâ€™,(pnl>=0?â€™+â€™:â€™â€™)+pnl.toFixed(2))}

function checkPositionAlerts(price){
positions.forEach(function(pos){if(pos.closed||pos.symbol!==sel)return;
if(pos.sl!=null){if((pos.type===â€˜BUYâ€™&&price<=pos.sl)||(pos.type===â€˜SELLâ€™&&price>=pos.sl)){
toast(â€˜ğŸš¨ STOP-LOSS atingido!â€™,pos.symbol+â€™ @ â€˜+price.toFixed(curDP)+â€™ â€” Fechar posiÃ§Ã£o!â€™);
if(nO)try{new Notification(â€™ğŸš¨ STOP-LOSS â€” â€™+pos.symbol,{body:â€™PreÃ§o: â€˜+price.toFixed(curDP)+â€™ | SL: â€˜+pos.sl.toFixed(curDP)})}catch(e){}}}
if(pos.tp!=null){if((pos.type===â€˜BUYâ€™&&price>=pos.tp)||(pos.type===â€˜SELLâ€™&&price<=pos.tp)){
toast(â€˜ğŸ¯ TAKE-PROFIT 1 atingido!â€™,pos.symbol+â€™ @ â€™+price.toFixed(curDP));
if(nO)try{new Notification(â€™ğŸ¯ TP1 â€” â€™+pos.symbol,{body:â€™PreÃ§o: â€˜+price.toFixed(curDP)+â€™ | TP: â€˜+pos.tp.toFixed(curDP)})}catch(e){}}}
if(pos.tp2!=null){if((pos.type===â€˜BUYâ€™&&price>=pos.tp2)||(pos.type===â€˜SELLâ€™&&price<=pos.tp2)){
toast(â€˜ğŸ¯ğŸ¯ TAKE-PROFIT 2 atingido!â€™,pos.symbol+â€™ @ â€™+price.toFixed(curDP));
if(nO)try{new Notification(â€™ğŸ¯ğŸ¯ TP2 â€” â€™+pos.symbol,{body:â€™PreÃ§o: â€™+price.toFixed(curDP)})}catch(e){}}}})}

function renderPos(){
var myPos=positions.filter(function(p){return p.symbol===sel&&!p.closed});
if(!myPos.length){document.getElementById(â€˜posSectionâ€™).innerHTML=â€™<div style="margin:8px 0"><button class="pos-btn" style="background:linear-gradient(135deg,var(--g),#059669);color:#fff;width:100%" onclick="showPosForm()">ğŸ“Š Registar PosiÃ§Ã£o</button></div>â€™;return}
var h=â€™<div class="pos-box"><h3>ğŸ“Š PosiÃ§Ãµes Abertas</h3>â€™;
myPos.forEach(function(pos){
var pnl=pos.type===â€˜BUYâ€™?(curPrice-pos.entryPrice)*pos.units:(pos.entryPrice-curPrice)*pos.units;
var pnlPct=((pos.type===â€˜BUYâ€™?(curPrice-pos.entryPrice):(pos.entryPrice-curPrice))/pos.entryPrice*100);
var isProfit=pnl>=0;
h+=â€™<div class="pos-card"><div class="pos-header"><div><span style="font-size:9px;padding:2px 6px;border-radius:4px;background:'+(pos.type==='BUY'?'rgba(16,185,129,.1);color:var(--g)':'rgba(239,68,68,.1);color:var(--r)')+'">â€™+pos.type+â€™</span> <span style="font-size:10px;color:var(--t2)">â€™+pos.units+â€˜x @ â€˜+pos.entryPrice.toFixed(curDP)+â€™</span></div>â€™;
h+=â€™<div class="pos-pnl" style="color:'+(isProfit?'var(--g)':'var(--r)')+'">â‚¬â€™+(pnl>=0?â€™+â€™:â€™â€™)+pnl.toFixed(2)+â€™ (â€™+(pnlPct>=0?â€™+â€™:â€™â€™)+pnlPct.toFixed(2)+â€™%)</div></div>â€™;
h+=â€™<div class="pos-details">Aberta: â€˜+pos.entryDate+â€™ Â· PreÃ§o atual: â€˜+curPrice.toFixed(curDP)+â€™</div>â€™;
h+=â€™<div class="pos-targets">â€™;
if(pos.sl!=null){var slHit=(pos.type===â€˜BUYâ€™&&curPrice<=pos.sl)||(pos.type===â€˜SELLâ€™&&curPrice>=pos.sl);
h+=â€™<span class="pos-target" style="'+(slHit?'border-color:var(--r);color:var(--r);animation:pu 1s infinite':'')+'">SL: â€˜+pos.sl.toFixed(curDP)+â€™</span>â€™}
if(pos.tp!=null){var tpHit=(pos.type===â€˜BUYâ€™&&curPrice>=pos.tp)||(pos.type===â€˜SELLâ€™&&curPrice<=pos.tp);
h+=â€™<span class="pos-target" style="'+(tpHit?'border-color:var(--g);color:var(--g);animation:pu 1s infinite':'')+'">TP1: â€˜+pos.tp.toFixed(curDP)+â€™</span>â€™}
if(pos.tp2!=null)h+=â€™<span class="pos-target">TP2: â€˜+pos.tp2.toFixed(curDP)+â€™</span>â€™;
h+=â€™</div>â€™;
// Alert if SL or TP hit
if(pos.sl!=null&&((pos.type===â€˜BUYâ€™&&curPrice<=pos.sl)||(pos.type===â€˜SELLâ€™&&curPrice>=pos.sl)))
h+=â€™<div class="pos-alert" style="background:rgba(239,68,68,.1);color:var(--r);border:1px solid rgba(239,68,68,.3)">ğŸš¨ STOP-LOSS ATINGIDO â€” Considere fechar!</div>â€™;
if(pos.tp!=null&&((pos.type===â€˜BUYâ€™&&curPrice>=pos.tp)||(pos.type===â€˜SELLâ€™&&curPrice<=pos.tp)))
h+=â€™<div class="pos-alert" style="background:rgba(16,185,129,.1);color:var(--g);border:1px solid rgba(16,185,129,.3)">ğŸ¯ TAKE-PROFIT ATINGIDO â€” Considere fechar!</div>â€™;
h+=â€™<div style="display:flex;gap:6px;margin-top:8px"><button class="pos-btn" style="background:rgba(239,68,68,.1);color:var(--r);border:1px solid rgba(239,68,68,.2);flex:1" onclick="closePosition('+pos.id+')">Fechar PosiÃ§Ã£o</button></div>â€™;
h+=â€™</div>â€™});
h+=â€™<button class="pos-btn" style="background:linear-gradient(135deg,var(--bl),#8b5cf6);color:#fff;width:100%;margin-top:4px" onclick="showPosForm()">+ Nova PosiÃ§Ã£o</button></div>â€™;
document.getElementById(â€˜posSectionâ€™).innerHTML=h}

function showPosForm(){
var info=getI(sel);var lastSig=null;
// Get recommended SL/TP from last signal
var recSL=â€™â€™,recTP=â€™â€™,recTP2=â€™â€™;
document.getElementById(â€˜posSectionâ€™).innerHTML=â€™<div class="pos-box"><h3>ğŸ“Š Registar PosiÃ§Ã£o â€” â€˜+info.e+â€™ â€˜+info.n+â€™</h3>â€™
+â€™<div class="pos-form">â€™
+â€™<div><label>Tipo</label><select id="pfType" style="width:100%;background:var(--bg);border:1px solid var(--bd);border-radius:6px;padding:7px;color:var(--t);font-family:inherit;font-size:10px"><option value="BUY">COMPRA (Long)</option><option value="SELL">VENDA (Short)</option></select></div>â€™
+â€™<div><label>Unidades</label><input id="pfUnits" type="number" placeholder="ex: 10" step="any"></div>â€™
+â€™<div><label>PreÃ§o Entrada</label><input id="pfPrice" type="number" placeholder="'+curPrice.toFixed(curDP)+'" step="any" value="'+curPrice.toFixed(curDP)+'"></div>â€™
+â€™<div><label>Data</label><input id="pfDate" type="date" value="'+new Date().toISOString().split('T')[0]+'"></div>â€™
+â€™<div><label>Stop-Loss</label><input id="pfSL" type="number" placeholder="Opcional" step="any"></div>â€™
+â€™<div><label>Take-Profit</label><input id="pfTP" type="number" placeholder="Opcional" step="any"></div>â€™
+â€™</div>â€™
+â€™<div style="display:flex;gap:6px;margin-top:10px">â€™
+â€™<button class="pos-btn" style="background:linear-gradient(135deg,var(--g),#059669);color:#fff;flex:1" onclick="submitPos()">Confirmar</button>â€™
+â€™<button class="pos-btn" style="background:var(--bg);color:var(--t3);border:1px solid var(--bd);flex:1" onclick="renderPos()">Cancelar</button>â€™
+â€™</div></div>â€™}

function submitPos(){
var type=document.getElementById(â€˜pfTypeâ€™).value;
var units=document.getElementById(â€˜pfUnitsâ€™).value;
var price=document.getElementById(â€˜pfPriceâ€™).value;
var sl=document.getElementById(â€˜pfSLâ€™).value;
var tp=document.getElementById(â€˜pfTPâ€™).value;
if(!units||!price||parseFloat(units)<=0){toast(â€˜âš ï¸â€™,â€˜Preenche unidades e preÃ§oâ€™);return}
openPosition(type,units,price,sl||null,tp||null,null)}

function renderHist(){
var symHist=tradeHistory.filter(function(t){return t.symbol===sel});
var allHist=tradeHistory.slice(-20).reverse();
var totalPnl=tradeHistory.reduce(function(s,t){return s+t.pnl},0);
var wins=tradeHistory.filter(function(t){return t.pnl>0}).length;
var total=tradeHistory.length;
var h=â€™<div class="lb"><div class="lt">HistÃ³rico de Trades</div>â€™;
if(!total){h+=â€™<div style="font-size:10px;color:var(--t3);padding:10px 0">Nenhum trade fechado.</div>â€™}
else{
h+=â€™<div style="display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap">â€™;
h+=â€™<div class="risk-pill"><div class="rpl">P&L Total</div><div class="rpv" style="color:'+(totalPnl>=0?'var(--g)':'var(--r)');'">â€™+(totalPnl>=0?â€™+â€™:â€™â€™)+totalPnl.toFixed(2)+â€™</div></div>â€™;
h+=â€™<div class="risk-pill"><div class="rpl">Win Rate</div><div class="rpv" style="color:'+(wins/total>.5?'var(--g)':'var(--am)')+'">â€™+Math.round(wins/total*100)+â€™%</div></div>â€™;
h+=â€™<div class="risk-pill"><div class="rpl">Trades</div><div class="rpv">â€™+total+â€™</div></div></div>â€™;
allHist.forEach(function(t){
h+=â€™<div class="hist-item"><div><span style="color:'+(t.type==='BUY'?'var(--g)':'var(--r)')+'">â€™+t.type+â€™</span> â€˜+t.symbol+â€™ â€˜+t.units+â€˜x</div>â€™;
h+=â€™<div style="text-align:right"><div style="color:'+(t.pnl>=0?'var(--g)':'var(--r)')+'">â€™+(t.pnl>=0?â€™+â€™:â€™â€™)+t.pnl.toFixed(2)+â€™</div>â€™;
h+=â€™<div style="font-size:7px;color:var(--t3)">â€™+t.entry.toFixed(2)+â€™ â†’ â€˜+t.exit.toFixed(2)+â€™ Â· â€˜+t.exitDate+â€™</div></div></div>â€™})}
h+=â€™</div>â€™;document.getElementById(â€˜vhâ€™).innerHTML=h}

// â•â•â• ACTION SUMMARY â•â•â•
function genAction(info,lp,dp,sigs,sr,fib,atr,dailyTF,weeklyTF){
var lastSig=sigs.length?sigs[sigs.length-1]:null;
var lATR=null;for(var i=atr.length-1;i>=0;iâ€“){if(atr[i]!=null){lATR=atr[i];break}}
var tfHTML=â€™<span class="tf-label">Timeframes:</span>â€™;
[dailyTF,weeklyTF].forEach(function(tf){if(!tf)return;
var c=tf.bias===â€˜Bullishâ€™?â€˜var(â€“g)â€™:tf.bias===â€˜Bearishâ€™?â€˜var(â€“r)â€™:â€˜var(â€“t3)â€™;
var bg=tf.bias===â€˜Bullishâ€™?â€˜rgba(16,185,129,.08)â€™:tf.bias===â€˜Bearishâ€™?â€˜rgba(239,68,68,.08)â€™:â€˜rgba(71,85,105,.08)â€™;
tfHTML+=â€™<span class="tf-badge" style="color:'+c+';background:'+bg+'">â€™+tf.label+â€™: â€˜+tf.bias+â€™</span>â€™});
document.getElementById(â€˜tfRowâ€™).innerHTML=tfHTML;
var aligned=dailyTF&&weeklyTF&&dailyTF.bias===weeklyTF.bias&&dailyTF.bias!==â€˜Neutroâ€™;
var conflicting=dailyTF&&weeklyTF&&((dailyTF.bias===â€˜Bullishâ€™&&weeklyTF.bias===â€˜Bearishâ€™)||(dailyTF.bias===â€˜Bearishâ€™&&weeklyTF.bias===â€˜Bullishâ€™));
var title=â€™â€™,text=â€™â€™,emoji=â€˜ğŸ“‹â€™,slP=null,tpP=null,tp2P=null;
var recent=lastSig&&lastSig.idx>=sigs[0].idx+sigs.length-5;
if(recent){var isBuy=lastSig.type===â€˜BUYâ€™;emoji=isBuy?â€˜ğŸŸ¢â€™:â€˜ğŸ”´â€™;title=(isBuy?â€˜COMPRAâ€™:â€˜VENDAâ€™)+â€™ â€” â€˜+info.n;
slP=lastSig.sl;tpP=lastSig.tp;tp2P=lastSig.tp2;
text=â€™<strong>Sinal de â€˜+(isBuy?â€˜compraâ€™:â€˜vendaâ€™)+â€™</strong> a <strong>â€™+lastSig.price.toFixed(dp)+â€™</strong> Â· ForÃ§a â€˜+lastSig.str+â€™/8 Â· â€˜+lastSig.conf+â€™% confirmaÃ§Ã£o.â€™;
text+=â€™<br><br><strong>RazÃµes:</strong> â€˜+lastSig.reasons.join(â€™, â€˜)+â€™.â€™;
if(aligned)text+=â€™<br><br>âœ… <strong>Timeframes alinhados</strong> â€” sinal fiÃ¡vel.â€™;
else if(conflicting)text+=â€™<br><br>âš ï¸ <strong>Conflito de timeframes</strong> â€” reduzir posiÃ§Ã£o.â€™;
if(lATR){text+=â€™<br><br><strong>Risco:</strong> SL a 1.5Ã—ATR | TP1 a 2Ã—ATR | TP2 a 3Ã—ATR.â€™}}
else{title=â€˜AGUARDAR â€” â€˜+info.n;emoji=â€˜â³â€™;
text=â€˜Sem sinal claro. â€˜;
if(dailyTF)text+=â€˜DiÃ¡rio: <strong>â€™+dailyTF.bias+â€™</strong>. â€˜;
if(weeklyTF)text+=â€˜Semanal: <strong>â€™+weeklyTF.bias+â€™</strong>. â€˜;
var distSup=((lp-sr.suporte)/lp*100).toFixed(1);
var distRes=((sr.resistencia-lp)/lp*100).toFixed(1);
if(parseFloat(distSup)<2)text+=â€™<br><br>ğŸ“ PrÃ³ximo suporte â€” zona de compra.â€™;
else if(parseFloat(distRes)<2)text+=â€™<br><br>ğŸ“ PrÃ³ximo resistÃªncia â€” zona de venda.â€™;
else text+=â€™<br><br>Entre suporte e resistÃªncia. Aguardar.â€™}
document.getElementById(â€˜actTitleâ€™).innerHTML=emoji+â€™ â€˜+title;
document.getElementById(â€˜actTextâ€™).innerHTML=text;
var rHTML=â€™â€™;
if(slP!=null)rHTML+=â€™<div class="risk-pill"><div class="rpl">Stop-Loss</div><div class="rpv" style="color:var(--r)">â€™+slP.toFixed(dp)+â€™</div></div>â€™;
if(tpP!=null)rHTML+=â€™<div class="risk-pill"><div class="rpl">TP 1</div><div class="rpv" style="color:var(--g)">â€™+tpP.toFixed(dp)+â€™</div></div>â€™;
if(tp2P!=null)rHTML+=â€™<div class="risk-pill"><div class="rpl">TP 2</div><div class="rpv" style="color:var(--g)">â€™+tp2P.toFixed(dp)+â€™</div></div>â€™;
if(lATR)rHTML+=â€™<div class="risk-pill"><div class="rpl">ATR</div><div class="rpv" style="color:var(--cy)">â€™+lATR.toFixed(dp)+â€™</div></div>â€™;
document.getElementById(â€˜riskRowâ€™).innerHTML=rHTML}

// â•â•â• UI â•â•â•
function renderA(){var h=â€™â€™;for(var c in A){h+=â€™<div class="cl">â€™+c+â€™</div><div class="ar">â€™;A[c].forEach(function(a){h+=â€™<button class=â€œab â€˜+(a.s===sel?â€˜onâ€™:â€™â€™)+â€™â€ onclick=â€œselA('â€™+a.s.replace(/â€™/g,â€\â€™â€)+â€™')â€>â€™+a.e+â€™ â€˜+a.n+â€™</button>â€™});h+=â€™</div>â€™}document.getElementById(â€˜aGridâ€™).innerHTML=h}
function selA(s){sel=s;save();renderA();refresh()}
function setSts(t,m){document.getElementById(â€˜stsâ€™).innerHTML=â€™<span class="dot '+(t==='ok'?'dok':t==='err'?'doe':'dol')+'"></span> â€™+m}
function getI(s){for(var c in A){var f=A[c].find(function(a){return a.s===s});if(f)return f}return{s:s,n:s,e:â€˜ğŸ“Šâ€™,t:â€˜sâ€™}}
function toast(t,b){document.getElementById(â€˜toastTâ€™).textContent=t;document.getElementById(â€˜toastBâ€™).textContent=b;document.getElementById(â€˜toastâ€™).classList.add(â€˜showâ€™);setTimeout(function(){document.getElementById(â€˜toastâ€™).classList.remove(â€˜showâ€™)},4000)}

async function refresh(){
var info=getI(sel);setSts(â€˜loadâ€™,info.n+â€™â€¦â€™);
document.getElementById(â€˜pNâ€™).textContent=info.e+â€™ â€˜+info.n;document.getElementById(â€˜pPâ€™).textContent=â€™â€¦â€™;
var candles=await getCandles(sel,info.t||â€˜sâ€™,â€˜Dâ€™,200);
if(!candles){setSts(â€˜errâ€™,â€˜Sem resposta API para â€˜+info.s+â€™ â€” verifica a key/internetâ€™);return}
if(candles.length<30){setSts(â€˜errâ€™,info.s+â€™: sÃ³ â€˜+candles.length+â€™ velas (preciso 30+)â€™);return}
var weekly=await getCandles(sel,info.t||â€˜sâ€™,â€˜Wâ€™,400);
var quote=null;if(info.t===â€˜sâ€™)quote=await getQuote(sel);
var s20=_SMA(candles,20),s50=_SMA(candles,50),rsi=_RSI(candles),macd=_MACD(candles),
boll=_BOLL(candles),fib=_FIB(candles),sr=_SR(candles),atr=_ATR(candles),adx=_ADX(candles);
var sigs=_SIGS(candles,rsi,macd,boll,s20,s50,atr,adx);
var dailyTF=analyzeTF(candles,â€˜DiÃ¡rioâ€™),weeklyTF=weekly?analyzeTF(weekly,â€˜Semanalâ€™):null;
var last=candles[candles.length-1],prev=candles[candles.length-2];
var lp=(quote&&quote.c&&quote.c>0)?quote.c:last.close;
var ch=quote&&quote.d!=null?quote.d:lp-prev.close;
var chP=quote&&quote.dp!=null?quote.dp:(ch/prev.close)*100;
curDP=lp>100?2:lp>1?3:lp>.01?5:6;curPrice=lp;
document.getElementById(â€˜pPâ€™).textContent=lp.toFixed(curDP);
var ce=document.getElementById(â€˜pCâ€™);ce.textContent=(ch>=0?â€˜â–²â€™:â€˜â–¼â€™)+â€™ â€˜+Math.abs(ch).toFixed(curDP)+â€™ (â€™+(chP>=0?â€™+â€™:â€™â€™)+chP.toFixed(2)+â€™%)â€™;ce.style.color=ch>=0?â€˜var(â€“g)â€™:â€˜var(â€“r)â€™;
var lR=null;for(var i=rsi.length-1;i>=0;iâ€“){if(rsi[i]!=null){lR=rsi[i];break}}
var lM=null;for(var i=macd.h.length-1;i>=0;iâ€“){if(macd.h[i]!=null){lM=macd.h[i];break}}
document.getElementById(â€˜mRâ€™).textContent=lR?lR.toFixed(1):â€™â€”â€™;document.getElementById(â€˜mRâ€™).style.color=lR>70?â€˜var(â€“r)â€™:lR<30?â€˜var(â€“g)â€™:â€˜var(â€“t)â€™;
document.getElementById(â€˜mMâ€™).textContent=lM?lM.toFixed(4):â€™â€”â€™;document.getElementById(â€˜mMâ€™).style.color=lM>0?â€˜var(â€“g)â€™:â€˜var(â€“r)â€™;
var lastSig=sigs.length?sigs[sigs.length-1]:null;
document.getElementById(â€˜mCfâ€™).textContent=lastSig?lastSig.conf+â€™%â€™:â€™â€”â€™;
var r5=sigs.slice(-5),score=r5.reduce(function(s,g){return s+(g.type===â€œBUYâ€?g.str:-g.str)},0);
var rec=score>3?â€œCOMPRA FORTEâ€:score>0?â€œCOMPRAâ€:score<-3?â€œVENDA FORTEâ€:score<0?â€œVENDAâ€:â€œAGUARDARâ€;
var rc=score>3?â€˜var(â€“g)â€™:score>0?â€™#34d399â€™:score<-3?â€˜var(â€“r)â€™:score<0?â€™#f87171â€™:â€˜var(â€“t3)â€™;
document.getElementById(â€˜rBâ€™).style.background=score>0?â€˜rgba(16,185,129,.08)â€™:score<0?â€˜rgba(239,68,68,.08)â€™:â€˜var(â€“bg2)â€™;
document.getElementById(â€˜rVâ€™).textContent=rec;document.getElementById(â€˜rVâ€™).style.color=rc;
genAction(info,lp,curDP,sigs,sr,fib,atr,dailyTF,weeklyTF);
renderPos();checkPositionAlerts(lp);renderHist();
if(nO&&lastSig&&lastSig.str>=4&&lastSig.date!==prevSig[sel]){
try{new Notification((lastSig.type===â€˜BUYâ€™?â€˜ğŸŸ¢ COMPRAâ€™:â€˜ğŸ”´ VENDAâ€™)+â€™ â€” â€˜+info.n,{body:lastSig.reasons.slice(0,3).join(â€™, â€˜)})}catch(e){}
toast((lastSig.type===â€˜BUYâ€™?â€˜ğŸŸ¢â€™:â€˜ğŸ”´â€™)+â€™ â€˜+info.n,lastSig.reasons.slice(0,2).join(â€™, â€˜));prevSig[sel]=lastSig.date}
drawP(candles,s20,s50,boll,sigs,fib);drawR(rsi);drawM(macd);rSigs(sigs,curDP);rLev(sr,fib,lp,curDP);
setSts(â€˜okâ€™,info.n+â€™ Â· â€˜+candles.length+â€˜Dâ€™+(weekly?â€™ +â€™+weekly.length+â€˜Wâ€™:â€™â€™)+â€™ Â· â€™+new Date().toLocaleTimeString(â€˜ptâ€™,{hour:â€˜2-digitâ€™,minute:â€˜2-digitâ€™}))}

// â•â•â• SVG â•â•â•
function $(t,a){a=a||{};var e=document.createElementNS(â€˜http://www.w3.org/2000/svgâ€™,t);for(var k in a)e.setAttribute(k,a[k]);return e}
function $t(x,y,txt,fill,sz){var t=$(â€˜textâ€™,{x:x,y:y,fill:fill,â€˜font-sizeâ€™:sz||8,â€˜font-familyâ€™:â€˜monospaceâ€™});t.textContent=txt;return t}
function drawP(d,s20,s50,boll,sigs,fib){
var W=800,H=280,P={t:12,r:48,b:22,l:5},n=Math.min(60,d.length),vis=d.slice(-n),off=d.length-n;
var av=[];vis.forEach(function(v){av.push(v.high,v.low)});if(shB)boll.slice(-n).forEach(function(b){if(b.u!=null){av.push(b.u,b.l)}});
var yN=Math.min.apply(null,av)*.998,yX=Math.max.apply(null,av)*1.002;
var x=function(i){return P.l+(i/(vis.length-1))*(W-P.l-P.r)};var y=function(v){return P.t+(1-(v-yN)/(yX-yN))*(H-P.t-P.b)};
var cw=Math.max(2,(W-P.l-P.r)/vis.length*.55);var svg=$(â€˜svgâ€™,{viewBox:â€˜0 0 â€˜+W+â€™ â€˜+H});svg.appendChild($(â€˜rectâ€™,{width:W,height:H,fill:â€™#0a0e17â€™,rx:7}));
for(var i=0;i<5;i++){var yy=P.t+(i/4)*(H-P.t-P.b),val=yX-(i/4)*(yX-yN);svg.appendChild($(â€˜lineâ€™,{x1:P.l,x2:W-P.r,y1:yy,y2:yy,stroke:â€™#151d2eâ€™}));svg.appendChild($t(W-P.r+3,yy+3,val.toFixed(2),â€™#3a4563â€™,7))}
if(shB){var bs=boll.slice(-n),up=â€™â€™,lo=â€™â€™,rv=[];bs.forEach(function(b,i){if(b.u!=null){up+=x(i)+â€™,â€™+y(b.u)+â€™ â€˜;lo+=x(i)+â€™,â€™+y(b.l)+â€™ â€˜;rv.push(x(i)+â€™,â€™+y(b.l))}});svg.appendChild($(â€˜polygonâ€™,{points:up+rv.reverse().join(â€™ â€˜),fill:â€˜rgba(99,102,241,.05)â€™}));svg.appendChild($(â€˜polylineâ€™,{points:up,fill:â€˜noneâ€™,stroke:â€˜rgba(99,102,241,.28)â€™,â€˜stroke-widthâ€™:.8,â€˜stroke-dasharrayâ€™:â€˜3,3â€™}));svg.appendChild($(â€˜polylineâ€™,{points:lo,fill:â€˜noneâ€™,stroke:â€˜rgba(99,102,241,.28)â€™,â€˜stroke-widthâ€™:.8,â€˜stroke-dasharrayâ€™:â€˜3,3â€™}))}
if(shF){for(var lb in fib){var val=fib[lb];if(val<yN||val>yX)continue;svg.appendChild($(â€˜lineâ€™,{x1:P.l,x2:W-P.r,y1:y(val),y2:y(val),stroke:â€˜rgba(245,158,11,.18)â€™,â€˜stroke-dasharrayâ€™:â€˜4,4â€™}));svg.appendChild($t(P.l+2,y(val)-2,lb,â€˜rgba(245,158,11,.4)â€™,6))}}
vis.forEach(function(v,i){var g=v.close>=v.open,c=g?â€™#10b981â€™:â€™#ef4444â€™;svg.appendChild($(â€˜lineâ€™,{x1:x(i),x2:x(i),y1:y(v.high),y2:y(v.low),stroke:c}));svg.appendChild($(â€˜rectâ€™,{x:x(i)-cw/2,y:y(Math.max(v.open,v.close)),width:cw,height:Math.max(.8,y(Math.min(v.open,v.close))-y(Math.max(v.open,v.close))),fill:c,rx:.5}))});
if(shS){[{a:s20.slice(-n),c:â€™#f59e0bâ€™},{a:s50.slice(-n),c:â€™#06b6d4â€™}].forEach(function(o){var p=â€™â€™;o.a.forEach(function(v,i){if(v!=null)p+=x(i)+â€™,â€™+y(v)+â€™ â€˜});svg.appendChild($(â€˜polylineâ€™,{points:p,fill:â€˜noneâ€™,stroke:o.c,â€˜stroke-widthâ€™:1.2}))})}
sigs.filter(function(s){return s.idx>=off}).forEach(function(s){var i=s.idx-off,xx=x(i),yy=s.type===â€˜BUYâ€™?y(vis[i].low)+8:y(vis[i].high)-8;svg.appendChild($(â€˜polygonâ€™,{points:s.type===â€˜BUYâ€™?xx+â€™,â€™+(yy-7)+â€™ â€˜+(xx-4)+â€™,â€™+yy+â€™ â€˜+(xx+4)+â€™,â€™+yy:xx+â€™,â€™+(yy+7)+â€™ â€˜+(xx-4)+â€™,â€™+yy+â€™ â€˜+(xx+4)+â€™,â€™+yy,fill:s.type===â€˜BUYâ€™?â€™#10b981â€™:â€™#ef4444â€™,opacity:â€™.8â€™}))});
// Draw position entry lines
positions.filter(function(p){return p.symbol===sel&&!p.closed}).forEach(function(pos){
if(pos.entryPrice>=yN&&pos.entryPrice<=yX){svg.appendChild($(â€˜lineâ€™,{x1:P.l,x2:W-P.r,y1:y(pos.entryPrice),y2:y(pos.entryPrice),stroke:â€™#6366f1â€™,â€˜stroke-widthâ€™:1,â€˜stroke-dasharrayâ€™:â€˜6,3â€™}));svg.appendChild($t(P.l+2,y(pos.entryPrice)-3,â€˜ENTRY â€˜+pos.entryPrice.toFixed(2),â€™#6366f1â€™,6))}
if(pos.sl!=null&&pos.sl>=yN&&pos.sl<=yX){svg.appendChild($(â€˜lineâ€™,{x1:P.l,x2:W-P.r,y1:y(pos.sl),y2:y(pos.sl),stroke:â€™#ef4444â€™,â€˜stroke-widthâ€™:1,â€˜stroke-dasharrayâ€™:â€˜4,4â€™}));svg.appendChild($t(P.l+2,y(pos.sl)-3,â€˜SL â€˜+pos.sl.toFixed(2),â€™#ef4444â€™,6))}
if(pos.tp!=null&&pos.tp>=yN&&pos.tp<=yX){svg.appendChild($(â€˜lineâ€™,{x1:P.l,x2:W-P.r,y1:y(pos.tp),y2:y(pos.tp),stroke:â€™#10b981â€™,â€˜stroke-widthâ€™:1,â€˜stroke-dasharrayâ€™:â€˜4,4â€™}));svg.appendChild($t(P.l+2,y(pos.tp)-3,â€˜TP â€˜+pos.tp.toFixed(2),â€™#10b981â€™,6))}});
vis.forEach(function(v,i){if(i%12===0)svg.appendChild($t(x(i),H-4,v.date.slice(5),â€™#3a4563â€™,7))});
document.getElementById(â€˜mCâ€™).innerHTML=â€™â€™;document.getElementById(â€˜mCâ€™).appendChild(svg)}

function drawR(rsi){var W=800,H=70,vis=rsi.slice(-60);var x=function(i){return 5+(i/(vis.length-1))*(W-52)};var y=function(v){return 5+(1-v/100)*60};var svg=$(â€˜svgâ€™,{viewBox:â€˜0 0 â€˜+W+â€™ â€˜+H});svg.appendChild($(â€˜rectâ€™,{width:W,height:H,fill:â€™#0a0e17â€™,rx:7}));svg.appendChild($(â€˜rectâ€™,{x:5,y:y(70),width:W-52,height:y(30)-y(70),fill:â€˜rgba(99,102,241,.03)â€™}));svg.appendChild($(â€˜lineâ€™,{x1:5,x2:W-47,y1:y(70),y2:y(70),stroke:â€˜rgba(239,68,68,.18)â€™,â€˜stroke-dasharrayâ€™:â€˜3,3â€™}));svg.appendChild($(â€˜lineâ€™,{x1:5,x2:W-47,y1:y(30),y2:y(30),stroke:â€˜rgba(16,185,129,.18)â€™,â€˜stroke-dasharrayâ€™:â€˜3,3â€™}));svg.appendChild($t(W-44,y(70)+3,â€˜70â€™,â€™#ef4444â€™,6));svg.appendChild($t(W-44,y(30)+3,â€˜30â€™,â€™#10b981â€™,6));var pts=â€™â€™;vis.forEach(function(v,i){if(v!=null)pts+=x(i)+â€™,â€™+y(v)+â€™ â€˜});svg.appendChild($(â€˜polylineâ€™,{points:pts,fill:â€˜noneâ€™,stroke:â€™#a78bfaâ€™,â€˜stroke-widthâ€™:1.3}));document.getElementById(â€˜rCâ€™).innerHTML=â€™â€™;document.getElementById(â€˜rCâ€™).appendChild(svg)}

function drawM(macd){var W=800,H=70,vis={m:macd.ml.slice(-60),s:macd.sl.slice(-60),h:macd.h.slice(-60)};var all=vis.m.concat(vis.s,vis.h).filter(function(v){return v!=null});if(!all.length)return;var am=Math.max(Math.abs(Math.min.apply(null,all)),Math.abs(Math.max.apply(null,all)))||1;var x=function(i){return 5+(i/(vis.m.length-1))*(W-52)};var y=function(v){return 35-(v/am)*28};var bw=Math.max(1.5,(W-52)/vis.h.length*.5);var svg=$(â€˜svgâ€™,{viewBox:â€˜0 0 â€˜+W+â€™ â€˜+H});svg.appendChild($(â€˜rectâ€™,{width:W,height:H,fill:â€™#0a0e17â€™,rx:7}));svg.appendChild($(â€˜lineâ€™,{x1:5,x2:W-47,y1:35,y2:35,stroke:â€™#151d2eâ€™}));vis.h.forEach(function(v,i){if(v!=null)svg.appendChild($(â€˜rectâ€™,{x:x(i)-bw/2,y:v>=0?y(v):35,width:bw,height:Math.abs(y(v)-35),fill:v>=0?â€˜rgba(16,185,129,.35)â€™:â€˜rgba(239,68,68,.35)â€™,rx:.5}))});var mp=â€™â€™,sp=â€™â€™;vis.m.forEach(function(v,i){if(v!=null)mp+=x(i)+â€™,â€™+y(v)+â€™ â€˜});vis.s.forEach(function(v,i){if(v!=null)sp+=x(i)+â€™,â€™+y(v)+â€™ â€˜});svg.appendChild($(â€˜polylineâ€™,{points:mp,fill:â€˜noneâ€™,stroke:â€™#818cf8â€™,â€˜stroke-widthâ€™:1.3}));svg.appendChild($(â€˜polylineâ€™,{points:sp,fill:â€˜noneâ€™,stroke:â€™#f97316â€™,â€˜stroke-widthâ€™:1.3}));document.getElementById(â€˜maCâ€™).innerHTML=â€™â€™;document.getElementById(â€˜maCâ€™).appendChild(svg)}

function rSigs(sigs,dp){var h=â€™<div style="font-size:8px;color:var(--t3);margin-bottom:7px;text-transform:uppercase">â€™+sigs.length+â€™ sinais</div>â€™;
sigs.slice(-12).reverse().forEach(function(s){var b=s.type===â€˜BUYâ€™,c=b?â€˜var(â€“g)â€™:â€˜var(â€“r)â€™,bg=b?â€˜rgba(16,185,129,.08)â€™:â€˜rgba(239,68,68,.08)â€™;
h+=â€™<div class="sg" style="border-left:2px solid '+c+'"><div class="sh"><div style="display:flex;align-items:center;gap:6px"><span class="st" style="background:'+bg+';color:'+c+'">â€™+(b?â€˜â–² COMPRAâ€™:â€˜â–¼ VENDAâ€™)+â€™</span><span style="font-size:10px;color:var(--t2)">â€™+s.price.toFixed(dp)+â€™</span><span style="font-size:8px;color:var(--pu)">â€™+s.conf+â€™%</span></div><span style="font-size:8px;color:var(--t3)">â€™+s.date+â€™</span></div>â€™;
h+=â€™<div class="sd">â€™;for(var j=0;j<8;j++)h+=â€™<span class="sdd" style="background:'+(j<s.str?c:'var(--bd)')+'"></span>â€™;h+=â€™</div>â€™;
if(s.sl!=null)h+=â€™<div style="font-size:8px;margin-top:3px;color:var(--t3)">SL: <span style="color:var(--r)">â€™+s.sl.toFixed(dp)+â€™</span> Â· TP1: <span style="color:var(--g)">â€™+s.tp.toFixed(dp)+â€™</span></div>â€™;
h+=â€™<div class="sr">â€™+s.reasons.join(â€™ Â· â€˜)+â€™</div></div>â€™});document.getElementById(â€˜vsâ€™).innerHTML=h}

function rLev(sr,fib,lp,dp){var h=â€™<div class="lg"><div class="lb"><div class="lt">Suporte & ResistÃªncia</div>â€™;
var keys=[â€˜suporteForteâ€™,â€˜suporteâ€™,â€˜resistenciaâ€™,â€˜resistenciaForteâ€™];
var labels={suporteForte:â€˜Suporte Forteâ€™,suporte:â€˜Suporteâ€™,resistencia:â€˜ResistÃªnciaâ€™,resistenciaForte:â€˜ResistÃªncia Forteâ€™};
keys.forEach(function(k){var sup=k.indexOf(â€˜suporteâ€™)>=0;h+=â€™<div class="lr"><span style="color:var(--t2)">â€™+labels[k]+â€™</span><span style="font-weight:600;color:'+(sup?'var(--g)':'var(--r)')+'">â€™+sr[k].toFixed(dp)+â€™</span></div>â€™});
h+=â€™<div style="margin-top:7px;padding:6px 9px;background:rgba(99,102,241,.06);border-radius:6px;font-size:8px;color:var(--pu)">PreÃ§o: <b>â€™+lp.toFixed(dp)+â€™</b></div></div>â€™;
h+=â€™<div class="lb"><div class="lt">Fibonacci</div>â€™;for(var l in fib)h+=â€™<div class="lr"><span style="color:var(--am)">â€™+l+â€™</span><span style="font-weight:600">â€™+fib[l].toFixed(dp)+â€™</span></div>â€™;
h+=â€™</div></div>â€™;document.getElementById(â€˜vlâ€™).innerHTML=h}

// â•â•â• CONTROLS â•â•â•
function tgl(t){if(t===â€˜sâ€™)shS=!shS;if(t===â€˜bâ€™)shB=!shB;if(t===â€˜fâ€™)shF=!shF;document.getElementById(â€˜tSâ€™).classList.toggle(â€˜onâ€™,shS);document.getElementById(â€˜tBâ€™).classList.toggle(â€˜onâ€™,shB);document.getElementById(â€˜tFâ€™).classList.toggle(â€˜onâ€™,shF);refresh()}
function stab(id,btn){document.querySelectorAll(â€™.ttâ€™).forEach(function(t){t.classList.remove(â€˜onâ€™)});btn.classList.add(â€˜onâ€™);[â€˜vcâ€™,â€˜vsâ€™,â€˜vlâ€™,â€˜vhâ€™].forEach(function(v){document.getElementById(v).style.display=â€˜noneâ€™});document.getElementById(â€˜vâ€™+id).style.display=â€˜blockâ€™}
function togAuto(){aR=!aR;var b=document.getElementById(â€˜abtnâ€™);if(aR){b.classList.add(â€˜onâ€™);b.textContent=â€˜â¸ 30sâ€™;aI=setInterval(refresh,30000)}else{b.classList.remove(â€˜onâ€™);b.textContent=â€˜â–¶ Autoâ€™;clearInterval(aI)}}
async function togNotif(){if(!nO){if(â€˜Notificationâ€™in window){var p=await Notification.requestPermission();if(p===â€˜grantedâ€™){nO=true;toast(â€˜ğŸ”” Alertasâ€™,â€˜Sinais + SL/TPâ€™);document.getElementById(â€˜nbtnâ€™).classList.add(â€˜noâ€™)}else toast(â€˜âš ï¸â€™,â€˜Permite nas definiÃ§Ãµesâ€™)}else toast(â€˜âš ï¸â€™,â€˜NÃ£o suportadoâ€™)}else{nO=false;document.getElementById(â€˜nbtnâ€™).classList.remove(â€˜noâ€™);toast(â€˜ğŸ”•â€™,â€˜Offâ€™)}}
function opMo(){var ex=[];for(var c in A)A[c].forEach(function(a){ex.push(a.s)});var av=PRE.filter(function(p){return ex.indexOf(p.s)<0});var cats=[];av.forEach(function(p){if(cats.indexOf(p.c)<0)cats.push(p.c)});var h=â€™â€™;cats.forEach(function(c){h+=â€™<div style="font-size:8px;color:var(--t3);margin-bottom:4px;text-transform:uppercase">â€™+c+â€™</div><div class="pg">â€™;av.filter(function(p){return p.c===c}).forEach(function(p){h+=â€™<button class=â€œabâ€ onclick=â€œaddP('â€™+p.s.replace(/â€™/g,â€\â€™â€)+â€™','â€™+p.n+â€™','â€™+p.e+â€™','â€™+p.c+â€™','â€™+p.t+â€™')â€>â€™+p.e+â€™ â€˜+p.n+â€™</button>â€™});h+=â€™</div>â€™});document.getElementById(â€˜pListâ€™).innerHTML=h;document.getElementById(â€˜modalâ€™).classList.add(â€˜onâ€™)}
function clMo(){document.getElementById(â€˜modalâ€™).classList.remove(â€˜onâ€™)}
function addP(s,n,e,c,t){if(!A[c])A[c]=[];if(A[c].find(function(a){return a.s===s}))return;A[c].push({s:s,n:n,e:e,t:t});save();renderA();clMo()}
function addC(){var s=document.getElementById(â€˜cSâ€™).value.trim().toUpperCase(),n=document.getElementById(â€˜cNâ€™).value.trim(),c=document.getElementById(â€˜cCâ€™).value;if(!s||!n)return;var t=â€˜sâ€™;if(s.indexOf(â€˜OANDA:â€™)>=0)t=â€˜fâ€™;else if(s.indexOf(â€˜BINANCE:â€™)>=0)t=â€˜câ€™;if(!A[c])A[c]=[];A[c].push({s:s,n:n,e:â€˜ğŸ“Šâ€™,t:t});save();renderA();clMo();document.getElementById(â€˜cSâ€™).value=â€™â€™;document.getElementById(â€˜cNâ€™).value=â€™â€™}

// â•â•â• DEBUG â•â•â•
async function debugAPI(){
var info=getI(sel);var msg=â€˜DEBUG â€˜+info.s+â€™\n\nâ€™;
try{
var to=Math.floor(Date.now()/1000);var from=to-30*86400;
msg+=â€˜Timestamps: from=â€™+from+â€™ to=â€™+to+â€™\nâ€™;
msg+=â€™Date from: â€™+new Date(from*1000).toISOString()+â€™\nâ€™;
msg+=â€˜Date to: â€˜+new Date(to*1000).toISOString()+â€™\n\nâ€™;

// Test 1: Quote
msg+=â€™â€” QUOTE â€”\nâ€™;
try{var r1=await fetch(â€˜https://finnhub.io/api/v1/quote?symbol=AAPL&token=â€™+K);
msg+=â€˜Status: â€˜+r1.status+â€™\nâ€™;var d1=await r1.text();msg+=â€˜Response: â€˜+d1.slice(0,300)+â€™\n\nâ€™}
catch(e){msg+=â€˜Quote error: â€˜+e.message+â€™\n\nâ€™}

// Test 2: Stock candle
msg+=â€™â€” STOCK CANDLE (AAPL 30d) â€”\nâ€™;
try{var r2=await fetch(â€˜https://finnhub.io/api/v1/stock/candle?symbol=AAPL&resolution=D&from=â€™+from+â€™&to=â€™+to+â€™&token=â€™+K);
msg+=â€˜Status: â€˜+r2.status+â€™\nâ€™;var d2=await r2.text();msg+=â€˜Response (first 500): â€˜+d2.slice(0,500)+â€™\n\nâ€™}
catch(e){msg+=â€˜Candle error: â€˜+e.message+â€™\n\nâ€™}

// Test 3: Selected asset
if(info.s!==â€˜AAPLâ€™){
var ep=info.t===â€˜fâ€™?â€™/forex/candleâ€™:info.t===â€˜câ€™?â€™/crypto/candleâ€™:â€™/stock/candleâ€™;
msg+=â€™â€” â€˜+ep+â€™ (â€™+info.s+â€™) â€”\nâ€™;
try{var r3=await fetch(â€˜https://finnhub.io/api/v1â€™+ep+â€™?symbol=â€™+encodeURIComponent(info.s)+â€™&resolution=D&from=â€™+from+â€™&to=â€™+to+â€™&token=â€™+K);
msg+=â€˜Status: â€˜+r3.status+â€™\nâ€™;var d3=await r3.text();msg+=â€˜Response (first 500): â€˜+d3.slice(0,500)+â€™\n\nâ€™}
catch(e){msg+=â€˜Error: â€˜+e.message+â€™\n\nâ€™}}

}catch(e){msg+=â€˜Global error: â€˜+e.message+â€™\nâ€™}
alert(msg)}
</script>

</body>
</html>