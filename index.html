<!DOCTYPE html>

<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CFD Pro">
<meta name="theme-color" content="#060b14">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon192.png">
<title>CFD Analyzer Pro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800;900&display=swap');
:root{--bg:#060b14;--bg2:#0c1220;--bg3:#111827;--bd:#1c2640;--t:#e2e8f0;--t2:#94a3b8;--t3:#475569;--g:#10b981;--r:#ef4444;--bl:#6366f1;--am:#f59e0b;--cy:#06b6d4;--pu:#a78bfa;--mg:#059669}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--t);min-height:100dvh;padding:env(safe-area-inset-top,12px) 12px 90px;overflow-x:hidden}
h1,h2,h3,.outfit{font-family:'Outfit',sans-serif}
/* Setup */
.setup{max-width:400px;margin:12vh auto;text-align:center;animation:up .6s ease-out}
.setup h1{font-size:26px;font-weight:900;margin-bottom:4px;background:linear-gradient(135deg,#e2e8f0 30%,#6366f1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.setup .sub{color:var(--t2);font-size:11px;margin-bottom:6px;font-weight:300}
.setup .tags{display:flex;gap:5px;justify-content:center;flex-wrap:wrap;margin-bottom:24px}
.setup .tag{padding:3px 10px;border-radius:20px;font-size:9px;border:1px solid var(--bd);color:var(--t3)}
.sb{width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--bl),#8b5cf6);color:#fff;font-family:'Outfit',sans-serif;font-size:14px;font-weight:700;cursor:pointer;letter-spacing:.3px;position:relative;overflow:hidden}.sb:active{transform:scale(.97)}.sb::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 40%,rgba(255,255,255,.1));pointer-events:none}
.hint{color:var(--t3);font-size:9px;margin-top:14px;line-height:1.8}
/* Dashboard */
.d{max-width:920px;margin:0 auto;display:none;animation:up .4s}.d.on{display:block}
.hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 0;flex-wrap:wrap;gap:8px}
.hdr h1{font-size:20px;font-weight:900;letter-spacing:-.3px}.ha{display:flex;gap:4px;align-items:center;flex-wrap:wrap}
.hb{padding:6px 11px;border-radius:8px;border:1px solid var(--bd);background:var(--bg2);color:var(--t2);font-family:inherit;font-size:10px;cursor:pointer;white-space:nowrap;transition:all .15s}.hb:active{transform:scale(.93)}.hb.on{border-color:var(--g);color:var(--g);background:rgba(16,185,129,.06)}.hb.no{border-color:var(--am);color:var(--am)}
.rb{padding:6px 14px;border-radius:9px;text-align:center;border:1px solid var(--bd);background:var(--bg2);transition:all .3s}.rb .rl{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.12em}.rb .rv{font-size:14px;font-weight:700}
/* Mode toggle */
.mode-toggle{display:flex;background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:3px;margin:8px 0;gap:2px}
.mode-btn{flex:1;padding:8px 12px;border:none;border-radius:8px;background:transparent;color:var(--t3);font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s}.mode-btn.on{background:rgba(99,102,241,.12);color:var(--pu);box-shadow:0 1px 4px rgba(99,102,241,.15)}
/* Assets */
.cl{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;margin:9px 0 4px}
.ar{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:2px}
.ab{padding:5px 10px;border-radius:7px;border:1px solid var(--bd);background:var(--bg2);color:var(--t2);font-family:inherit;font-size:10px;cursor:pointer;transition:all .15s}.ab:active{transform:scale(.93)}.ab.on{border-color:var(--bl);background:rgba(99,102,241,.08);color:var(--t)}
.adb{padding:7px 14px;border-radius:8px;border:1px dashed var(--bd);background:transparent;color:var(--bl);font-family:'Outfit',sans-serif;font-size:10px;font-weight:600;cursor:pointer;margin-top:5px}
/* Price card */
.pc{background:var(--bg2);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:10px 0;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.pm .sn{font-size:10px;color:var(--t3)}.pm .pr{font-family:'Outfit',sans-serif;font-size:28px;font-weight:800;letter-spacing:-.5px}.pm .ch{font-size:11px;font-weight:500}
.ms{display:flex;gap:14px}.me{text-align:center}.me .ml{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em}.me .mv{font-size:14px;font-weight:600}
/* Risk management panel */
.risk-panel{background:linear-gradient(135deg,rgba(16,185,129,.04),rgba(6,182,212,.04));border:1px solid rgba(16,185,129,.15);border-radius:14px;padding:14px;margin:10px 0}
.risk-panel h3{font-size:12px;font-weight:700;margin-bottom:10px;color:var(--g)}
.risk-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
@media(max-width:500px){.risk-grid{grid-template-columns:1fr 1fr}}
.risk-field label{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:3px}
.risk-field input,.risk-field select{width:100%;background:var(--bg);border:1px solid var(--bd);border-radius:7px;padding:8px 10px;color:var(--t);font-family:inherit;font-size:11px;outline:none}.risk-field input:focus{border-color:var(--g)}
.risk-summary{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.risk-chip{padding:5px 10px;border-radius:7px;font-size:9px;border:1px solid var(--bd);background:var(--bg);text-align:center;flex:1;min-width:70px}
.risk-chip .rcl{font-size:7px;color:var(--t3);text-transform:uppercase}.risk-chip .rcv{font-size:12px;font-weight:600}
/* Action box */
.action-box{background:var(--bg2);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:10px 0}
.action-box h3{font-size:13px;font-weight:700;margin-bottom:8px}.action-text{font-size:11px;color:var(--t2);line-height:1.7}.action-text strong{color:var(--t)}
.risk-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.risk-pill{padding:6px 12px;border-radius:8px;font-size:10px;border:1px solid var(--bd);background:var(--bg);text-align:center;flex:1;min-width:70px}
.risk-pill .rpl{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px}.risk-pill .rpv{font-size:13px;font-weight:600}
.tf-row{display:flex;gap:6px;margin:8px 0;align-items:center;flex-wrap:wrap}
.tf-badge{padding:4px 10px;border-radius:6px;font-size:9px;font-weight:600;border:1px solid var(--bd)}.tf-label{font-size:8px;color:var(--t3)}
/* Position tracker */
.pos-box{background:linear-gradient(135deg,rgba(99,102,241,.05),rgba(139,92,246,.05));border:1px solid rgba(99,102,241,.15);border-radius:14px;padding:14px;margin:10px 0}
.pos-box h3{font-size:12px;font-weight:700;margin-bottom:10px}
.pos-card{background:var(--bg);border:1px solid var(--bd);border-radius:10px;padding:11px;margin-bottom:8px}
.pos-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.pos-pnl{font-family:'Outfit',sans-serif;font-size:16px;font-weight:700}
.pos-details{font-size:9px;color:var(--t3);line-height:1.6}
.pos-targets{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.pos-target{padding:4px 8px;border-radius:5px;font-size:8px;border:1px solid var(--bd);background:var(--bg2)}
.pos-alert{padding:8px 12px;border-radius:8px;margin-top:8px;font-size:10px;font-weight:600;animation:pu 1.5s infinite}
.pos-btn{padding:8px 14px;border-radius:8px;border:none;font-family:'Outfit',sans-serif;font-size:10px;font-weight:600;cursor:pointer;margin-top:6px}
.pos-form{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px}
.pos-form input,.pos-form select{background:var(--bg);border:1px solid var(--bd);border-radius:6px;padding:7px 9px;color:var(--t);font-family:inherit;font-size:10px;outline:none}
.pos-form input:focus{border-color:var(--bl)}
.pos-form label{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px;display:block}
/* History */
.hist-item{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid rgba(28,38,64,.2);font-size:9px}
/* Toggles & tabs */
.tgs{display:flex;gap:4px;margin-bottom:9px;flex-wrap:wrap}
.tb{padding:4px 10px;border-radius:6px;border:1px solid var(--bd);background:transparent;color:var(--t3);font-family:inherit;font-size:9px;cursor:pointer;transition:all .15s}.tb.on{border-color:var(--bl);background:rgba(99,102,241,.1);color:var(--pu)}
.tabs{display:flex;gap:2px;background:var(--bg2);border-radius:9px;padding:2px;width:fit-content;margin-bottom:10px;flex-wrap:wrap}
.tt{padding:5px 14px;border-radius:7px;border:none;background:transparent;color:var(--t3);font-family:inherit;font-size:10px;cursor:pointer;font-weight:500;transition:all .15s}.tt.on{background:rgba(99,102,241,.1);color:var(--pu)}
/* Charts */
.cb{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:10px;margin-bottom:9px}
.cb .cbl{font-size:7px;color:var(--t3);padding-left:5px;margin-bottom:4px;text-transform:uppercase;letter-spacing:.1em}
.sc{display:grid;grid-template-columns:1fr 1fr;gap:9px}@media(max-width:600px){.sc{grid-template-columns:1fr}}
svg{width:100%;height:auto;display:block}
/* Signals */
.sg{background:var(--bg2);border:1px solid var(--bd);border-radius:8px;padding:9px 11px;margin-bottom:6px}
.sh{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.st{padding:2px 7px;border-radius:4px;font-size:9px;font-weight:700}
.sd{display:flex;gap:2px;align-items:center}.sdd{width:5px;height:5px;border-radius:50%}
.sr{font-size:8px;color:var(--t3);margin-top:3px}
/* Levels */
.lg{display:grid;grid-template-columns:1fr 1fr;gap:9px}@media(max-width:600px){.lg{grid-template-columns:1fr}}
.lb{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:13px}
.lb .lt{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px}
.lr{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(28,38,64,.3);font-size:10px}
/* Backtest */
.bt-panel{background:linear-gradient(135deg,rgba(6,182,212,.04),rgba(99,102,241,.04));border:1px solid rgba(6,182,212,.15);border-radius:14px;padding:14px;margin:10px 0}
.bt-panel h3{font-size:12px;font-weight:700;margin-bottom:10px;color:var(--cy)}
.bt-controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.bt-btn{padding:6px 14px;border-radius:7px;border:1px solid var(--bd);background:var(--bg);color:var(--t2);font-family:inherit;font-size:10px;cursor:pointer}.bt-btn.on{border-color:var(--cy);color:var(--cy);background:rgba(6,182,212,.08)}
.bt-run{padding:8px 20px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--cy),var(--bl));color:#fff;font-family:'Outfit',sans-serif;font-size:11px;font-weight:700;cursor:pointer}.bt-run:active{transform:scale(.96)}
.bt-results{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:12px}
.bt-stat{padding:8px;border-radius:8px;border:1px solid var(--bd);background:var(--bg);text-align:center}
.bt-stat .bsl{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px}.bt-stat .bsv{font-size:14px;font-weight:700}
.bt-trades{max-height:200px;overflow-y:auto;margin-top:10px;font-size:9px}
.bt-trade{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(28,38,64,.15)}
/* Status */
.sts{display:flex;align-items:center;gap:4px;font-size:9px;color:var(--t3);margin-bottom:2px}
.dot{width:5px;height:5px;border-radius:50%}.dok{background:var(--g);box-shadow:0 0 6px var(--g)}.doe{background:var(--r)}.dol{background:var(--am);animation:pu 1s infinite}
/* Footer */
.ft{margin-top:16px;padding:9px 12px;background:rgba(245,158,11,.03);border:1px solid rgba(245,158,11,.08);border-radius:8px;font-size:8px;color:#92783b;line-height:1.6}
/* Toast */
.toast{position:fixed;top:env(safe-area-inset-top,10px);left:50%;transform:translateX(-50%) translateY(-100px);background:var(--bg3);border:1px solid var(--bd);border-radius:12px;padding:11px 16px;z-index:200;transition:transform .35s ease;max-width:88vw;box-shadow:0 8px 30px rgba(0,0,0,.5)}.toast.show{transform:translateX(-50%) translateY(10px)}.toast .tti{font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;margin-bottom:2px}.toast .ttb{font-size:9px;color:var(--t2)}
/* Modal */
.mo-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:100;display:none;align-items:center;justify-content:center}.mo-bg.on{display:flex}
.mo{background:var(--bg3);border:1px solid var(--bd);border-radius:16px;padding:20px;width:min(460px,92vw);max-height:76vh;overflow-y:auto}
.mo h2{font-size:17px;font-weight:700;margin-bottom:12px}.mo .xb{float:right;background:none;border:none;color:var(--t3);font-size:18px;cursor:pointer}
.mo .pg{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px}
.mo input,.mo select{width:100%;background:var(--bg);border:1px solid var(--bd);border-radius:7px;padding:8px 11px;color:var(--t);font-family:inherit;font-size:11px;outline:none;margin-bottom:6px}
@keyframes up{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes pu{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:14px;height:14px;border:2px solid var(--bd);border-top-color:var(--bl);border-radius:50%;animation:spin .6s linear infinite;display:inline-block;vertical-align:middle;margin-right:6px}
</style>
</head>
<body>
<div class="toast" id="toast"><div class="tti" id="toastT"></div><div class="ttb" id="toastB"></div></div>

<!-- SETUP - No API Key needed -->

<div class="setup" id="setup">
<h1 class="outfit">üìä CFD Analyzer Pro</h1>
<p class="sub">An√°lise t√©cnica profissional ¬∑ Gest√£o de risco ¬∑ Backtesting</p>
<div class="tags">
<span class="tag">A√ß√µes</span><span class="tag">Forex</span><span class="tag">Crypto</span><span class="tag">Commodities</span>
</div>
<button class="sb" onclick="enterApp()">Entrar ‚Äî Sem API Key</button>
<div class="hint">‚úì Sem registo ¬∑ ‚úì 100% gr√°tis ¬∑ Dados Yahoo Finance<br>Backtesting at√© 5 anos ¬∑ Gest√£o de risco integrada</div>
</div>

<!-- ADD ASSET MODAL -->

<div class="mo-bg" id="modal"><div class="mo"><button class="xb" onclick="clMo()">√ó</button><h2 class="outfit">Adicionar Ativo</h2>
<div id="pList"></div>
<div style="margin-top:10px;border-top:1px solid var(--bd);padding-top:10px">
<div style="font-size:8px;color:var(--t3);margin-bottom:5px;text-transform:uppercase;letter-spacing:.1em">Personalizado (Yahoo symbol)</div>
<div style="display:flex;gap:5px;margin-bottom:5px"><input id="cS" placeholder="S√≠mbolo (ex: AAPL, EURUSD=X)"><input id="cN" placeholder="Nome"></div>
<select id="cC"><option value="A√ß√µes">A√ß√µes</option><option value="Commodities">Commodities</option><option value="Forex">Forex</option><option value="Crypto">Crypto</option></select>
<button onclick="addC()" style="width:100%;padding:9px;border:none;border-radius:8px;background:linear-gradient(135deg,var(--bl),#8b5cf6);color:#fff;font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer">Adicionar</button>
</div></div></div>

<!-- DASHBOARD -->

<div class="d" id="dash">
<div class="hdr">
<div>
<h1>CFD Analyzer <span style="font-size:11px;color:var(--pu);font-weight:400">Pro</span></h1>
<div class="sts" id="sts"><span class="dot dol"></span> A conectar...</div>
</div>
<div class="ha">
<button class="hb" onclick="refresh()">‚Üª</button>
<button class="hb" id="abtn" onclick="togAuto()">‚ñ∂ Auto</button>
<button class="hb" id="nbtn" onclick="togNotif()">üîî</button>
<button class="hb" onclick="exportCSV()">üì• CSV</button>
<div class="rb" id="rB"><div class="rl">Recomenda√ß√£o</div><div class="rv outfit" id="rV">‚Äî</div></div>
</div>
</div>

<!-- Mode Toggle -->

<div class="mode-toggle">
<button class="mode-btn on" id="modeStock" onclick="setMode('stock')">üìà A√ß√µes (Spot)</button>
<button class="mode-btn" id="modeCFD" onclick="setMode('cfd')">‚ö° CFDs (Alavancado)</button>
</div>

<!-- Asset Grid -->

<div id="aGrid"></div>
<button class="adb" onclick="opMo()">+ Adicionar Ativo</button>

<!-- Price Card -->

<div class="pc">
<div class="pm"><div class="sn" id="pN">‚Äî</div><div class="pr" id="pP">‚Äî</div><div class="ch" id="pC">‚Äî</div></div>
<div class="ms">
<div class="me"><div class="ml">RSI</div><div class="mv" id="mR">‚Äî</div></div>
<div class="me"><div class="ml">ADX</div><div class="mv" id="mADX">‚Äî</div></div>
<div class="me"><div class="ml">ATR</div><div class="mv" id="mATR">‚Äî</div></div>
<div class="me"><div class="ml">R:R</div><div class="mv" id="mRR">‚Äî</div></div>
</div>
</div>

<!-- Risk Management -->

<div class="risk-panel" id="riskPanel">
<h3>üõ°Ô∏è Gest√£o de Risco</h3>
<div class="risk-grid">
<div class="risk-field"><label>Capital (‚Ç¨)</label><input type="number" id="rCapital" value="10000" onchange="calcRisk()"></div>
<div class="risk-field"><label>Risco/Trade (%)</label><input type="number" id="rRiskPct" value="1" step="0.5" min="0.5" max="5" onchange="calcRisk()"></div>
<div class="risk-field"><label>Alavancagem</label>
<select id="rLeverage" onchange="calcRisk()"><option value="1">1:1</option><option value="5" selected>1:5</option><option value="10">1:10</option><option value="20">1:20</option><option value="30">1:30</option></select></div>
<div class="risk-field"><label>Max Posi√ß√µes</label><input type="number" id="rMaxPos" value="3" min="1" max="10" onchange="calcRisk()"></div>
<div class="risk-field"><label>Perda Di√°ria Max (%)</label><input type="number" id="rDailyMax" value="3" step="0.5" min="1" max="10" onchange="calcRisk()"></div>
<div class="risk-field"><label>Modo</label><div id="rModeLabel" style="padding:8px 10px;font-size:11px;color:var(--pu);font-weight:600">A√ß√µes</div></div>
</div>
<div class="risk-summary" id="riskSummary"></div>
</div>

<!-- Positions -->

<div id="posSection"></div>

<!-- Action Summary -->

<div class="action-box" id="actionBox">
<h3 id="actTitle">üìã A analisar...</h3>
<div class="tf-row" id="tfRow"></div>
<div class="action-text" id="actText">A carregar...</div>
<div class="risk-row" id="riskRow"></div>
</div>

<!-- Market Status -->

<div id="marketStatus" style="margin:6px 0"></div>

<!-- Chart toggles -->

<div class="tgs">
<button class="tb on" id="tS" onclick="tgl('s')">SMA 20/50</button>
<button class="tb on" id="tB" onclick="tgl('b')">Bollinger</button>
<button class="tb" id="tF" onclick="tgl('f')">Fibonacci</button>
</div>

<!-- Tabs -->

<div class="tabs">
<button class="tt on" onclick="stab('c',this)">Gr√°fico</button>
<button class="tt" onclick="stab('s',this)">Sinais</button>
<button class="tt" onclick="stab('l',this)">N√≠veis</button>
<button class="tt" onclick="stab('bt',this)">Backtest</button>
<button class="tt" onclick="stab('st',this)">Estat√≠sticas</button>
<button class="tt" onclick="stab('h',this)">Hist√≥rico</button>
</div>

<!-- Tab: Charts -->

<div id="vc">
<div class="cb"><div class="cbl">Pre√ßo ¬∑ Velas Di√°rias</div><div id="mC"></div></div>
<div class="sc">
<div class="cb"><div class="cbl">RSI (14)</div><div id="rC"></div></div>
<div class="cb"><div class="cbl">MACD (12,26,9)</div><div id="maC"></div></div>
</div>
</div>
<!-- Tab: Signals -->
<div id="vs" style="display:none"></div>
<!-- Tab: Levels -->
<div id="vl" style="display:none"></div>
<!-- Tab: Backtest -->
<div id="vbt" style="display:none">
<div class="bt-panel">
<h3>üî¨ Backtesting</h3>
<div class="bt-controls">
<button class="bt-btn on" id="bt2y" onclick="setBtPeriod(2,this)">2 anos</button>
<button class="bt-btn" id="bt3y" onclick="setBtPeriod(3,this)">3 anos</button>
<button class="bt-btn" id="bt5y" onclick="setBtPeriod(5,this)">5 anos</button>
<span style="font-size:9px;color:var(--t3)" id="btModeLabel">Modo: A√ß√µes</span>
<button class="bt-run" onclick="runBacktest()">‚ñ∂ Executar</button>
</div>
<div id="btResults"></div>
</div>
</div>
<!-- Tab: Statistics -->
<div id="vst" style="display:none"></div>
<!-- Tab: History -->
<div id="vh" style="display:none"></div>

<div class="ft">‚ö†Ô∏è <strong>Aviso:</strong> An√°lise t√©cnica automatizada para apoio a decis√µes. N√£o garante resultados. CFDs envolvem risco significativo de perda. Consulte um profissional.</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CFD ANALYZER PRO ‚Äî Yahoo Finance Edition
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var sel='AAPL',shS=true,shB=true,shF=false,aR=false,aI=null,nO=false,prevSig={};
var MIN_SIG=4,curPrice=0,curDP=2,tradeMode='stock',btPeriod=2;
var lastCandles=null,lastWeekly=null,lastIndicators=null;

// Positions & history
var positions=[],tradeHistory=[],dailyPnL=0,dailyPnLDate='';

// XTB spreads (in price units, approximate)
var XTB_SPREADS={
 'AAPL':0.5,'MSFT':0.5,'GOOGL':1,'TSLA':1,'AMZN':1,'NVDA':0.5,'META':0.5,'AMD':0.3,'NFLX':1,'JPM':0.3,
 'BA':0.5,'DIS':0.3,'V':0.3,'NKE':0.3,'GC=F':0.5,'SI=F':0.02,'CL=F':0.04,'EURUSD=X':0.00012,
 'GBPUSD=X':0.00015,'BTC-USD':50,'ETH-USD':2,'SOL-USD':0.3
};

// Assets configuration
var A={"A√ß√µes":[
{s:"AAPL",n:"Apple",e:"üçé",c:"A√ß√µes"},{s:"MSFT",n:"Microsoft",e:"ü™ü",c:"A√ß√µes"},
{s:"GOOGL",n:"Alphabet",e:"üîç",c:"A√ß√µes"},{s:"TSLA",n:"Tesla",e:"‚ö°",c:"A√ß√µes"},
{s:"AMZN",n:"Amazon",e:"üì¶",c:"A√ß√µes"},{s:"NVDA",n:"Nvidia",e:"üü¢",c:"A√ß√µes"}]};

var PRE=[
{s:"META",n:"Meta",e:"üåê",c:"A√ß√µes"},{s:"AMD",n:"AMD",e:"üî¥",c:"A√ß√µes"},
{s:"NFLX",n:"Netflix",e:"üé¨",c:"A√ß√µes"},{s:"JPM",n:"JP Morgan",e:"üè¶",c:"A√ß√µes"},
{s:"BA",n:"Boeing",e:"‚úàÔ∏è",c:"A√ß√µes"},{s:"DIS",n:"Disney",e:"üè∞",c:"A√ß√µes"},
{s:"V",n:"Visa",e:"üí≥",c:"A√ß√µes"},{s:"NKE",n:"Nike",e:"üëü",c:"A√ß√µes"},
{s:"GC=F",n:"Ouro",e:"ü•á",c:"Commodities"},{s:"SI=F",n:"Prata",e:"ü•à",c:"Commodities"},
{s:"CL=F",n:"Petr√≥leo",e:"üõ¢Ô∏è",c:"Commodities"},
{s:"EURUSD=X",n:"EUR/USD",e:"üí∂",c:"Forex"},{s:"GBPUSD=X",n:"GBP/USD",e:"üí∑",c:"Forex"},
{s:"BTC-USD",n:"Bitcoin",e:"‚Çø",c:"Crypto"},{s:"ETH-USD",n:"Ethereum",e:"‚ü†",c:"Crypto"},
{s:"SOL-USD",n:"Solana",e:"‚óé",c:"Crypto"}];

// CORS proxies for Yahoo Finance
var PROXIES=[
'https://corsproxy.io/?url=',
'https://api.allorigins.win/raw?url=',
'https://api.codetabs.com/v1/proxy?quest='
];
var proxyIdx=0;

// ‚ïê‚ïê‚ïê PERSISTENCE ‚ïê‚ïê‚ïê
try{var a=localStorage.getItem('cfd_assets');if(a)A=JSON.parse(a)}catch(e){}
try{var s=localStorage.getItem('cfd_sel');if(s)sel=s}catch(e){}
try{var p=localStorage.getItem('cfd_pos');if(p)positions=JSON.parse(p)}catch(e){}
try{var h=localStorage.getItem('cfd_hist');if(h)tradeHistory=JSON.parse(h)}catch(e){}
try{var m=localStorage.getItem('cfd_mode');if(m)tradeMode=m}catch(e){}
try{var rc=localStorage.getItem('cfd_risk');if(rc){var rk=JSON.parse(rc);document.addEventListener('DOMContentLoaded',function(){if(rk.capital)document.getElementById('rCapital').value=rk.capital;if(rk.riskPct)document.getElementById('rRiskPct').value=rk.riskPct;if(rk.leverage)document.getElementById('rLeverage').value=rk.leverage;if(rk.maxPos)document.getElementById('rMaxPos').value=rk.maxPos;if(rk.dailyMax)document.getElementById('rDailyMax').value=rk.dailyMax})}}catch(e){}

function save(){try{localStorage.setItem('cfd_assets',JSON.stringify(A));localStorage.setItem('cfd_sel',sel);localStorage.setItem('cfd_mode',tradeMode)}catch(e){}}
function savePos(){try{localStorage.setItem('cfd_pos',JSON.stringify(positions));localStorage.setItem('cfd_hist',JSON.stringify(tradeHistory))}catch(e){}}
function saveRisk(){try{localStorage.setItem('cfd_risk',JSON.stringify({capital:document.getElementById('rCapital').value,riskPct:document.getElementById('rRiskPct').value,leverage:document.getElementById('rLeverage').value,maxPos:document.getElementById('rMaxPos').value,dailyMax:document.getElementById('rDailyMax').value}))}catch(e){}}

// ‚ïê‚ïê‚ïê APP ENTRY ‚ïê‚ïê‚ïê
function enterApp(){
 document.getElementById('setup').style.display='none';
 document.getElementById('dash').classList.add('on');
 if(tradeMode==='cfd'){document.getElementById('modeCFD').classList.add('on');document.getElementById('modeStock').classList.remove('on')}
 renderA();calcRisk();refresh();
}

function setMode(m){
 tradeMode=m;save();
 document.getElementById('modeStock').classList.toggle('on',m==='stock');
 document.getElementById('modeCFD').classList.toggle('on',m==='cfd');
 document.getElementById('rModeLabel').textContent=m==='stock'?'A√ß√µes':'CFDs';
 document.getElementById('btModeLabel').textContent='Modo: '+(m==='stock'?'A√ß√µes':'CFDs');
 calcRisk();refresh();
}

// ‚ïê‚ïê‚ïê YAHOO FINANCE DATA ‚ïê‚ïê‚ïê
async function yahooFetch(url){
 for(var i=0;i<PROXIES.length;i++){
  var pi=(proxyIdx+i)%PROXIES.length;
  try{
   var r=await fetch(PROXIES[pi]+encodeURIComponent(url),{signal:AbortSignal.timeout(12000)});
   if(r.ok){proxyIdx=pi;return await r.json()}
  }catch(e){}
 }
 return null;
}

async function getCandles(sym,days){
 days=days||250;
 var period1=Math.floor((Date.now()-days*86400000)/1000);
 var period2=Math.floor(Date.now()/1000);
 var url='https://query1.finance.yahoo.com/v8/finance/chart/'+encodeURIComponent(sym)+'?period1='+period1+'&period2='+period2+'&interval=1d';
 var d=await yahooFetch(url);
 if(!d||!d.chart||!d.chart.result||!d.chart.result[0])return null;
 var res=d.chart.result[0],ts=res.timestamp,q=res.indicators.quote[0];
 if(!ts||!q||!q.close)return null;
 var candles=[];
 for(var i=0;i<ts.length;i++){
  if(q.close[i]==null)continue;
  candles.push({date:new Date(ts[i]*1000).toISOString().split('T')[0],open:q.open[i]||q.close[i],high:q.high[i]||q.close[i],low:q.low[i]||q.close[i],close:q.close[i],volume:q.volume?q.volume[i]||0:0});
 }
 return candles.length>20?candles:null;
}

async function getWeekly(sym){
 var period1=Math.floor((Date.now()-600*86400000)/1000);
 var period2=Math.floor(Date.now()/1000);
 var url='https://query1.finance.yahoo.com/v8/finance/chart/'+encodeURIComponent(sym)+'?period1='+period1+'&period2='+period2+'&interval=1wk';
 var d=await yahooFetch(url);
 if(!d||!d.chart||!d.chart.result||!d.chart.result[0])return null;
 var res=d.chart.result[0],ts=res.timestamp,q=res.indicators.quote[0];
 if(!ts||!q||!q.close)return null;
 var candles=[];
 for(var i=0;i<ts.length;i++){
  if(q.close[i]==null)continue;
  candles.push({date:new Date(ts[i]*1000).toISOString().split('T')[0],open:q.open[i]||q.close[i],high:q.high[i]||q.close[i],low:q.low[i]||q.close[i],close:q.close[i],volume:q.volume?q.volume[i]||0:0});
 }
 return candles.length>10?candles:null;
}

async function getCandlesLong(sym,years){
 var days=years*365+30;
 return getCandles(sym,days);
}

// ‚ïê‚ïê‚ïê MARKET HOURS ‚ïê‚ïê‚ïê
function getMarketStatus(sym){
 var now=new Date();
 var utcH=now.getUTCHours(),utcM=now.getUTCMinutes(),day=now.getUTCDay();
 var t=utcH*60+utcM;
 if(sym.indexOf('-USD')>=0)return{open:true,label:'Crypto 24/7',cls:'dok'};
 if(sym.indexOf('=X')>=0){
  if(day===0||(day===6&&t>1260)||(day===5&&t>1260))return{open:false,label:'Forex fechado',cls:'doe'};
  return{open:true,label:'Forex aberto',cls:'dok'};
 }
 if(sym.indexOf('=F')>=0){
  if(day===0||day===6)return{open:false,label:'Commodities fechado',cls:'doe'};
  return{open:true,label:'Commodities',cls:'dok'};
 }
 // US stocks: 14:30-21:00 UTC
 if(day===0||day===6)return{open:false,label:'Mercado fechado',cls:'doe'};
 if(t>=870&&t<1260)return{open:true,label:'NYSE/NASDAQ aberto',cls:'dok'};
 if(t>=840&&t<870)return{open:false,label:'Pr√©-mercado',cls:'dol'};
 if(t>=1260&&t<1320)return{open:false,label:'After-hours',cls:'dol'};
 return{open:false,label:'Mercado fechado',cls:'doe'};
}

// ‚ïê‚ïê‚ïê INDICATORS ‚ïê‚ïê‚ïê
function _SMA(d,n){return d.map(function(_,i){if(i<n-1)return null;var s=0;for(var j=i-n+1;j<=i;j++)s+=d[j].close;return s/n})}
function _EMA(d,n){var k=2/(n+1),r=[],p=null;d.forEach(function(x,i){if(i<n-1){r.push(null);return}if(p===null){var s=0;for(var j=i-n+1;j<=i;j++)s+=d[j].close;p=s/n}else p=x.close*k+p*(1-k);r.push(p)});return r}
function _RSI(d,n){n=n||14;var r=[],ag=0,al=0;for(var i=0;i<d.length;i++){if(!i){r.push(null);continue}var c=d[i].close-d[i-1].close,g=c>0?c:0,l=c<0?-c:0;if(i<=n){ag+=g;al+=l;if(i===n){ag/=n;al/=n;r.push(al===0?100:+(100-100/(1+ag/al)).toFixed(2))}else r.push(null)}else{ag=(ag*(n-1)+g)/n;al=(al*(n-1)+l)/n;r.push(al===0?100:+(100-100/(1+ag/al)).toFixed(2))}}return r}
function _MACD(d){var e12=_EMA(d,12),e26=_EMA(d,26);var ml=e12.map(function(v,i){return(v!=null&&e26[i]!=null)?v-e26[i]:null});var k=2/10,sg=null;var sl=ml.map(function(v){if(v==null)return null;sg=sg==null?v:v*k+sg*(1-k);return sg});var h=ml.map(function(v,i){return(v!=null&&sl[i]!=null)?v-sl[i]:null});return{ml:ml,sl:sl,h:h}}
function _BOLL(d,n,m){n=n||20;m=m||2;return d.map(function(_,i){if(i<n-1)return{u:null,l:null};var s=d.slice(i-n+1,i+1).map(function(x){return x.close});var mn=s.reduce(function(a,v){return a+v},0)/n;var st=Math.sqrt(s.reduce(function(a,v){return a+(v-mn)*(v-mn)},0)/n);return{u:mn+m*st,l:mn-m*st}})}
function _FIB(d){
 // Use last 60 candles for more relevant levels
 var recent=d.slice(-60);
 var mx=-Infinity,mn=Infinity;
 recent.forEach(function(x){if(x.high>mx)mx=x.high;if(x.low<mn)mn=x.low});
 var df=mx-mn;
 return{"0%":mx,"23.6%":mx-df*.236,"38.2%":mx-df*.382,"50%":mx-df*.5,"61.8%":mx-df*.618,"78.6%":mx-df*.786,"100%":mn}
}
function _SR(d){var s=d.slice(-40).map(function(x){return x.close}).sort(function(a,b){return a-b}),l=s.length;return{suporteForte:s[Math.floor(l*.05)],suporte:s[Math.floor(l*.2)],resistencia:s[Math.floor(l*.8)],resistenciaForte:s[Math.floor(l*.95)]}}
function _ATR(d,n){n=n||14;var r=[];for(var i=0;i<d.length;i++){if(i===0){r.push(null);continue}var tr=Math.max(d[i].high-d[i].low,Math.abs(d[i].high-d[i-1].close),Math.abs(d[i].low-d[i-1].close));if(i<n){r.push(null);continue}if(i===n){var s=0;for(var j=1;j<=n;j++){s+=Math.max(d[j].high-d[j].low,Math.abs(d[j].high-d[j-1].close),Math.abs(d[j].low-d[j-1].close))}r.push(s/n)}else{r.push((r[i-1]*(n-1)+tr)/n)}}return r}
function _ADX(d,n){n=n||14;var r=[];for(var i=0;i<d.length;i++){if(i<n*2){r.push(null);continue}var sl=d.slice(i-n*2,i+1),pDM=0,nDM=0,tr=0;for(var j=1;j<sl.length;j++){var up=sl[j].high-sl[j-1].high,dn=sl[j-1].low-sl[j].low;pDM+=(up>dn&&up>0)?up:0;nDM+=(dn>up&&dn>0)?dn:0;tr+=Math.max(sl[j].high-sl[j].low,Math.abs(sl[j].high-sl[j-1].close),Math.abs(sl[j].low-sl[j-1].close))}if(tr===0){r.push(0);continue}var pDI=100*pDM/tr,nDI=100*nDM/tr;r.push(+((Math.abs(pDI-nDI)/(pDI+nDI||1))*100).toFixed(1))}return r}

// ‚ïê‚ïê‚ïê SIGNAL ENGINE ‚ïê‚ïê‚ïê
function _SIGS(d,rsi,macd,boll,s20,s50,atr,adx,mode){
 var sg=[];
 for(var i=2;i<d.length;i++){
  var sc=0,re=[],conf=0,total=0;
  // RSI
  if(rsi[i]!=null&&rsi[i-1]!=null){total++;
   if(rsi[i]<30){sc+=2;re.push("RSI sobrevendido ("+rsi[i].toFixed(0)+")");conf++}
   else if(rsi[i]>70){sc-=2;re.push("RSI sobrecomprado ("+rsi[i].toFixed(0)+")");conf++}
   else if(rsi[i]<40&&rsi[i]>rsi[i-1]){sc+=1;re.push("RSI ‚Üë");conf+=.5}
   else if(rsi[i]>60&&rsi[i]<rsi[i-1]){sc-=1;re.push("RSI ‚Üì");conf+=.5}
  }
  // MACD crossover
  if(macd.ml[i]!=null&&macd.sl[i]!=null&&macd.ml[i-1]!=null&&macd.sl[i-1]!=null){total++;
   if(macd.ml[i]>macd.sl[i]&&macd.ml[i-1]<=macd.sl[i-1]){sc+=2;re.push("MACD cruzou ‚Üë");conf++}
   if(macd.ml[i]<macd.sl[i]&&macd.ml[i-1]>=macd.sl[i-1]){sc-=2;re.push("MACD cruzou ‚Üì");conf++}
   // Histogram momentum
   if(macd.h[i]!=null&&macd.h[i-1]!=null){
    if(macd.h[i]>0&&macd.h[i]>macd.h[i-1]){sc+=1;re.push("MACD momentum +")}
    if(macd.h[i]<0&&macd.h[i]<macd.h[i-1]){sc-=1;re.push("MACD momentum -")}
   }
  }
  // Bollinger
  if(boll[i].l!=null){total++;
   if(d[i].close<=boll[i].l){sc+=2;re.push("Bollinger inferior");conf++}
   if(d[i].close>=boll[i].u){sc-=2;re.push("Bollinger superior");conf++}
  }
  // SMA Cross
  if(s20[i]!=null&&s50[i]!=null&&s20[i-1]!=null&&s50[i-1]!=null){total++;
   if(s20[i]>s50[i]&&s20[i-1]<=s50[i-1]){sc+=2;re.push("Golden Cross");conf++}
   if(s20[i]<s50[i]&&s20[i-1]>=s50[i-1]){sc-=2;re.push("Death Cross");conf++}
   if(d[i].close>s20[i]&&s20[i]>s50[i]){sc+=1;re.push("Tend√™ncia ‚Üë")}
   if(d[i].close<s20[i]&&s20[i]<s50[i]){sc-=1;re.push("Tend√™ncia ‚Üì")}
  }
  // Volume spike
  if(i>=10&&d[i].volume>0){var av=0;for(var j=i-10;j<i;j++)av+=d[j].volume;av/=10;
   if(av>0&&d[i].volume>av*1.8){var dir=d[i].close>d[i].open?1:-1;sc+=dir;re.push(dir>0?"Volume alto ‚Üë":"Volume alto ‚Üì");conf+=.5}
  }
  // ADX filter
  var adxV=adx[i];
  if(adxV!=null){
   if(adxV>25&&Math.abs(sc)>=2){sc+=sc>0?1:-1;re.push("ADX forte ("+adxV+")")}
   if(adxV<15){sc=Math.round(sc*.5);re.push("ADX fraco ("+adxV+") ‚Äî cautela")}
  }
  // STOCK MODE: only long, require SMA20>SMA50
  if(mode==='stock'&&sc<0)continue;
  if(mode==='stock'&&s20[i]!=null&&s50[i]!=null&&s20[i]<s50[i])continue;
  // Stock mode RSI filter: 40-60 zone = cautela
  if(mode==='stock'&&rsi[i]!=null&&(rsi[i]<40||rsi[i]>60)){/* ok */}
  
  var confPct=total>0?Math.round((conf/total)*100):0;
  if(Math.abs(sc)>=MIN_SIG){
   var atrV=atr[i],sl=null,tp=null,tp2=null;
   var spread=XTB_SPREADS[sel]||0;
   if(atrV){
    if(sc>0){sl=d[i].close-atrV*1.5-spread;tp=d[i].close+atrV*2-spread;tp2=d[i].close+atrV*3-spread}
    else{sl=d[i].close+atrV*1.5+spread;tp=d[i].close-atrV*2+spread;tp2=d[i].close-atrV*3+spread}
   }
   sg.push({idx:i,date:d[i].date,price:d[i].close,type:sc>0?"BUY":"SELL",str:Math.min(Math.abs(sc),8),reasons:re,conf:confPct,sl:sl,tp:tp,tp2:tp2,atr:atrV});
  }
 }
 return sg;
}

// Multi-timeframe analysis
function analyzeTF(candles,label){
 if(!candles||candles.length<30)return{label:label,bias:'Neutro',details:'Dados insuficientes',score:0};
 var s20=_SMA(candles,20),s50=_SMA(candles,50),rsi=_RSI(candles);
 var last=candles.length-1,lp=candles[last].close,score=0,notes=[];
 if(s20[last]!=null&&s50[last]!=null){
  if(s20[last]>s50[last]&&lp>s20[last]){score+=2;notes.push('SMA ‚Üë')}
  else if(s20[last]<s50[last]&&lp<s20[last]){score-=2;notes.push('SMA ‚Üì')}
  else notes.push('Lateral')
 }
 var lRSI=null;for(var i=rsi.length-1;i>=0;i--){if(rsi[i]!=null){lRSI=rsi[i];break}}
 if(lRSI!=null){if(lRSI<30){score+=1;notes.push('RSI '+lRSI.toFixed(0))}else if(lRSI>70){score-=1;notes.push('RSI '+lRSI.toFixed(0))}else notes.push('RSI '+lRSI.toFixed(0))}
 return{label:label,bias:score>1?'Bullish':score<-1?'Bearish':'Neutro',details:notes.join(' ¬∑ '),score:score}
}

// ‚ïê‚ïê‚ïê RISK MANAGEMENT ‚ïê‚ïê‚ïê
function calcRisk(){
 var cap=parseFloat(document.getElementById('rCapital').value)||10000;
 var rPct=parseFloat(document.getElementById('rRiskPct').value)||1;
 var lev=parseFloat(document.getElementById('rLeverage').value)||5;
 var maxPos=parseInt(document.getElementById('rMaxPos').value)||3;
 var dailyMax=parseFloat(document.getElementById('rDailyMax').value)||3;
 
 var riskPerTrade=cap*(rPct/100);
 var maxExposure=cap*lev;
 var maxLossDay=cap*(dailyMax/100);
 var posSize=maxExposure/maxPos;
 
 var h='<div class="risk-chip"><div class="rcl">Risco/Trade</div><div class="rcv" style="color:var(--am)">‚Ç¨'+riskPerTrade.toFixed(0)+'</div></div>';
 h+='<div class="risk-chip"><div class="rcl">Exposi√ß√£o Max</div><div class="rcv" style="color:var(--cy)">‚Ç¨'+maxExposure.toFixed(0)+'</div></div>';
 h+='<div class="risk-chip"><div class="rcl">Pos. Max</div><div class="rcv" style="color:var(--pu)">‚Ç¨'+posSize.toFixed(0)+'</div></div>';
 h+='<div class="risk-chip"><div class="rcl">Perda Di√°ria Max</div><div class="rcv" style="color:var(--r)">‚Ç¨'+maxLossDay.toFixed(0)+'</div></div>';
 document.getElementById('riskSummary').innerHTML=h;
 saveRisk();
}

function checkDailyLimit(){
 var today=new Date().toISOString().split('T')[0];
 if(dailyPnLDate!==today){dailyPnL=0;dailyPnLDate=today}
 var cap=parseFloat(document.getElementById('rCapital').value)||10000;
 var dailyMax=parseFloat(document.getElementById('rDailyMax').value)||3;
 var maxLoss=cap*(dailyMax/100);
 if(dailyPnL<=-maxLoss){toast('üö® Limite di√°rio','Perda di√°ria atingiu ‚Ç¨'+Math.abs(dailyPnL).toFixed(2)+' ‚Äî PARAR de operar!');return true}
 return false;
}

function checkMaxPositions(){
 var maxPos=parseInt(document.getElementById('rMaxPos').value)||3;
 var open=positions.filter(function(p){return!p.closed}).length;
 return open>=maxPos;
}

// ‚ïê‚ïê‚ïê POSITION MANAGER ‚ïê‚ïê‚ïê
function openPosition(type,units,price,sl,tp,tp2){
 if(checkDailyLimit()){toast('‚ö†Ô∏è','Limite di√°rio atingido');return}
 if(checkMaxPositions()){toast('‚ö†Ô∏è','M√°x posi√ß√µes atingido');return}
 var pos={id:Date.now(),symbol:sel,type:type,units:parseFloat(units),entryPrice:parseFloat(price),
  entryDate:new Date().toISOString().split('T')[0],sl:sl?parseFloat(sl):null,tp:tp?parseFloat(tp):null,tp2:tp2?parseFloat(tp2):null,closed:false,trailingStop:false,trailDist:null};
 positions.push(pos);savePos();renderPos();toast('üìä Posi√ß√£o aberta',type+' '+units+'x '+sel+' @ '+price)
}

function closePosition(id,exitPrice){
 var pos=positions.find(function(p){return p.id===id});if(!pos)return;
 pos.closed=true;pos.exitPrice=exitPrice||curPrice;pos.exitDate=new Date().toISOString().split('T')[0];
 var pnl=pos.type==='BUY'?(pos.exitPrice-pos.entryPrice)*pos.units:(pos.entryPrice-pos.exitPrice)*pos.units;
 // Subtract spread
 var spread=XTB_SPREADS[pos.symbol]||0;
 pnl-=spread*pos.units;
 dailyPnL+=pnl;
 tradeHistory.push({symbol:pos.symbol,type:pos.type,units:pos.units,entry:pos.entryPrice,exit:pos.exitPrice,
  entryDate:pos.entryDate,exitDate:pos.exitDate,pnl:+pnl.toFixed(2)});
 positions=positions.filter(function(p){return p.id!==id});savePos();renderPos();renderHist();
 toast(pnl>=0?'üí∞ Lucro!':'üìâ Perda',(pnl>=0?'+':'')+pnl.toFixed(2))
}

function checkPositionAlerts(price){
 positions.forEach(function(pos){if(pos.closed||pos.symbol!==sel)return;
  // Trailing stop update
  if(pos.trailingStop&&pos.trailDist){
   if(pos.type==='BUY'&&price-pos.trailDist>pos.sl){pos.sl=price-pos.trailDist;savePos()}
   if(pos.type==='SELL'&&price+pos.trailDist<pos.sl){pos.sl=price+pos.trailDist;savePos()}
  }
  if(pos.sl!=null){if((pos.type==='BUY'&&price<=pos.sl)||(pos.type==='SELL'&&price>=pos.sl)){
   toast('üö® STOP-LOSS atingido!',pos.symbol+' @ '+price.toFixed(curDP));
   if(nO)try{new Notification('üö® SL ‚Äî '+pos.symbol,{body:'Pre√ßo: '+price.toFixed(curDP)+' | SL: '+pos.sl.toFixed(curDP)})}catch(e){}}}
  if(pos.tp!=null){if((pos.type==='BUY'&&price>=pos.tp)||(pos.type==='SELL'&&price<=pos.tp)){
   toast('üéØ TP1 atingido!',pos.symbol+' @ '+price.toFixed(curDP));
   if(nO)try{new Notification('üéØ TP1 ‚Äî '+pos.symbol,{body:'Pre√ßo: '+price.toFixed(curDP)})}catch(e){}}}
 })
}

function renderPos(){
 var myPos=positions.filter(function(p){return p.symbol===sel&&!p.closed});
 if(!myPos.length){document.getElementById('posSection').innerHTML='<div style="margin:8px 0"><button class="pos-btn" style="background:linear-gradient(135deg,var(--g),#059669);color:#fff;width:100%;padding:10px" onclick="showPosForm()">üìä Registar Posi√ß√£o</button></div>';return}
 var h='<div class="pos-box"><h3>üìä Posi√ß√µes Abertas ('+myPos.length+')</h3>';
 myPos.forEach(function(pos){
  var pnl=pos.type==='BUY'?(curPrice-pos.entryPrice)*pos.units:(pos.entryPrice-curPrice)*pos.units;
  var spread=XTB_SPREADS[pos.symbol]||0;pnl-=spread*pos.units;
  var pnlPct=((pos.type==='BUY'?(curPrice-pos.entryPrice):(pos.entryPrice-curPrice))/pos.entryPrice*100);
  var isProfit=pnl>=0;
  h+='<div class="pos-card"><div class="pos-header"><div><span style="font-size:9px;padding:2px 6px;border-radius:4px;background:'+(pos.type==='BUY'?'rgba(16,185,129,.1);color:var(--g)':'rgba(239,68,68,.1);color:var(--r)')+'">'+pos.type+'</span> <span style="font-size:10px;color:var(--t2)">'+pos.units+'x @ '+pos.entryPrice.toFixed(curDP)+'</span></div>';
  h+='<div class="pos-pnl" style="color:'+(isProfit?'var(--g)':'var(--r)')+'">‚Ç¨'+(pnl>=0?'+':'')+pnl.toFixed(2)+' ('+(pnlPct>=0?'+':'')+pnlPct.toFixed(2)+'%)</div></div>';
  h+='<div class="pos-details">Aberta: '+pos.entryDate+' ¬∑ Pre√ßo: '+curPrice.toFixed(curDP)+(pos.trailingStop?' ¬∑ üîÑ Trailing':'')+'</div>';
  h+='<div class="pos-targets">';
  if(pos.sl!=null){var slHit=(pos.type==='BUY'&&curPrice<=pos.sl)||(pos.type==='SELL'&&curPrice>=pos.sl);h+='<span class="pos-target" style="'+(slHit?'border-color:var(--r);color:var(--r);animation:pu 1s infinite':'')+'">SL: '+pos.sl.toFixed(curDP)+'</span>'}
  if(pos.tp!=null){var tpHit=(pos.type==='BUY'&&curPrice>=pos.tp)||(pos.type==='SELL'&&curPrice<=pos.tp);h+='<span class="pos-target" style="'+(tpHit?'border-color:var(--g);color:var(--g);animation:pu 1s infinite':'')+'">TP1: '+pos.tp.toFixed(curDP)+'</span>'}
  if(pos.tp2!=null)h+='<span class="pos-target">TP2: '+pos.tp2.toFixed(curDP)+'</span>';
  h+='</div>';
  if(pos.sl!=null&&((pos.type==='BUY'&&curPrice<=pos.sl)||(pos.type==='SELL'&&curPrice>=pos.sl)))
   h+='<div class="pos-alert" style="background:rgba(239,68,68,.1);color:var(--r);border:1px solid rgba(239,68,68,.3)">üö® STOP-LOSS ATINGIDO ‚Äî Fechar imediatamente!</div>';
  if(pos.tp!=null&&((pos.type==='BUY'&&curPrice>=pos.tp)||(pos.type==='SELL'&&curPrice<=pos.tp)))
   h+='<div class="pos-alert" style="background:rgba(16,185,129,.1);color:var(--g);border:1px solid rgba(16,185,129,.3)">üéØ TAKE-PROFIT ATINGIDO</div>';
  h+='<div style="display:flex;gap:6px;margin-top:8px"><button class="pos-btn" style="background:rgba(239,68,68,.1);color:var(--r);border:1px solid rgba(239,68,68,.2);flex:1" onclick="closePosition('+pos.id+')">Fechar</button></div></div>'
 });
 h+='<button class="pos-btn" style="background:linear-gradient(135deg,var(--bl),#8b5cf6);color:#fff;width:100%;margin-top:4px;padding:10px" onclick="showPosForm()">+ Nova Posi√ß√£o</button></div>';
 document.getElementById('posSection').innerHTML=h
}

function showPosForm(){
 var info=getI(sel);
 var recSL='',recTP='';
 document.getElementById('posSection').innerHTML='<div class="pos-box"><h3>üìä Registar Posi√ß√£o ‚Äî '+info.e+' '+info.n+'</h3>'
 +'<div class="pos-form">'
 +'<div><label>Tipo</label><select id="pfType" style="width:100%;background:var(--bg);border:1px solid var(--bd);border-radius:6px;padding:7px;color:var(--t);font-family:inherit;font-size:10px">'+(tradeMode==='stock'?'<option value="BUY">COMPRA (Long)</option>':'<option value="BUY">COMPRA (Long)</option><option value="SELL">VENDA (Short)</option>')+'</select></div>'
 +'<div><label>Unidades</label><input id="pfUnits" type="number" placeholder="ex: 10" step="any"></div>'
 +'<div><label>Pre√ßo Entrada</label><input id="pfPrice" type="number" placeholder="'+curPrice.toFixed(curDP)+'" step="any" value="'+curPrice.toFixed(curDP)+'"></div>'
 +'<div><label>Stop-Loss</label><input id="pfSL" type="number" placeholder="Opcional" step="any"></div>'
 +'<div><label>Take-Profit</label><input id="pfTP" type="number" placeholder="Opcional" step="any"></div>'
 +'<div><label>Trailing Stop</label><select id="pfTrail" style="width:100%;background:var(--bg);border:1px solid var(--bd);border-radius:6px;padding:7px;color:var(--t);font-family:inherit;font-size:10px"><option value="0">N√£o</option><option value="1">Sim</option></select></div>'
 +'</div>'
 +'<div style="display:flex;gap:6px;margin-top:10px">'
 +'<button class="pos-btn" style="background:linear-gradient(135deg,var(--g),#059669);color:#fff;flex:1;padding:10px" onclick="submitPos()">Confirmar</button>'
 +'<button class="pos-btn" style="background:var(--bg);color:var(--t3);border:1px solid var(--bd);flex:1;padding:10px" onclick="renderPos()">Cancelar</button>'
 +'</div></div>'
}

function submitPos(){
 var type=document.getElementById('pfType').value;
 var units=document.getElementById('pfUnits').value;
 var price=document.getElementById('pfPrice').value;
 var sl=document.getElementById('pfSL').value;
 var tp=document.getElementById('pfTP').value;
 var trail=document.getElementById('pfTrail').value==='1';
 if(!units||!price||parseFloat(units)<=0){toast('‚ö†Ô∏è','Preenche unidades e pre√ßo');return}
 // Position size validation
 var cap=parseFloat(document.getElementById('rCapital').value)||10000;
 var lev=parseFloat(document.getElementById('rLeverage').value)||5;
 var maxPos=parseInt(document.getElementById('rMaxPos').value)||3;
 var posValue=parseFloat(units)*parseFloat(price);
 var maxPosSize=(cap*lev)/maxPos;
 if(posValue>maxPosSize*1.1){toast('‚ö†Ô∏è','Posi√ß√£o excede limite (‚Ç¨'+maxPosSize.toFixed(0)+')');return}
 openPosition(type,units,price,sl||null,tp||null,null);
 if(trail&&sl){
  var p=positions[positions.length-1];
  p.trailingStop=true;
  p.trailDist=Math.abs(parseFloat(price)-parseFloat(sl));
  savePos();
 }
}

// ‚ïê‚ïê‚ïê TRADE HISTORY ‚ïê‚ïê‚ïê
function renderHist(){
 var allHist=tradeHistory.slice(-30).reverse();
 var totalPnl=tradeHistory.reduce(function(s,t){return s+t.pnl},0);
 var wins=tradeHistory.filter(function(t){return t.pnl>0}).length;
 var total=tradeHistory.length;
 var h='<div class="lb"><div class="lt">Hist√≥rico de Trades</div>';
 if(!total){h+='<div style="font-size:10px;color:var(--t3);padding:10px 0">Nenhum trade fechado.</div>'}
 else{
  h+='<div style="display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap">';
  h+='<div class="risk-pill"><div class="rpl">P&L Total</div><div class="rpv" style="color:'+(totalPnl>=0?'var(--g)':'var(--r)')+'">'+(totalPnl>=0?'+':'')+totalPnl.toFixed(2)+'</div></div>';
  h+='<div class="risk-pill"><div class="rpl">Win Rate</div><div class="rpv" style="color:'+(wins/total>.5?'var(--g)':'var(--am)')+'">'+Math.round(wins/total*100)+'%</div></div>';
  h+='<div class="risk-pill"><div class="rpl">Trades</div><div class="rpv">'+total+'</div></div></div>';
  allHist.forEach(function(t){
   h+='<div class="hist-item"><div><span style="color:'+(t.type==='BUY'?'var(--g)':'var(--r)')+'">'+t.type+'</span> '+t.symbol+' '+t.units+'x</div>';
   h+='<div style="text-align:right"><div style="color:'+(t.pnl>=0?'var(--g)':'var(--r)')+'">'+(t.pnl>=0?'+':'')+t.pnl.toFixed(2)+'</div>';
   h+='<div style="font-size:7px;color:var(--t3)">'+t.entry.toFixed(2)+' ‚Üí '+t.exit.toFixed(2)+' ¬∑ '+t.exitDate+'</div></div></div>'
  })
 }
 h+='</div>';document.getElementById('vh').innerHTML=h
}

// ‚ïê‚ïê‚ïê STATISTICS TAB ‚ïê‚ïê‚ïê
function renderStats(){
 if(!tradeHistory.length){document.getElementById('vst').innerHTML='<div class="lb"><div class="lt">Estat√≠sticas</div><div style="font-size:10px;color:var(--t3);padding:10px 0">Sem dados. Feche trades para ver estat√≠sticas.</div></div>';return}
 var wins=tradeHistory.filter(function(t){return t.pnl>0});
 var losses=tradeHistory.filter(function(t){return t.pnl<=0});
 var avgWin=wins.length?wins.reduce(function(s,t){return s+t.pnl},0)/wins.length:0;
 var avgLoss=losses.length?Math.abs(losses.reduce(function(s,t){return s+t.pnl},0)/losses.length):0;
 var pf=avgLoss>0?(wins.reduce(function(s,t){return s+t.pnl},0))/(Math.abs(losses.reduce(function(s,t){return s+t.pnl},0))||1):0;
 var totalPnl=tradeHistory.reduce(function(s,t){return s+t.pnl},0);
 var maxDD=0,peak=0,running=0;
 tradeHistory.forEach(function(t){running+=t.pnl;if(running>peak)peak=running;var dd=peak-running;if(dd>maxDD)maxDD=dd});
 
 var h='<div class="lb"><div class="lt">Estat√≠sticas de Performance</div>';
 h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:8px">';
 h+='<div class="bt-stat"><div class="bsl">Trades</div><div class="bsv">'+tradeHistory.length+'</div></div>';
 h+='<div class="bt-stat"><div class="bsl">Win Rate</div><div class="bsv" style="color:'+(wins.length/tradeHistory.length>.5?'var(--g)':'var(--am)')+'">'+Math.round(wins.length/tradeHistory.length*100)+'%</div></div>';
 h+='<div class="bt-stat"><div class="bsl">P&L Total</div><div class="bsv" style="color:'+(totalPnl>=0?'var(--g)':'var(--r)')+'">'+(totalPnl>=0?'+':'')+totalPnl.toFixed(2)+'</div></div>';
 h+='<div class="bt-stat"><div class="bsl">Avg Win</div><div class="bsv" style="color:var(--g)">+'+avgWin.toFixed(2)+'</div></div>';
 h+='<div class="bt-stat"><div class="bsl">Avg Loss</div><div class="bsv" style="color:var(--r)">-'+avgLoss.toFixed(2)+'</div></div>';
 h+='<div class="bt-stat"><div class="bsl">Profit Factor</div><div class="bsv" style="color:'+(pf>=1.3?'var(--g)':pf>=1?'var(--am)':'var(--r)')+'">'+pf.toFixed(2)+'</div></div>';
 h+='<div class="bt-stat"><div class="bsl">Max Drawdown</div><div class="bsv" style="color:var(--r)">‚Ç¨'+maxDD.toFixed(2)+'</div></div>';
 h+='</div></div>';
 document.getElementById('vst').innerHTML=h
}

// ‚ïê‚ïê‚ïê BACKTESTING ENGINE ‚ïê‚ïê‚ïê
function setBtPeriod(y,btn){
 btPeriod=y;
 document.querySelectorAll('.bt-btn').forEach(function(b){b.classList.remove('on')});
 btn.classList.add('on');
}

async function runBacktest(){
 var info=getI(sel);
 document.getElementById('btResults').innerHTML='<div style="text-align:center;padding:20px"><div class="spinner"></div> A carregar '+btPeriod+' anos de dados para '+info.n+'...</div>';
 
 var candles=await getCandlesLong(sel,btPeriod);
 if(!candles||candles.length<60){document.getElementById('btResults').innerHTML='<div style="color:var(--r);font-size:11px;padding:10px">Dados insuficientes para backtest.</div>';return}
 
 var s20=_SMA(candles,20),s50=_SMA(candles,50),rsi=_RSI(candles),macd=_MACD(candles),
  boll=_BOLL(candles),atr=_ATR(candles),adx=_ADX(candles);
 var sigs=_SIGS(candles,rsi,macd,boll,s20,s50,atr,adx,tradeMode);
 
 // Simulate trades
 var trades=[],inTrade=null;
 for(var i=0;i<sigs.length;i++){
  var sig=sigs[i];
  if(!inTrade){
   if(tradeMode==='stock'&&sig.type==='SELL')continue;
   inTrade={entry:sig.price,type:sig.type,date:sig.date,sl:sig.sl,tp:sig.tp,idx:sig.idx};
  }else{
   // Check SL/TP on subsequent candles
   var closed=false;
   for(var j=inTrade.idx+1;j<=Math.min(sig.idx,candles.length-1);j++){
    if(inTrade.sl!=null){
     if(inTrade.type==='BUY'&&candles[j].low<=inTrade.sl){trades.push({entry:inTrade.entry,exit:inTrade.sl,type:inTrade.type,date:inTrade.date,exitDate:candles[j].date,reason:'SL'});inTrade=null;closed=true;break}
     if(inTrade.type==='SELL'&&candles[j].high>=inTrade.sl){trades.push({entry:inTrade.entry,exit:inTrade.sl,type:inTrade.type,date:inTrade.date,exitDate:candles[j].date,reason:'SL'});inTrade=null;closed=true;break}
    }
    if(inTrade&&inTrade.tp!=null){
     if(inTrade.type==='BUY'&&candles[j].high>=inTrade.tp){trades.push({entry:inTrade.entry,exit:inTrade.tp,type:inTrade.type,date:inTrade.date,exitDate:candles[j].date,reason:'TP'});inTrade=null;closed=true;break}
     if(inTrade.type==='SELL'&&candles[j].low<=inTrade.tp){trades.push({entry:inTrade.entry,exit:inTrade.tp,type:inTrade.type,date:inTrade.date,exitDate:candles[j].date,reason:'TP'});inTrade=null;closed=true;break}
    }
   }
   if(!closed&&sig.type!==inTrade.type){
    trades.push({entry:inTrade.entry,exit:sig.price,type:inTrade.type,date:inTrade.date,exitDate:sig.date,reason:'Reverso'});
    inTrade={entry:sig.price,type:sig.type,date:sig.date,sl:sig.sl,tp:sig.tp,idx:sig.idx};
   }
  }
 }
 // Close last trade
 if(inTrade){trades.push({entry:inTrade.entry,exit:candles[candles.length-1].close,type:inTrade.type,date:inTrade.date,exitDate:candles[candles.length-1].date,reason:'Aberto'})}
 
 // Calculate stats
 trades.forEach(function(t){
  var spread=XTB_SPREADS[sel]||0;
  t.pnl=t.type==='BUY'?(t.exit-t.entry-spread):(t.entry-t.exit-spread);
  t.pnlPct=t.pnl/t.entry*100;
 });
 
 var wins=trades.filter(function(t){return t.pnl>0}),losses=trades.filter(function(t){return t.pnl<=0});
 var totalPnl=trades.reduce(function(s,t){return s+t.pnl},0);
 var totalPnlPct=trades.reduce(function(s,t){return s+t.pnlPct},0);
 var avgWin=wins.length?wins.reduce(function(s,t){return s+t.pnlPct},0)/wins.length:0;
 var avgLoss=losses.length?Math.abs(losses.reduce(function(s,t){return s+t.pnlPct},0)/losses.length):0;
 var grossWin=wins.reduce(function(s,t){return s+Math.abs(t.pnl)},0);
 var grossLoss=Math.abs(losses.reduce(function(s,t){return s+t.pnl},0));
 var pf=grossLoss>0?grossWin/grossLoss:grossWin>0?99:0;
 
 var maxDD=0,peak=0,eq=0;
 trades.forEach(function(t){eq+=t.pnlPct;if(eq>peak)peak=eq;var dd=peak-eq;if(dd>maxDD)maxDD=dd});
 
 var winRate=trades.length?Math.round(wins.length/trades.length*100):0;
 var passedPF=pf>=1.3,passedDD=maxDD<=25;
 
 var h='<div class="bt-results">';
 h+='<div class="bt-stat"><div class="bsl">Trades</div><div class="bsv">'+trades.length+'</div></div>';
 h+='<div class="bt-stat"><div class="bsl">Win Rate</div><div class="bsv" style="color:'+(winRate>50?'var(--g)':'var(--am)')+'">'+winRate+'%</div></div>';
 h+='<div class="bt-stat"><div class="bsl">P&L Total</div><div class="bsv" style="color:'+(totalPnlPct>=0?'var(--g)':'var(--r)')+'">'+(totalPnlPct>=0?'+':'')+totalPnlPct.toFixed(1)+'%</div></div>';
 h+='<div class="bt-stat"><div class="bsl">Profit Factor</div><div class="bsv" style="color:'+(passedPF?'var(--g)':'var(--r)')+'">'+pf.toFixed(2)+(passedPF?' ‚úì':' ‚úó')+'</div></div>';
 h+='<div class="bt-stat"><div class="bsl">Max Drawdown</div><div class="bsv" style="color:'+(passedDD?'var(--g)':'var(--r)')+'">'+maxDD.toFixed(1)+'%'+(passedDD?' ‚úì':' ‚úó')+'</div></div>';
 h+='<div class="bt-stat"><div class="bsl">Avg Win</div><div class="bsv" style="color:var(--g)">+'+avgWin.toFixed(2)+'%</div></div>';
 h+='<div class="bt-stat"><div class="bsl">Avg Loss</div><div class="bsv" style="color:var(--r)">-'+avgLoss.toFixed(2)+'%</div></div>';
 h+='<div class="bt-stat"><div class="bsl">Per√≠odo</div><div class="bsv" style="color:var(--cy)">'+candles.length+'d</div></div>';
 h+='</div>';
 
 // Validation
 h+='<div style="margin-top:12px;padding:10px;border-radius:8px;border:1px solid '+(passedPF&&passedDD?'rgba(16,185,129,.3);background:rgba(16,185,129,.05)':'rgba(239,68,68,.3);background:rgba(239,68,68,.05)')+';font-size:11px">';
 if(passedPF&&passedDD)h+='‚úÖ <strong>Estrat√©gia validada</strong> ‚Äî PF ‚â• 1.3 e Drawdown ‚â§ 25%';
 else{h+='‚ùå <strong>Estrat√©gia N√ÉO validada</strong> ‚Äî ';if(!passedPF)h+='PF '+pf.toFixed(2)+' < 1.3. ';if(!passedDD)h+='DD '+maxDD.toFixed(1)+'% > 25%.';}
 h+='</div>';
 
 // Trade list
 if(trades.length){
  h+='<div class="bt-trades" style="margin-top:10px"><div style="font-size:8px;color:var(--t3);text-transform:uppercase;margin-bottom:4px">√öltimos trades</div>';
  trades.slice(-20).reverse().forEach(function(t){
   h+='<div class="bt-trade"><div><span style="color:'+(t.type==='BUY'?'var(--g)':'var(--r)')+'">'+t.type+'</span> '+t.date+'</div>';
   h+='<div style="color:'+(t.pnl>=0?'var(--g)':'var(--r)')+'">'+(t.pnl>=0?'+':'')+t.pnlPct.toFixed(2)+'% ('+t.reason+')</div></div>'
  });
  h+='</div>';
 }
 document.getElementById('btResults').innerHTML=h
}

// ‚ïê‚ïê‚ïê CSV EXPORT ‚ïê‚ïê‚ïê
function exportCSV(){
 if(!lastCandles){toast('‚ö†Ô∏è','Carrega dados primeiro');return}
 var lines=['Data,Open,High,Low,Close,Volume,RSI,SMA20,SMA50,ADX,ATR'];
 var ind=lastIndicators;
 lastCandles.forEach(function(c,i){
  lines.push([c.date,c.open,c.high,c.low,c.close,c.volume,ind.rsi[i]!=null?ind.rsi[i].toFixed(2):'',ind.s20[i]!=null?ind.s20[i].toFixed(2):'',ind.s50[i]!=null?ind.s50[i].toFixed(2):'',ind.adx[i]!=null?ind.adx[i]:'',ind.atr[i]!=null?ind.atr[i].toFixed(4):''].join(','))
 });
 // Add trade history
 if(tradeHistory.length){
  lines.push('');lines.push('--- TRADE HISTORY ---');
  lines.push('Symbol,Type,Units,Entry,Exit,EntryDate,ExitDate,PnL');
  tradeHistory.forEach(function(t){lines.push([t.symbol,t.type,t.units,t.entry,t.exit,t.entryDate,t.exitDate,t.pnl].join(','))})
 }
 var blob=new Blob([lines.join('\n')],{type:'text/csv'});
 var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='CFD_'+sel+'_'+new Date().toISOString().split('T')[0]+'.csv';a.click();
 toast('üì• CSV exportado',sel+' ‚Äî '+lastCandles.length+' velas')
}

// ‚ïê‚ïê‚ïê ACTION SUMMARY ‚ïê‚ïê‚ïê
function genAction(info,lp,dp,sigs,sr,fib,atr,dailyTF,weeklyTF){
 var lastSig=sigs.length?sigs[sigs.length-1]:null;
 var lATR=null;for(var i=atr.length-1;i>=0;i--){if(atr[i]!=null){lATR=atr[i];break}}
 var tfHTML='<span class="tf-label">Timeframes:</span>';
 [dailyTF,weeklyTF].forEach(function(tf){if(!tf)return;
  var c=tf.bias==='Bullish'?'var(--g)':tf.bias==='Bearish'?'var(--r)':'var(--t3)';
  var bg=tf.bias==='Bullish'?'rgba(16,185,129,.08)':tf.bias==='Bearish'?'rgba(239,68,68,.08)':'rgba(71,85,105,.08)';
  tfHTML+='<span class="tf-badge" style="color:'+c+';background:'+bg+'">'+tf.label+': '+tf.bias+'</span>'
 });
 tfHTML+='<span class="tf-badge" style="color:var(--pu);background:rgba(167,139,250,.08)">Modo: '+(tradeMode==='stock'?'A√ß√µes (Long)':'CFDs (Bi)')+'</span>';
 document.getElementById('tfRow').innerHTML=tfHTML;
 
 var aligned=dailyTF&&weeklyTF&&dailyTF.bias===weeklyTF.bias&&dailyTF.bias!=='Neutro';
 var conflicting=dailyTF&&weeklyTF&&((dailyTF.bias==='Bullish'&&weeklyTF.bias==='Bearish')||(dailyTF.bias==='Bearish'&&weeklyTF.bias==='Bullish'));
 var title='',text='',emoji='üìã',slP=null,tpP=null,tp2P=null;
 var recent=lastSig&&sigs.length>=5&&lastSig.idx>=sigs[sigs.length-5].idx;
 
 if(recent){
  var isBuy=lastSig.type==='BUY';emoji=isBuy?'üü¢':'üî¥';title=(isBuy?'COMPRA':'VENDA')+' ‚Äî '+info.n;
  slP=lastSig.sl;tpP=lastSig.tp;tp2P=lastSig.tp2;
  text='<strong>Sinal de '+(isBuy?'compra':'venda')+'</strong> a <strong>'+lastSig.price.toFixed(dp)+'</strong> ¬∑ For√ßa '+lastSig.str+'/8 ¬∑ '+lastSig.conf+'% confirma√ß√£o.';
  text+='<br><br><strong>Raz√µes:</strong> '+lastSig.reasons.join(', ')+'.';
  if(aligned)text+='<br><br>‚úÖ <strong>Timeframes alinhados</strong> ‚Äî sinal refor√ßado.';
  else if(conflicting)text+='<br><br>‚ö†Ô∏è <strong>Conflito de timeframes</strong> ‚Äî reduzir posi√ß√£o ou aguardar.';
  if(tradeMode==='stock'&&!isBuy)text+='<br><br>‚ö†Ô∏è Modo A√ß√µes: Apenas sinais de compra.';
  if(lATR){text+='<br><br><strong>Gest√£o:</strong> SL 1.5√óATR | TP1 2√óATR | TP2 3√óATR';
   var rr=tpP&&slP?Math.abs(tpP-lastSig.price)/Math.abs(slP-lastSig.price):0;
   if(rr>0)text+=' | R:R '+rr.toFixed(1)+':1';
  }
  if(checkDailyLimit())text+='<br><br>üö® <strong>LIMITE DI√ÅRIO ATINGIDO</strong> ‚Äî N√£o abrir novas posi√ß√µes!';
  if(checkMaxPositions())text+='<br><br>‚ö†Ô∏è M√°x posi√ß√µes abertas atingido.';
 }else{
  title='AGUARDAR ‚Äî '+info.n;emoji='‚è≥';
  text='Sem sinal claro. ';
  if(dailyTF)text+='Di√°rio: <strong>'+dailyTF.bias+'</strong>. ';
  if(weeklyTF)text+='Semanal: <strong>'+weeklyTF.bias+'</strong>. ';
  var distSup=((lp-sr.suporte)/lp*100).toFixed(1);
  var distRes=((sr.resistencia-lp)/lp*100).toFixed(1);
  if(parseFloat(distSup)<2)text+='<br><br>üìç Pr√≥ximo suporte ('+distSup+'%) ‚Äî potencial zona de compra.';
  else if(parseFloat(distRes)<2)text+='<br><br>üìç Pr√≥ximo resist√™ncia ('+distRes+'%) ‚Äî potencial zona de venda.';
  else text+='<br><br>Entre suporte e resist√™ncia. Aguardar confirma√ß√£o.';
 }
 document.getElementById('actTitle').innerHTML=emoji+' '+title;
 document.getElementById('actText').innerHTML=text;
 var rHTML='';
 if(slP!=null)rHTML+='<div class="risk-pill"><div class="rpl">Stop-Loss</div><div class="rpv" style="color:var(--r)">'+slP.toFixed(dp)+'</div></div>';
 if(tpP!=null)rHTML+='<div class="risk-pill"><div class="rpl">TP 1</div><div class="rpv" style="color:var(--g)">'+tpP.toFixed(dp)+'</div></div>';
 if(tp2P!=null)rHTML+='<div class="risk-pill"><div class="rpl">TP 2</div><div class="rpv" style="color:var(--g)">'+tp2P.toFixed(dp)+'</div></div>';
 if(lATR)rHTML+='<div class="risk-pill"><div class="rpl">ATR</div><div class="rpv" style="color:var(--cy)">'+lATR.toFixed(dp)+'</div></div>';
 document.getElementById('riskRow').innerHTML=rHTML;
 // Update R:R metric
 if(tpP&&slP&&lastSig){var rr=Math.abs(tpP-lastSig.price)/Math.abs(slP-lastSig.price);document.getElementById('mRR').textContent=rr.toFixed(1)+':1';document.getElementById('mRR').style.color=rr>=2?'var(--g)':rr>=1.5?'var(--am)':'var(--r)'}
}

// ‚ïê‚ïê‚ïê UI CONTROLS ‚ïê‚ïê‚ïê
function renderA(){
 var h='';for(var c in A){h+='<div class="cl">'+c+'</div><div class="ar">';A[c].forEach(function(a){h+='<button class="ab '+(a.s===sel?'on':'')+'" onclick="selA(\''+a.s.replace(/'/g,"\\'")+'\')">'+a.e+' '+a.n+'</button>'});h+='</div>'}
 document.getElementById('aGrid').innerHTML=h
}
function selA(s){sel=s;save();renderA();refresh()}
function setSts(t,m){document.getElementById('sts').innerHTML='<span class="dot '+(t==='ok'?'dok':t==='err'?'doe':'dol')+'"></span> '+m}
function getI(s){for(var c in A){var f=A[c].find(function(a){return a.s===s});if(f)return f}return{s:s,n:s,e:'üìä',c:'A√ß√µes'}}
function toast(t,b){document.getElementById('toastT').textContent=t;document.getElementById('toastB').textContent=b;document.getElementById('toast').classList.add('show');setTimeout(function(){document.getElementById('toast').classList.remove('show')},4000)}

function tgl(t){if(t==='s')shS=!shS;if(t==='b')shB=!shB;if(t==='f')shF=!shF;document.getElementById('tS').classList.toggle('on',shS);document.getElementById('tB').classList.toggle('on',shB);document.getElementById('tF').classList.toggle('on',shF);if(lastCandles)drawAll()}
function stab(id,btn){document.querySelectorAll('.tt').forEach(function(t){t.classList.remove('on')});btn.classList.add('on');['vc','vs','vl','vbt','vst','vh'].forEach(function(v){document.getElementById(v).style.display='none'});document.getElementById('v'+id).style.display='block';if(id==='st')renderStats();if(id==='h')renderHist()}
function togAuto(){aR=!aR;var b=document.getElementById('abtn');if(aR){b.classList.add('on');b.textContent='‚è∏ 30s';aI=setInterval(refresh,30000)}else{b.classList.remove('on');b.textContent='‚ñ∂ Auto';clearInterval(aI)}}
async function togNotif(){if(!nO){if('Notification'in window){var p=await Notification.requestPermission();if(p==='granted'){nO=true;toast('üîî Alertas ON','Sinais + SL/TP');document.getElementById('nbtn').classList.add('no')}else toast('‚ö†Ô∏è','Permite nas defini√ß√µes')}else toast('‚ö†Ô∏è','N√£o suportado')}else{nO=false;document.getElementById('nbtn').classList.remove('no');toast('üîï Alertas OFF','')}}

function opMo(){var ex=[];for(var c in A)A[c].forEach(function(a){ex.push(a.s)});var av=PRE.filter(function(p){return ex.indexOf(p.s)<0});var cats=[];av.forEach(function(p){if(cats.indexOf(p.c)<0)cats.push(p.c)});var h='';cats.forEach(function(c){h+='<div style="font-size:8px;color:var(--t3);margin-bottom:4px;text-transform:uppercase">'+c+'</div><div class="pg">';av.filter(function(p){return p.c===c}).forEach(function(p){h+='<button class="ab" onclick="addP(\''+p.s.replace(/'/g,"\\'")+'\',\''+p.n+'\',\''+p.e+'\',\''+p.c+'\')">'+p.e+' '+p.n+'</button>'});h+='</div>'});document.getElementById('pList').innerHTML=h;document.getElementById('modal').classList.add('on')}
function clMo(){document.getElementById('modal').classList.remove('on')}
function addP(s,n,e,c){if(!A[c])A[c]=[];if(A[c].find(function(a){return a.s===s}))return;A[c].push({s:s,n:n,e:e,c:c});save();renderA();clMo()}
function addC(){var s=document.getElementById('cS').value.trim().toUpperCase(),n=document.getElementById('cN').value.trim(),c=document.getElementById('cC').value;if(!s||!n)return;if(!A[c])A[c]=[];A[c].push({s:s,n:n,e:'üìä',c:c});save();renderA();clMo();document.getElementById('cS').value='';document.getElementById('cN').value=''}

// ‚ïê‚ïê‚ïê MAIN REFRESH ‚ïê‚ïê‚ïê
async function refresh(){
 var info=getI(sel);setSts('load',info.n+'...');
 document.getElementById('pN').textContent=info.e+' '+info.n;document.getElementById('pP').textContent='...';
 
 // Market status
 var ms=getMarketStatus(sel);
 document.getElementById('marketStatus').innerHTML='<div style="display:flex;align-items:center;gap:5px;font-size:9px;color:var(--t3)"><span class="dot '+ms.cls+'"></span>'+ms.label+'</div>';
 
 var candles=await getCandles(sel,250);
 if(!candles||candles.length<30){setSts('err','Sem dados para '+info.s);return}
 lastCandles=candles;
 
 var weekly=await getWeekly(sel);lastWeekly=weekly;
 
 var s20=_SMA(candles,20),s50=_SMA(candles,50),rsi=_RSI(candles),macd=_MACD(candles),
  boll=_BOLL(candles),fib=_FIB(candles),sr=_SR(candles),atr=_ATR(candles),adx=_ADX(candles);
 lastIndicators={s20:s20,s50:s50,rsi:rsi,macd:macd,boll:boll,fib:fib,sr:sr,atr:atr,adx:adx};
 
 var sigs=_SIGS(candles,rsi,macd,boll,s20,s50,atr,adx,tradeMode);
 var dailyTF=analyzeTF(candles,'Di√°rio'),weeklyTF=weekly?analyzeTF(weekly,'Semanal'):null;
 
 var last=candles[candles.length-1],prev=candles[candles.length-2];
 var lp=last.close,ch=lp-prev.close,chP=(ch/prev.close)*100;
 curDP=lp>100?2:lp>1?3:lp>.01?5:6;curPrice=lp;
 
 document.getElementById('pP').textContent=lp.toFixed(curDP);
 var ce=document.getElementById('pC');ce.textContent=(ch>=0?'‚ñ≤':'‚ñº')+' '+Math.abs(ch).toFixed(curDP)+' ('+(chP>=0?'+':'')+chP.toFixed(2)+'%)';ce.style.color=ch>=0?'var(--g)':'var(--r)';
 
 var lR=null;for(var i=rsi.length-1;i>=0;i--){if(rsi[i]!=null){lR=rsi[i];break}}
 var lADX=null;for(var i=adx.length-1;i>=0;i--){if(adx[i]!=null){lADX=adx[i];break}}
 var lATR=null;for(var i=atr.length-1;i>=0;i--){if(atr[i]!=null){lATR=atr[i];break}}
 
 document.getElementById('mR').textContent=lR?lR.toFixed(1):'‚Äî';document.getElementById('mR').style.color=lR>70?'var(--r)':lR<30?'var(--g)':'var(--t)';
 document.getElementById('mADX').textContent=lADX?lADX:'‚Äî';document.getElementById('mADX').style.color=lADX>25?'var(--g)':lADX<15?'var(--r)':'var(--t2)';
 document.getElementById('mATR').textContent=lATR?lATR.toFixed(curDP>3?4:2):'‚Äî';
 
 var lastSig=sigs.length?sigs[sigs.length-1]:null;
 var r5=sigs.slice(-5),score=r5.reduce(function(s,g){return s+(g.type==="BUY"?g.str:-g.str)},0);
 var rec=score>3?"COMPRA FORTE":score>0?"COMPRA":score<-3?"VENDA FORTE":score<0?"VENDA":"AGUARDAR";
 if(tradeMode==='stock'&&score<0)rec="AGUARDAR";
 var rc=score>3?'var(--g)':score>0?'#34d399':score<-3?'var(--r)':score<0?'#f87171':'var(--t3)';
 if(tradeMode==='stock'&&score<0)rc='var(--t3)';
 document.getElementById('rB').style.background=score>0?'rgba(16,185,129,.08)':score<0&&tradeMode==='cfd'?'rgba(239,68,68,.08)':'var(--bg2)';
 document.getElementById('rV').textContent=rec;document.getElementById('rV').style.color=rc;
 
 genAction(info,lp,curDP,sigs,sr,fib,atr,dailyTF,weeklyTF);
 renderPos();checkPositionAlerts(lp);renderHist();
 
 if(nO&&lastSig&&lastSig.str>=5&&lastSig.date!==prevSig[sel]){
  try{new Notification((lastSig.type==='BUY'?'üü¢ COMPRA':'üî¥ VENDA')+' ‚Äî '+info.n,{body:lastSig.reasons.slice(0,3).join(', ')})}catch(e){}
  toast((lastSig.type==='BUY'?'üü¢':'üî¥')+' '+info.n,lastSig.reasons.slice(0,2).join(', '));prevSig[sel]=lastSig.date
 }
 drawAll();
 rSigs(sigs,curDP);rLev(sr,fib,lp,curDP);
 setSts('ok',info.n+' ¬∑ '+candles.length+'D'+(weekly?' +'+weekly.length+'W':'')+' ¬∑ '+new Date().toLocaleTimeString('pt',{hour:'2-digit',minute:'2-digit'}))
}

function drawAll(){
 if(!lastCandles||!lastIndicators)return;
 var ind=lastIndicators;
 drawP(lastCandles,ind.s20,ind.s50,ind.boll,_SIGS(lastCandles,ind.rsi,ind.macd,ind.boll,ind.s20,ind.s50,ind.atr,ind.adx,tradeMode),ind.fib);
 drawR(ind.rsi);drawM(ind.macd)
}

// ‚ïê‚ïê‚ïê SVG HELPERS ‚ïê‚ïê‚ïê
function $(t,a){a=a||{};var e=document.createElementNS('http://www.w3.org/2000/svg',t);for(var k in a)e.setAttribute(k,a[k]);return e}
function $t(x,y,txt,fill,sz){var t=$('text',{x:x,y:y,fill:fill,'font-size':sz||8,'font-family':'monospace'});t.textContent=txt;return t}

function drawP(d,s20,s50,boll,sigs,fib){
 var W=800,H=280,P={t:12,r:48,b:22,l:5},n=Math.min(60,d.length),vis=d.slice(-n),off=d.length-n;
 var av=[];vis.forEach(function(v){av.push(v.high,v.low)});if(shB)boll.slice(-n).forEach(function(b){if(b.u!=null){av.push(b.u,b.l)}});
 var yN=Math.min.apply(null,av)*.998,yX=Math.max.apply(null,av)*1.002;
 var x=function(i){return P.l+(i/(vis.length-1))*(W-P.l-P.r)};var y=function(v){return P.t+(1-(v-yN)/(yX-yN))*(H-P.t-P.b)};
 var cw=Math.max(2,(W-P.l-P.r)/vis.length*.55);var svg=$('svg',{viewBox:'0 0 '+W+' '+H});svg.appendChild($('rect',{width:W,height:H,fill:'#0a0e17',rx:8}));
 for(var i=0;i<5;i++){var yy=P.t+(i/4)*(H-P.t-P.b),val=yX-(i/4)*(yX-yN);svg.appendChild($('line',{x1:P.l,x2:W-P.r,y1:yy,y2:yy,stroke:'#151d2e'}));svg.appendChild($t(W-P.r+3,yy+3,val.toFixed(2),'#3a4563',7))}
 if(shB){var bs=boll.slice(-n),up='',lo='',rv=[];bs.forEach(function(b,i){if(b.u!=null){up+=x(i)+','+y(b.u)+' ';lo+=x(i)+','+y(b.l)+' ';rv.push(x(i)+','+y(b.l))}});svg.appendChild($('polygon',{points:up+rv.reverse().join(' '),fill:'rgba(99,102,241,.05)'}));svg.appendChild($('polyline',{points:up,fill:'none',stroke:'rgba(99,102,241,.28)','stroke-width':.8,'stroke-dasharray':'3,3'}));svg.appendChild($('polyline',{points:lo,fill:'none',stroke:'rgba(99,102,241,.28)','stroke-width':.8,'stroke-dasharray':'3,3'}))}
 if(shF){for(var lb in fib){var val=fib[lb];if(val<yN||val>yX)continue;svg.appendChild($('line',{x1:P.l,x2:W-P.r,y1:y(val),y2:y(val),stroke:'rgba(245,158,11,.18)','stroke-dasharray':'4,4'}));svg.appendChild($t(P.l+2,y(val)-2,lb,'rgba(245,158,11,.4)',6))}}
 vis.forEach(function(v,i){var g=v.close>=v.open,c=g?'#10b981':'#ef4444';svg.appendChild($('line',{x1:x(i),x2:x(i),y1:y(v.high),y2:y(v.low),stroke:c}));svg.appendChild($('rect',{x:x(i)-cw/2,y:y(Math.max(v.open,v.close)),width:cw,height:Math.max(.8,y(Math.min(v.open,v.close))-y(Math.max(v.open,v.close))),fill:c,rx:.5}))});
 if(shS){[{a:s20.slice(-n),c:'#f59e0b'},{a:s50.slice(-n),c:'#06b6d4'}].forEach(function(o){var p='';o.a.forEach(function(v,i){if(v!=null)p+=x(i)+','+y(v)+' '});svg.appendChild($('polyline',{points:p,fill:'none',stroke:o.c,'stroke-width':1.2}))})}
 sigs.filter(function(s){return s.idx>=off}).forEach(function(s){var i=s.idx-off,xx=x(i),yy=s.type==='BUY'?y(vis[i].low)+8:y(vis[i].high)-8;svg.appendChild($('polygon',{points:s.type==='BUY'?xx+','+(yy-7)+' '+(xx-4)+','+yy+' '+(xx+4)+','+yy:xx+','+(yy+7)+' '+(xx-4)+','+yy+' '+(xx+4)+','+yy,fill:s.type==='BUY'?'#10b981':'#ef4444',opacity:'.8'}))});
 positions.filter(function(p){return p.symbol===sel&&!p.closed}).forEach(function(pos){
  if(pos.entryPrice>=yN&&pos.entryPrice<=yX){svg.appendChild($('line',{x1:P.l,x2:W-P.r,y1:y(pos.entryPrice),y2:y(pos.entryPrice),stroke:'#6366f1','stroke-width':1,'stroke-dasharray':'6,3'}));svg.appendChild($t(P.l+2,y(pos.entryPrice)-3,'ENTRY '+pos.entryPrice.toFixed(2),'#6366f1',6))}
  if(pos.sl!=null&&pos.sl>=yN&&pos.sl<=yX){svg.appendChild($('line',{x1:P.l,x2:W-P.r,y1:y(pos.sl),y2:y(pos.sl),stroke:'#ef4444','stroke-width':1,'stroke-dasharray':'4,4'}));svg.appendChild($t(P.l+2,y(pos.sl)-3,'SL '+pos.sl.toFixed(2),'#ef4444',6))}
  if(pos.tp!=null&&pos.tp>=yN&&pos.tp<=yX){svg.appendChild($('line',{x1:P.l,x2:W-P.r,y1:y(pos.tp),y2:y(pos.tp),stroke:'#10b981','stroke-width':1,'stroke-dasharray':'4,4'}));svg.appendChild($t(P.l+2,y(pos.tp)-3,'TP '+pos.tp.toFixed(2),'#10b981',6))}
 });
 vis.forEach(function(v,i){if(i%12===0)svg.appendChild($t(x(i),H-4,v.date.slice(5),'#3a4563',7))});
 document.getElementById('mC').innerHTML='';document.getElementById('mC').appendChild(svg)
}

function drawR(rsi){var W=800,H=70,vis=rsi.slice(-60);var x=function(i){return 5+(i/(vis.length-1))*(W-52)};var y=function(v){return 5+(1-v/100)*60};var svg=$('svg',{viewBox:'0 0 '+W+' '+H});svg.appendChild($('rect',{width:W,height:H,fill:'#0a0e17',rx:7}));svg.appendChild($('rect',{x:5,y:y(70),width:W-52,height:y(30)-y(70),fill:'rgba(99,102,241,.03)'}));svg.appendChild($('line',{x1:5,x2:W-47,y1:y(70),y2:y(70),stroke:'rgba(239,68,68,.18)','stroke-dasharray':'3,3'}));svg.appendChild($('line',{x1:5,x2:W-47,y1:y(30),y2:y(30),stroke:'rgba(16,185,129,.18)','stroke-dasharray':'3,3'}));svg.appendChild($t(W-44,y(70)+3,'70','#ef4444',6));svg.appendChild($t(W-44,y(30)+3,'30','#10b981',6));var pts='';vis.forEach(function(v,i){if(v!=null)pts+=x(i)+','+y(v)+' '});svg.appendChild($('polyline',{points:pts,fill:'none',stroke:'#a78bfa','stroke-width':1.3}));document.getElementById('rC').innerHTML='';document.getElementById('rC').appendChild(svg)}

function drawM(macd){var W=800,H=70,vis={m:macd.ml.slice(-60),s:macd.sl.slice(-60),h:macd.h.slice(-60)};var all=vis.m.concat(vis.s,vis.h).filter(function(v){return v!=null});if(!all.length)return;var am=Math.max(Math.abs(Math.min.apply(null,all)),Math.abs(Math.max.apply(null,all)))||1;var x=function(i){return 5+(i/(vis.m.length-1))*(W-52)};var y=function(v){return 35-(v/am)*28};var bw=Math.max(1.5,(W-52)/vis.h.length*.5);var svg=$('svg',{viewBox:'0 0 '+W+' '+H});svg.appendChild($('rect',{width:W,height:H,fill:'#0a0e17',rx:7}));svg.appendChild($('line',{x1:5,x2:W-47,y1:35,y2:35,stroke:'#151d2e'}));vis.h.forEach(function(v,i){if(v!=null)svg.appendChild($('rect',{x:x(i)-bw/2,y:v>=0?y(v):35,width:bw,height:Math.abs(y(v)-35),fill:v>=0?'rgba(16,185,129,.35)':'rgba(239,68,68,.35)',rx:.5}))});var mp='',sp='';vis.m.forEach(function(v,i){if(v!=null)mp+=x(i)+','+y(v)+' '});vis.s.forEach(function(v,i){if(v!=null)sp+=x(i)+','+y(v)+' '});svg.appendChild($('polyline',{points:mp,fill:'none',stroke:'#818cf8','stroke-width':1.3}));svg.appendChild($('polyline',{points:sp,fill:'none',stroke:'#f97316','stroke-width':1.3}));document.getElementById('maC').innerHTML='';document.getElementById('maC').appendChild(svg)}

function rSigs(sigs,dp){var h='<div style="font-size:8px;color:var(--t3);margin-bottom:7px;text-transform:uppercase">'+sigs.length+' sinais ¬∑ Modo: '+(tradeMode==='stock'?'A√ß√µes':'CFDs')+'</div>';
 sigs.slice(-12).reverse().forEach(function(s){var b=s.type==='BUY',c=b?'var(--g)':'var(--r)',bg=b?'rgba(16,185,129,.08)':'rgba(239,68,68,.08)';
  h+='<div class="sg" style="border-left:2px solid '+c+'"><div class="sh"><div style="display:flex;align-items:center;gap:6px"><span class="st" style="background:'+bg+';color:'+c+'">'+(b?'‚ñ≤ COMPRA':'‚ñº VENDA')+'</span><span style="font-size:10px;color:var(--t2)">'+s.price.toFixed(dp)+'</span><span style="font-size:8px;color:var(--pu)">'+s.conf+'%</span></div><span style="font-size:8px;color:var(--t3)">'+s.date+'</span></div>';
  h+='<div class="sd">';for(var j=0;j<8;j++)h+='<span class="sdd" style="background:'+(j<s.str?c:'var(--bd)')+'"></span>';h+='</div>';
  if(s.sl!=null)h+='<div style="font-size:8px;margin-top:3px;color:var(--t3)">SL: <span style="color:var(--r)">'+s.sl.toFixed(dp)+'</span> ¬∑ TP1: <span style="color:var(--g)">'+s.tp.toFixed(dp)+'</span></div>';
  h+='<div class="sr">'+s.reasons.join(' ¬∑ ')+'</div></div>'
 });document.getElementById('vs').innerHTML=h
}

function rLev(sr,fib,lp,dp){var h='<div class="lg"><div class="lb"><div class="lt">Suporte & Resist√™ncia</div>';
 var keys=['suporteForte','suporte','resistencia','resistenciaForte'];
 var labels={suporteForte:'Suporte Forte',suporte:'Suporte',resistencia:'Resist√™ncia',resistenciaForte:'Resist√™ncia Forte'};
 keys.forEach(function(k){var sup=k.indexOf('suporte')>=0;h+='<div class="lr"><span style="color:var(--t2)">'+labels[k]+'</span><span style="font-weight:600;color:'+(sup?'var(--g)':'var(--r)')+'">'+sr[k].toFixed(dp)+'</span></div>'});
 h+='<div style="margin-top:7px;padding:6px 9px;background:rgba(99,102,241,.06);border-radius:6px;font-size:8px;color:var(--pu)">Pre√ßo: <b>'+lp.toFixed(dp)+'</b></div></div>';
 h+='<div class="lb"><div class="lt">Fibonacci (60d)</div>';for(var l in fib)h+='<div class="lr"><span style="color:var(--am)">'+l+'</span><span style="font-weight:600">'+fib[l].toFixed(dp)+'</span></div>';
 h+='</div></div>';document.getElementById('vl').innerHTML=h
}

// PWA
if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(function(){});
</script>

</body>
</html>